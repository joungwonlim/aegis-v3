# AEGIS Brain - Simple Architecture

> **Simple is Best** - 핵심만 담은 의사결정 시스템

---

## 1. 전체 의사결정 흐름

### 1.1 매수 결정 플로우

```
┌─────────────────────────────────────────────────────────────────┐
│                      매수 의사결정 흐름                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐                                                │
│  │  Screener   │  종목 필터링 (시총, 거래량, 재무)                │
│  │   통과?      │                                                │
│  └──────┬──────┘                                                │
│         │ YES                                                   │
│         ▼                                                       │
│  ┌─────────────┐                                                │
│  │ Quant Score │  수급/기술 분석 → 60~90점                       │
│  │   계산       │  (외국인+기관+거래량+MA+연속매수-오버행)          │
│  └──────┬──────┘                                                │
│         │                                                       │
│         ▼                                                       │
│  ┌───────────────────┐                                                │
│  │ gemini-2.0-flash  │  맥락 분석 → 0~100점                           │
│  │  Score            │  (뉴스/공시/섹터/매크로)                         │
│  └──────┬────────────┘                                                │
│         │                                                       │
│         ▼                                                       │
│  ┌─────────────────────────────────┐                            │
│  │  Final = Quant×57% + DeepSeek-V3×43%  │                      │
│  └──────────────┬──────────────────┘                            │
│                 │                                               │
│                 ▼                                               │
│          ┌────────────┐                                         │
│          │ 70점 이상?   │                                         │
│          └─────┬──────┘                                         │
│                │                                                │
│       ┌────────┴────────┐                                       │
│       ▼                 ▼                                       │
│     [YES]             [NO]                                      │
│       │                 │                                       │
│       ▼                 ▼                                       │
│  ┌─────────┐      ┌─────────┐                                   │
│  │ Safety  │      │  HOLD   │                                   │
│  │ Check   │      │ (보류)  │                                   │
│  └────┬────┘      └─────────┘                                   │
│       │                                                         │
│       ▼                                                         │
│  □ 보유 종목 < 5개?                                             │
│  □ 일일 거래 < 4회?                                             │
│  □ 금요일 14:30 이전?                                           │
│  □ 계좌 손실 < -2%?                                             │
│  □ 종목 비중 < 10%?                                             │
│       │                                                         │
│       ▼                                                         │
│  ┌──────────┐     ┌──────────┐                                  │
│  │ 모두 YES │────▶│   BUY    │                                  │
│  └──────────┘     └──────────┘                                  │
│       │                                                         │
│  ┌──────────┐     ┌──────────┐                                  │
│  │ 하나 NO  │────▶│   HOLD   │                                  │
│  └──────────┘     └──────────┘                                  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 매도 결정 플로우

```
┌─────────────────────────────────────────────────────────────────┐
│                      매도 의사결정 흐름                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐                                                │
│  │  보유 종목  │                                                │
│  │  수익률 체크│                                                │
│  └──────┬──────┘                                                │
│         │                                                       │
│         ▼                                                       │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    수익률 분기                           │    │
│  └─────────────────────────────────────────────────────────┘    │
│         │                                                       │
│    ┌────┼────┬────────┬────────┐                                │
│    ▼    ▼    ▼        ▼        ▼                                │
│  ≤-2%  +3.5% +5%    +5.5%   +8% 이상                            │
│    │    │    │        │        │                                │
│    ▼    ▼    ▼        ▼        ▼                                │
│ ┌─────┐┌────┐┌───────┐┌─────┐┌────────┐                         │
│ │손절  ││분할 ││트레일   ││익절   ││강화    │                         │
│ │전량  ││50% ││링 ON  ││전량   ││트레일링│                         │
│ │매도  ││매도 ││       ││매도   ││       │                         │
│ └─────┘└────┘└───┬───┘└─────┘└────────┘                         │
│                  │                                              │
│                  ▼                                              │
│         ┌────────────────┐                                      │
│         │ 고점 추적 중   │                                      │
│         │ 손절가 = 고점-2%│                                      │
│         └───────┬────────┘                                      │
│                 │                                               │
│                 ▼                                               │
│         ┌────────────────┐     ┌─────────┐                      │
│         │현재가 ≤ 손절가?│─YES─▶│  SELL   │                      │
│         └───────┬────────┘     └─────────┘                      │
│                 │ NO                                            │
│                 ▼                                               │
│         ┌────────────────┐                                      │
│         │  계속 추적     │                                      │
│         └────────────────┘                                      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 1.3 트레일링 스탑 시각화

```
가격
 │
 │                        ★ 고점 11,000원
 │                       /│
 │                      / │
 │                     /  │ ← 손절가 10,780원 (고점-2%)
 │         ┌─────────/   │........................
 │         │트레일링 ON   │                      :
 │         │(+5% 도달)    │    ↘                 :
 │    ─────┤             │      ↘ 하락          :
 │ 10,500원│             │        ↘             :
 │         │             │          ● 10,750원  :
 │         │             │            (손절가 하회)
 │         │             │              ↓       :
 │         │             │           [SELL]     :
 │─────────┴─────────────┴──────────────────────┴────▶ 시간
 │ 매수
 │ 10,000원
```

---

## 2. 점수 계산 상세

### 2.1 점수 계산 구조

```
┌─────────────────────────────────────────────────────────────────┐
│                       점수 계산 구조                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────┐     ┌─────────────────────┐            │
│  │    QUANT SCORE      │     │  DeepSeek-V3 SCORE  │            │
│  │    (객관적 지표)     │     │    (맥락 해석)      │            │
│  ├─────────────────────┤     ├─────────────────────┤            │
│  │                     │     │                     │            │
│  │  기본      60점     │     │  DeepSeek-V3 분석   │            │
│  │  ─────────────────  │     │  ─────────────────  │            │
│  │  외국인    +10점    │     │  뉴스/공시 해석     │            │
│  │  기관      +10점    │     │  섹터 모멘텀        │            │
│  │  양매수    +5점     │     │  매크로 환경        │            │
│  │  거래량    +5점     │     │  기술적 패턴        │            │
│  │  MA 위치   +5점     │     │                     │            │
│  │  연속매수  +15점max │     │                     │            │
│  │  오버행   -10점     │     │                     │            │
│  │  ─────────────────  │     │  ─────────────────  │            │
│  │  범위: 0~90점       │     │  범위: 0~100점      │            │
│  │                     │     │                     │            │
│  └──────────┬──────────┘     └──────────┬──────────┘            │
│             │                           │                       │
│             │ × 0.57                    │ × 0.43                │
│             │                           │                       │
│             └─────────────┬─────────────┘                       │
│                           │                                     │
│                           ▼                                     │
│             ┌─────────────────────────┐                         │
│             │      FINAL SCORE        │                         │
│             │  Quant×57% + DeepSeek-V3×43%  │                   │
│             │      (0~100점)          │                         │
│             └─────────────────────────┘                         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 AI 모델 구성

```
┌─────────────────────────────────────────────────────────────────┐
│                       AI 모델 역할 분담                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  ⚡ 정찰병 (Scout) - 빠른 분석                           │    │
│  │  ─────────────────────────────────────────────────────  │    │
│  │  모델: gemini-2.0-flash                 │    │
│  │  역할: 1차 스크리닝, 빠른 점수 산출                       │    │
│  │  특징: 저비용, 고속, 대량 처리                            │    │
│  │  용도: 일상적 종목 분석, Screener 통과 종목 평가           │    │
│  └─────────────────────────────────────────────────────────┘    │
│                           │                                     │
│                           ▼                                     │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  🧠 참모 (Advisor) - 심층 분석                           │    │
│  │  ─────────────────────────────────────────────────────  │    │
│  │  모델: deepseek-v3                 │    │
│  │  역할: 복잡한 상황 판단, 시나리오 분석                     │    │
│  │  특징: 고비용, 정밀, 맥락 이해력 우수                      │    │
│  │  용도: 대형 포지션, 불확실한 상황, 중요 의사결정            │    │
│  └─────────────────────────────────────────────────────────┘    │
│                           │                                     │
│                           ▼                                     │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  🛡️ 감사관 (Auditor) - 리스크 검증                       │    │
│  │  ─────────────────────────────────────────────────────  │    │
│  │  모델: deepseek-r1                                      │    │
│  │  역할: 고가 매수 전 최종 검증, 반론 제기                   │    │
│  │  특징: 추론 특화, 논리적 검증                             │    │
│  │  용도: 100만원 이상 매수 시 DeepSeek Validator            │    │
│  └─────────────────────────────────────────────────────────┘    │
│                           │                                     │
│                           ▼                                     │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  🏗️ 설계자 (Architect) - 시스템 개발                     │    │
│  │  ─────────────────────────────────────────────────────  │    │
│  │  모델: claude-opus-4 (Claude Code)                      │    │
│  │  역할: 코드 작성, 시스템 설계, 문서화                      │    │
│  │  특징: 코딩 특화, 장문 맥락, 정밀한 수정                   │    │
│  │  용도: 전략 코드 개발, 백테스터 구현, 시스템 개선           │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2.3 AI 모델 전체 목록

| 역할        | 모델                 | 용도                   | 상태     |
| --------- | ------------------ | -------------------- | ------ |
| 🎯 **총괄** | `claude-opus-4.5`  | 실시간 매매 판단/실행         | 🔴 운영중 |
| ⚡ 분석      | `deepseek-v3`      | 종목 점수 산출 (추론)        | 🔴 운영중 |
| 🛡️ 검증    | `deepseek-r1`      | 고가 매수 검증             | 🔴 운영중 |
| ⚡ 정찰      | `gemini-2.0-flash` | 빠른 스크리닝              | ⚪ 운영중  |
| 🧠 심층     | `gemini-2.5-pro`   | 시나리오 분석              | ⚪ 비활성  |
| 🏗️ 개발    | `claude-opus-4.5`  | 시스템 개발 (Claude Code) | 🔴 운영중 |

### 2.4 현재 운영 아키텍처

```
┌─────────────────────────────────────────────────────────────────┐
│                    시스템 역할 분리 구조                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    BACKEND (점수 생성)                   │    │
│  │  ─────────────────────────────────────────────────────  │    │
│  │                                                         │    │
│  │  각 AI가 자기 분야 담당 → 점수 생성 → DB 저장            │    │
│  │                                                         │    │
│  │  ┌───────────┐  ┌───────────────┐  ┌───────────┐            │    │
│  │  │deepseek-v3│  │gemini-2.0-pro │  │deepseek-r1│            │    │
│  │  │ (분석)     │  │ (스크린)        │  │ (검증)    │            │    │
│  │  └─────┬─────┘  └─────┬─────────┘  └─────┬─────┘            │    │
│  │        │              │                  │                   │    │
│  │        └──────────────┼──────────────────┘                   │    │
│  │                       ▼                                  │    │
│  │              ┌─────────────────┐                         │    │
│  │              │   PostgreSQL    │                         │    │
│  │              │   (AI Scores)   │                         │    │
│  │              └────────┬────────┘                         │    │
│  │                       │                                  │    │
│  └───────────────────────┼──────────────────────────────────┘    │
│                          │                                       │
│                          ▼                                       │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │              FRONTEND (실시간 매매 실행)                  │    │
│  │  ─────────────────────────────────────────────────────  │    │
│  │                                                         │    │
│  │  모델: Claude Opus 4.5 (claude-opus-4-5-20251101)        │    │
│  │                                                         │    │
│  │  ┌─────────┐    ┌─────────┐    ┌─────────┐              │    │
│  │  │ DB 읽기  │───▶│ 판단     │───▶│ KIS API │              │    │
│  │  │ (점수)   │    │ (매매)   │    │ (실행)  │              │    │
│  │  └─────────┘    └─────────┘    └─────────┘              │    │
│  │                                                         │    │
│  │  담당 업무:                                              │    │
│  │  1. 실시간 모니터링 - 3분 간격 포트폴리오 감시            │    │
│  │  2. 매매 결정 - DeepSeek-V3점수(DB) + 손익률 기반 판단   │    │
│  │  3. 리밸런싱 - 저점수 종목 정리, 고점수 종목 집중         │    │
│  │  4. 손절/익절 - -3% 손절, +2.5% (점수<50) 익절          │    │
│  │  5. 주문 실행 - KIS API 통해 실제 매매 체결              │    │
│  │                                                         │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2.4.1 역할 분담 상세

```
┌─────────────────────────────────────────────────────────────────┐
│                      BACKEND - 점수 생성팀                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  ⚡ deepseek-v3 (종목 분석)                              │    │
│  │  ─────────────────────────────────────────────────────  │    │
│  │  - Chain of Thought 기반 논리적 분석                     │    │
│  │  - 뉴스/공시/수급 데이터 해석                             │    │
│  │  - 0-100점 DeepSeek-V3 Score 산출 → DB 저장             │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  🛡️ deepseek-r1 (리스크 검증)                            │    │
│  │  ─────────────────────────────────────────────────────  │    │
│  │  - 고가 매수 전 반론 제기                                 │    │
│  │  - 낙관적 편향 보정                                      │    │
│  │  - 검증 결과 → DB 저장                                   │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  ⚡ gemini-2.0-flash (빠른 스크리닝)                      │    │
│  │  ─────────────────────────────────────────────────────  │    │
│  │  - 대량 종목 1차 필터링                                   │    │
│  │  - 빠른 점수 산출 → DB 저장                              │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                   FRONTEND - 매매 실행 (Claude Opus 4.5)         │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [3분마다 실행]                                                  │
│                                                                 │
│  ① DB에서 점수 조회                                              │
│     │                                                           │
│     ▼                                                           │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  각 종목별 체크 (DB 기반)                                │    │
│  │  - DeepSeek-V3 점수 (Backend가 생성)                      │    │
│  │  - 현재 손익률 (KIS 실시간)                              │    │
│  │  - 보유 일수                                             │    │
│  └─────────────────────────────────────────────────────────┘    │
│     │                                                           │
│     ▼                                                           │
│  ② 매도 판단                                                    │
│     │                                                           │
│     ├─ 손익률 ≤ -3%        → 손절 매도                          │
│     ├─ 손익률 ≥ +2.5%      → 점수 확인                          │
│     │   └─ 점수 < 50       → 익절 매도                          │
│     │   └─ 점수 ≥ 50       → 보유 유지                          │
│     └─ 점수 < 30 (5일 보유) → DeepSeek-V3 Exit 매도             │
│                                                                 │
│     ▼                                                           │
│  ③ 매수 판단 (여유 자금 있을 때)                                 │
│     │                                                           │
│     ├─ DB에서 고점수 종목 조회                                  │
│     ├─ DeepSeek-V3 점수 ≥ 70   → 매수 고려                      │
│     └─ Safety Check 통과   → 매수 실행                          │
│                                                                 │
│     ▼                                                           │
│  ④ KIS API 주문 실행                                            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2.4.2 데이터 흐름 요약

```
┌─────────────────────────────────────────────────────────────────┐
│                        데이터 흐름                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [BACKEND]                    [DB]              [FRONTEND]      │
│                                                                 │
│  deepseek-v3 ────점수────▶ ┌────────┐                           │
│  deepseek-r1 ────검증────▶ │AIReport│ ◀────읽기──── Claude      │
│  gemini-flash ───점수────▶ │        │              Opus 4.5    │
│                            └────────┘                  │        │
│                                                        │        │
│                            ┌────────┐                  │        │
│                            │Portfolio│◀───읽기/쓰기────┤        │
│                            └────────┘                  │        │
│                                                        │        │
│                                                        ▼        │
│                                                   ┌────────┐    │
│                                                   │KIS API │    │
│                                                   │(주문)  │    │
│                                                   └────────┘    │
│                                                                 │
│  ─────────────────────────────────────────────────────────────  │
│  핵심: Backend가 점수 생성 → DB 저장                             │
│        Claude가 DB 읽기 → 매매 판단 → KIS 실행                   │
│  ─────────────────────────────────────────────────────────────  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2.5 AI 모델 선택 기준

```
┌─────────────────────────────────────────────────────────────────┐
│                      모델 선택 플로우                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [트레이딩 분석 - 현재 운영]                                      │
│  ─────────────────────────────────────────────────────────────  │
│                                                                 │
│  Screener 통과 종목                                              │
│       │                                                         │
│       ▼                                                         │
│  ┌──────────────────────┐                                       │
│  │ deepseek-v3 추론     │  ← 메인 분석 엔진                      │
│  │ (Chain of Thought)   │                                       │
│  └──────────┬───────────┘                                       │
│             │                                                   │
│             ▼                                                   │
│  ┌──────────────┐                                               │
│  │ 매수 금액?   │                                               │
│  └──────┬───────┘                                               │
│         │                                                       │
│    ┌────┴────┐                                                  │
│    ▼         ▼                                                  │
│  < 100만   ≥ 100만                                              │
│    │         │                                                  │
│    ▼         ▼                                                  │
│  바로      deepseek-r1                                          │
│  매수      검증 추가                                             │
│                                                                 │
│  ─────────────────────────────────────────────────────────────  │
│                                                                 │
│  [시스템 개발]                                                   │
│  ─────────────────────────────────────────────────────────────  │
│                                                                 │
│  코드 작성/수정 → Claude Code (claude-opus-4)                    │
│  문서 작성     → Claude Code (claude-opus-4)                    │
│  백테스터 개발  → Claude Code (claude-opus-4)                    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2.6 모델별 비용 비교

| 모델                 | 입력 (1M tokens) | 출력 (1M tokens) | 용도          |
| ------------------ | -------------- | -------------- | ----------- |
| `deepseek-v3`      | $0.27          | $1.10          | 메인 분석       |
| `deepseek-r1`      | $0.55          | $2.19          | 고가 검증       |
| `gemini-2.0-flash` | $0.075         | $0.30          | 빠른 스크리닝     |
| `gemini-2.5-pro`   | $1.25          | $5.00          | 심층 분석 (비활성) |

```
현재 비용 최적화 전략:
─────────────────────────────────────────────────
1. 메인 분석: deepseek-v3 (가성비 최고)
2. 검증: deepseek-r1 (100만원 이상만)
3. Gemini Pro: 비활성화 (비용 절감)
─────────────────────────────────────────────────
```

### 2.7 Quant Score 계산 예시

```
┌─────────────────────────────────────────────────────────────────┐
│  예시: 삼성전자 Quant Score 계산                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  기본점수 (Screener 통과)              60점                      │
│  ───────────────────────────────────────────                    │
│  외국인 3일 연속 순매수                +10점  ✓                  │
│  기관 순매수                          +10점  ✓                  │
│  외국인+기관 동시 (양매수)             +5점   ✓                  │
│  거래량 평균 대비 150% (2배 미만)       +0점   ✗                  │
│  현재가 > 20일 이동평균                +5점   ✓                  │
│  외국인 연속 매수 3일                  +9점   (3일×3점)          │
│  오버행 위험 없음                      +0점                      │
│  ───────────────────────────────────────────                    │
│  합계                                 99점                      │
│  최대치 cap 적용                       90점  (max 90)            │
│                                                                 │
│  ∴ Quant Score = 90점                                          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2.8 매수 타이밍 최적화 (개발 추가)

> **문제점**: AI 점수만으로 매수 → 고점 근처 매수 → 수익률 저조
> **해결책**: AI 점수 + 기술적 지표 결합으로 최적 진입 타이밍 포착

```
┌─────────────────────────────────────────────────────────────────┐
│                    매수 타이밍 최적화 전략                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  기존 방식 (문제점):                                              │
│  ─────────────────────────────────────────────────────────────  │
│                                                                 │
│    DeepSeek-V3 점수 ≥ 70  →  즉시 매수                          │
│                                                                 │
│    ❌ 고점 근처에서 점수 높음 → 매수 후 하락                       │
│    ❌ 기술적 과열 상태 무시                                       │
│    ❌ 단기 급등 후 조정 미고려                                    │
│                                                                 │
│  ─────────────────────────────────────────────────────────────  │
│                                                                 │
│  개선 방식 (권장):                                                │
│  ─────────────────────────────────────────────────────────────  │
│                                                                 │
│    DeepSeek-V3 점수 ≥ 70                                        │
│           │                                                     │
│           ▼                                                     │
│    ┌──────────────────────────┐                                 │
│    │  기술적 지표 추가 확인    │                                 │
│    │  ────────────────────    │                                 │
│    │  • RSI < 70 (과매수 아님) │                                 │
│    │  • 현재가 ≤ 20일 고점×97% │                                 │
│    │  • 3일 수익률 < +10%     │                                 │
│    └────────────┬─────────────┘                                 │
│                 │                                               │
│        ┌────────┴────────┐                                      │
│        │                 │                                      │
│      [모두 통과]       [하나라도 실패]                            │
│        │                 │                                      │
│        ▼                 ▼                                      │
│    ┌────────┐      ┌─────────────┐                              │
│    │ 매수   │      │ 대기        │                              │
│    │ 실행   │      │ (조정 대기) │                              │
│    └────────┘      └─────────────┘                              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 2.8.1 기술적 지표 기준

```python
# ═══════════════════════════════════════════════════════════════
#              매수 타이밍 필터 (기술적 지표)
# ═══════════════════════════════════════════════════════════════

TIMING_FILTERS = {
    # RSI 필터 (Relative Strength Index)
    "rsi": {
        "period": 14,           # RSI 계산 기간
        "max_buy": 70,          # RSI < 70이면 매수 OK (과매수 아님)
        "min_buy": 30,          # RSI > 30이면 매수 OK (과매도 아님 - 하락 추세)
        "optimal_range": (40, 60),  # RSI 40~60이 최적 매수 구간
    },

    # 고점 대비 위치
    "high_distance": {
        "period": 20,           # 20일 고점 기준
        "max_ratio": 0.97,      # 고점 대비 97% 이하에서만 매수
                                # (3% 이상 조정 후 진입)
    },

    # 단기 급등 필터
    "short_term_gain": {
        "period": 3,            # 3일 수익률
        "max_gain": 10.0,       # 3일 +10% 미만에서만 매수
                                # (급등 후 조정 대기)
    },

    # 거래량 급증 필터
    "volume_spike": {
        "period": 20,           # 20일 평균 거래량 기준
        "max_ratio": 3.0,       # 평균 대비 300% 미만에서만 매수
                                # (거래량 급증 = 고점 신호)
    },
}
```

#### 2.8.2 최적 매수 조건

```
┌─────────────────────────────────────────────────────────────────┐
│                    최적 매수 조건 체크리스트                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ✅ 필수 조건 (모두 충족):                                        │
│  ─────────────────────────────────────────────────────────────  │
│  □ DeepSeek-V3 점수 ≥ 70                                        │
│  □ Final Score ≥ 70                                             │
│  □ Safety Check 통과                                            │
│                                                                 │
│  ✅ 기술적 필터 (3개 이상 충족):  ⚠️ 개발 추가                     │
│  ─────────────────────────────────────────────────────────────  │
│  □ RSI(14) < 70 (과매수 아님)                                    │
│  □ RSI(14) > 30 (급락 중 아님)                                   │
│  □ 현재가 ≤ 20일 고점 × 97%                                      │
│  □ 3일 수익률 < +10%                                            │
│  □ 거래량 < 20일 평균 × 3                                        │
│                                                                 │
│  ⭐ 최적 매수 신호 (보너스):                                       │
│  ─────────────────────────────────────────────────────────────  │
│  ○ RSI 40~60 (중립 구간)                                        │
│  ○ 20일 저점 대비 +5~15% 위치                                    │
│  ○ 이동평균선 수렴 중                                            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 2.8.3 RSI 계산 방법

```python
def calculate_rsi(prices: List[float], period: int = 14) -> float:
    """
    RSI (Relative Strength Index) 계산

    Args:
        prices: 종가 리스트 (최근 데이터가 마지막)
        period: RSI 기간 (기본 14일)

    Returns:
        RSI 값 (0~100)

    해석:
        RSI > 70: 과매수 (상승 과열) → 매수 보류
        RSI < 30: 과매도 (하락 과열) → 반등 기대
        RSI 40~60: 중립 → 최적 매수 구간
    """
    if len(prices) < period + 1:
        return 50.0  # 데이터 부족 시 중립값

    # 가격 변화 계산
    deltas = [prices[i] - prices[i-1] for i in range(1, len(prices))]

    # 최근 period일 데이터만 사용
    recent_deltas = deltas[-(period):]

    # 상승/하락 분리
    gains = [d if d > 0 else 0 for d in recent_deltas]
    losses = [-d if d < 0 else 0 for d in recent_deltas]

    # 평균 계산
    avg_gain = sum(gains) / period
    avg_loss = sum(losses) / period

    if avg_loss == 0:
        return 100.0

    rs = avg_gain / avg_loss
    rsi = 100 - (100 / (1 + rs))

    return round(rsi, 2)
```

#### 2.8.4 매수 타이밍 점수

```
┌─────────────────────────────────────────────────────────────────┐
│                    매수 타이밍 점수 계산                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  타이밍 점수 = 각 조건별 점수 합계                                │
│                                                                 │
│  ┌───────────────────────────┬─────────┬────────────────────┐   │
│  │           조건            │   점수   │        비고        │   │
│  ├───────────────────────────┼─────────┼────────────────────┤   │
│  │ RSI 40~60                 │  +20점  │ 최적 구간          │   │
│  │ RSI 30~40 또는 60~70      │  +10점  │ 양호 구간          │   │
│  │ RSI < 30 또는 > 70        │   0점   │ 위험 구간          │   │
│  ├───────────────────────────┼─────────┼────────────────────┤   │
│  │ 고점 대비 90~95%          │  +20점  │ 충분한 조정        │   │
│  │ 고점 대비 95~97%          │  +10점  │ 약간 조정          │   │
│  │ 고점 대비 97% 초과        │   0점   │ 고점 근처          │   │
│  ├───────────────────────────┼─────────┼────────────────────┤   │
│  │ 3일 수익률 < 5%           │  +20점  │ 안정적             │   │
│  │ 3일 수익률 5~10%          │  +10점  │ 약간 급등          │   │
│  │ 3일 수익률 > 10%          │   0점   │ 급등 (위험)        │   │
│  └───────────────────────────┴─────────┴────────────────────┘   │
│                                                                 │
│  최종 타이밍 점수: 0~60점                                         │
│  ─────────────────────────────────────────────────────────────  │
│  50점 이상: ⭐ 최적 타이밍 (적극 매수)                             │
│  30점 이상: ✅ 양호 타이밍 (일반 매수)                             │
│  30점 미만: ⚠️ 불량 타이밍 (매수 보류)                             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 2.8.5 통합 매수 결정

```python
# ═══════════════════════════════════════════════════════════════
#              통합 매수 결정 로직 (개발 추가)
# ═══════════════════════════════════════════════════════════════

def should_buy_with_timing(
    final_score: int,
    rsi: float,
    high_ratio: float,      # 현재가 / 20일 고점
    return_3d: float,       # 3일 수익률
) -> tuple[bool, str]:
    """
    AI 점수 + 기술적 지표 결합 매수 결정

    Args:
        final_score: Final Score (Quant×57% + DeepSeek-V3×43%)
        rsi: RSI(14) 값
        high_ratio: 20일 고점 대비 비율 (0.95 = 고점의 95%)
        return_3d: 3일 수익률 (%)

    Returns:
        (매수 여부, 사유)
    """
    # 1. 기본 조건 (필수)
    if final_score < 70:
        return False, "점수 부족"

    # 2. 기술적 필터 (개발 추가)
    timing_score = 0

    # RSI 체크
    if 40 <= rsi <= 60:
        timing_score += 20
    elif 30 <= rsi <= 70:
        timing_score += 10
    else:
        return False, f"RSI 과열({rsi:.0f})"

    # 고점 대비 위치
    if high_ratio <= 0.95:
        timing_score += 20
    elif high_ratio <= 0.97:
        timing_score += 10
    else:
        return False, f"고점 근처({high_ratio:.1%})"

    # 3일 수익률
    if return_3d < 5.0:
        timing_score += 20
    elif return_3d < 10.0:
        timing_score += 10
    else:
        return False, f"급등 후({return_3d:.1f}%)"

    # 3. 최종 판단
    if timing_score >= 30:
        grade = "⭐최적" if timing_score >= 50 else "✅양호"
        return True, f"{grade} 타이밍(점수:{timing_score})"
    else:
        return False, f"⚠️타이밍 불량(점수:{timing_score})"
```

---

## 3. 안전 시스템

### 3.1 Circuit Breaker 동작

```
┌─────────────────────────────────────────────────────────────────┐
│                    Circuit Breaker 동작                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  계좌 잔고: 1,000만원                                            │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ Level 1: 계좌 전체 서킷브레이커 (-2%)                     │    │
│  │ ─────────────────────────────────────                   │    │
│  │ 손실 20만원 도달 시 → 전체 거래 즉시 중단                  │    │
│  │ (AI 3연속 실패 시나리오 대비)                             │    │
│  └─────────────────────────────────────────────────────────┘    │
│                           │                                     │
│                           ▼                                     │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ Level 2: 일일 손실 한도 (-3%)                            │    │
│  │ ─────────────────────────────────────                   │    │
│  │ 당일 손실 30만원 도달 시 → 당일 추가 거래 중단             │    │
│  └─────────────────────────────────────────────────────────┘    │
│                           │                                     │
│                           ▼                                     │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ Level 3: 최소 잔고 (100만원)                             │    │
│  │ ─────────────────────────────────────                   │    │
│  │ 잔고 100만원 미만 시 → 거래 불가                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 포지션 제한 시각화

```
┌─────────────────────────────────────────────────────────────────┐
│                      포지션 제한                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  총 투자금: 600만원                                              │
│                                                                 │
│  ┌────────┬────────┬────────┬────────┬────────┐                 │
│  │ 종목1  │ 종목2  │ 종목3  │ 종목4  │ 종목5  │  ← 최대 5종목    │
│  │ 120만  │ 120만  │ 120만  │ 120만  │ 120만  │                 │
│  │ (20%)  │ (20%)  │ (20%)  │ (20%)  │ (20%)  │                 │
│  └────────┴────────┴────────┴────────┴────────┘                 │
│                                                                 │
│  제한 규칙:                                                      │
│  ├─ 1종목 최대: 120만원 (전체의 20%)                             │
│  ├─ 1종목 최대 비중: 20% (집중 투자 제한)  ⚠️ 개발 추가          │
│  └─ 일일 최대 거래: 4회                                         │
│                                                                 │
│  리스크 계산:                                                    │
│  한 종목 -10% 손실 시 → 전체 -2% 손실 (허용 범위 내)             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 4. 매도 규칙 상세

### 4.1 매도 조건 요약

```
┌─────────────────────────────────────────────────────────────────┐
│                        매도 조건                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  매수가: 10,000원 기준                                           │
│                                                                 │
│         손절                분할익절        트레일링        익절  │
│          │                    │              │              │   │
│          ▼                    ▼              ▼              ▼   │
│  ────────┼────────────────────┼──────────────┼──────────────┼── │
│       9,800원             10,350원       10,500원       10,550원 │
│        -2%                 +3.5%           +5%           +5.5%  │
│          │                    │              │              │   │
│          ▼                    ▼              ▼              ▼   │
│      전량 매도            50% 매도      고점 추적       전량 매도 │
│      (손실 확정)         (이익 확보)     시작           (목표 달성)│
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 트레일링 스탑 상세

```
┌─────────────────────────────────────────────────────────────────┐
│                    트레일링 스탑 동작                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [기존 방식]  +5.5% 도달 → 무조건 익절                           │
│              → 더 오를 수 있는 종목도 조기 청산                   │
│                                                                 │
│  [트레일링]  +5% 도달 → 고점 추적 시작                           │
│              → 상승 추세면 계속 보유                             │
│              → 고점 대비 -2% 하락 시 자동 청산                    │
│                                                                 │
│  ─────────────────────────────────────────────────────────────  │
│                                                                 │
│  예시) 매수가 10,000원                                           │
│                                                                 │
│  Day 1: 10,300원 (+3%)                                          │
│         → 트레일링 미활성 (5% 미달)                              │
│                                                                 │
│  Day 2: 10,500원 (+5%)                                          │
│         → 트레일링 활성화!                                       │
│         → 본전 손절가 설정 (10,000원)                            │
│                                                                 │
│  Day 3: 11,000원 (+10%)                                         │
│         → 고점 갱신                                              │
│         → 손절가 = 10,780원 (11,000 × 0.98)                     │
│                                                                 │
│  Day 4: 10,800원                                                │
│         → 손절가 유지 (10,780원)                                 │
│         → 하락 중이지만 손절가 상회, 보유 유지                    │
│                                                                 │
│  Day 5: 10,750원                                                │
│         → 손절가(10,780원) 하회!                                 │
│         → 자동 매도 실행                                         │
│         → 최종 수익: +7.5%                                       │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 4.3 🏛️ 매도 로직 설계 (Heartless Exit Strategy)

> **"매수는 신중하게, 매도는 기계적으로(Heartless)"** - 이것이 돈을 버는 방법

1분마다 스케줄러가 깨어나서 계좌를 감시하고, 조건에 맞으면 **가차 없이** 매도 주문을 날리는 시스템.

#### 보유 종목 처리 규칙

| 조건 | 액션 | 설명 |
|------|------|------|
| 수익률 ≤ **-3.0%** | 즉시 전량 매도 | 손절 (이유 불문) |
| 수익률 ≥ **+2.5%** & AI점수 < 50 | 익절 매도 | 상승 여력 약함 |
| 수익률 ≥ **+2.5%** & AI점수 ≥ 50 | 홀딩 | 수익 극대화 |
| 5일 이상 보유 & 지지부진 & AI 낮음 | 매도 | 좀비 종목 청산 |

### 4.4 💻 PortfolioManager 구현

**1분마다 실행되는 보유 종목 감시 및 매도 로직**

```python
# brain/portfolio_manager.py
import logging
from datetime import datetime
from sqlalchemy.orm import Session
from sqlalchemy import desc

from database.models import SessionLocal, Portfolio, AIReport, TradeLog
from fetchers.kis import KISFetcher
from utils.notifier import notifier

logger = logging.getLogger("PORTFOLIO_MGR")

class PortfolioManager:
    def __init__(self):
        self.kis = KISFetcher(use_virtual=False)  # 실계좌!

    def run_execution_cycle(self):
        """1분마다 실행되는 보유 종목 감시 및 매도 로직"""
        logger.info("⚙️ [Portfolio] Checking Exit Conditions...")

        # 1. KIS에서 실전 잔고 가져오기 (Source of Truth)
        real_holdings = self.kis.get_account_holdings()

        if not real_holdings:
            logger.info("ℹ️ 보유 종목 없음.")
            return

        db = SessionLocal()

        try:
            for item in real_holdings:
                self._check_and_sell(db, item)
        except Exception as e:
            logger.error(f"❌ Portfolio Error: {e}")
        finally:
            db.close()

    def _check_and_sell(self, db: Session, item: dict):
        """개별 종목 매도 조건 체크"""
        code = item.get('code')
        name = item.get('name')
        qty = int(item.get('quantity', 0))
        profit_rate = float(item.get('profit_loss_rate', 0))
        current_price = float(item.get('current_price', 0))

        # 1. AI 최신 점수 조회 (DB)
        ai_report = db.query(AIReport).filter(
            AIReport.stock_code == code
        ).order_by(desc(AIReport.created_at)).first()

        ai_score = ai_report.score if ai_report else 50  # 없으면 중립

        # 2. 매도 로직 (Decision Logic)
        sell_signal = False
        reason = ""

        # [Rule A] 칼손절 (Stop Loss) -3%
        if profit_rate <= -3.0:
            sell_signal = True
            reason = f"📉 손절매 (수익률 {profit_rate:.1f}%)"

        # [Rule B] 익절 판단 (Dynamic Take Profit) +2.5%
        elif profit_rate >= 2.5:
            if ai_score < 50:
                sell_signal = True
                reason = f"💰 익절 (수익률 {profit_rate:.1f}% / AI {ai_score}점)"
            else:
                logger.info(f"💎 홀딩: {name} {profit_rate:.1f}% (AI {ai_score}점)")

        # [Rule C] AI 강력 매도 신호 (점수 급락)
        elif ai_score < 20:
            sell_signal = True
            reason = f"🚨 AI 위험 경고 (점수 {ai_score}점)"

        # 3. 매도 실행
        if sell_signal:
            logger.warning(f"🚀 매도 주문: {name} ({reason})")

            result = self.kis.sell_market_order(stock_code=code, quantity=qty)

            if result.get("success"):
                notifier.send_telegram(f"🔔 {name} 매도 완료\n{reason}")
```

### 4.5 🔄 스케줄러 연결

```python
# scheduler/main_scheduler.py
from brain.portfolio_manager import PortfolioManager

class AegisScheduler:
    def __init__(self):
        self.portfolio_manager = PortfolioManager()

    def start(self):
        # 1분마다 보유 종목 감시 (장중에만)
        self.scheduler.add_job(
            self.job_portfolio_watchdog,
            CronTrigger(hour='9-15', minute='*', day_of_week='mon-fri'),
            id="portfolio_watchdog"
        )

    def job_portfolio_watchdog(self):
        # 15:20 이후(동시호가/장마감)에는 실행 안 함
        now = datetime.now()
        if now.hour == 15 and now.minute > 20:
            return

        self.portfolio_manager.run_execution_cycle()
```

### 4.6 💻 AutoTrader 매수 구현

**안전장치(Safety Check)를 통과한 70점 이상 종목만 매수**

```python
# brain/auto_trader.py
import logging
from datetime import datetime
from brain.analyzer import GeminiAnalyzer
from utils.safety import SafetyGuard

logger = logging.getLogger("AEGIS_BUY")

class AutoTrader:
    def __init__(self):
        self.analyzer = GeminiAnalyzer()
        self.safety = SafetyGuard()

    def check_buy_signal(self, stock_code, current_price):
        # 1. 점수 산출 (Quant 57% + AI 43%)
        analysis_result = self.analyzer.analyze_stock(stock_code)
        final_score = analysis_result['final_score']

        # 2. 점수 기준 체크 (70점 미만 탈락)
        if final_score < 70:
            logger.info(f"📉 [PASS] {stock_code} Score: {final_score}")
            return False

        # 3. Safety Check (모두 YES여야 통과)
        if not self._check_safety_conditions(stock_code):
            return False

        # 4. 매수 실행
        logger.info(f"🚀 [BUY] {stock_code} Score: {final_score}")
        return True

    def _check_safety_conditions(self, stock_code):
        """매수 전 최종 안전 점검"""

        # □ 계좌 손실 < -2%?
        if self.safety.is_global_halt_active():
            logger.warning("🛡️ [SKIP] Global Circuit Breaker")
            return False

        # □ 보유 종목 < 5개?
        if self.safety.get_holding_count() >= 5:
            logger.warning("🛡️ [SKIP] Max Holdings (5)")
            return False

        # □ 일일 거래 < 4회?
        if self.safety.get_today_trade_count() >= 4:
            logger.warning("🛡️ [SKIP] Max Daily Trades (4)")
            return False

        # □ 금요일 14:30 이전?
        now = datetime.now()
        if now.weekday() == 4 and now.hour >= 14 and now.minute >= 30:
            logger.warning("🛡️ [SKIP] Friday Afternoon")
            return False

        return True
```

### 4.7 💻 고급 매도 로직 (트레일링 + 분할매도)

```python
# brain/portfolio_manager.py (확장)

def check_exit_conditions(self, item: Portfolio):
    """트레일링 스탑 + 분할 매도 구현"""
    current_price = item.current_price
    avg_price = item.avg_price

    # 수익률 계산
    profit_rate = (current_price - avg_price) / avg_price * 100

    # 최고가 갱신 (트레일링용)
    if current_price > item.max_price_reached:
        item.max_price_reached = current_price

    # 고점 대비 하락률
    drop_from_peak = (item.max_price_reached - current_price) / item.max_price_reached * 100

    # ─────────────────────────────────────────
    # 🚦 매도 로직 분기
    # ─────────────────────────────────────────

    # 1. [손절] -2% 이하
    if profit_rate <= -2.0:
        self._sell(item, "100%", "📉 STOP LOSS (-2%)")
        return

    # 2. [분할 익절] +3.5% 도달 시 (50% 챙기기)
    if profit_rate >= 3.5 and item.sell_stage == 0:
        self._sell(item, "50%", "💰 PARTIAL PROFIT (+3.5%)")
        item.sell_stage = 1
        return

    # 3. [트레일링 스탑] +5% 이상 구간
    if item.max_price_reached >= avg_price * 1.05:

        # A. 강화 트레일링 (+8% 이상) -> 고점 대비 -2%
        if item.max_price_reached >= avg_price * 1.08:
            if drop_from_peak >= 2.0:
                self._sell(item, "100%", "📉 TRAILING (High +8%)")

        # B. 일반 트레일링 (+5%~+8%) -> 고점 대비 -2%
        elif drop_from_peak >= 2.0:
            self._sell(item, "100%", "📉 TRAILING (High +5%)")

    # 4. [전량 익절] +5.5% (AI 점수 낮으면)
    elif profit_rate >= 5.5 and item.sell_stage < 2:
        # AI 점수 80점 이상이면 트레일링으로 전환
        if ai_score < 80:
            self._sell(item, "100%", "💰 TARGET HIT (+5.5%)")

def _sell(self, item, qty_str, reason):
    """주문 실행"""
    qty = item.quantity
    if qty_str == "50%":
        qty = int(item.quantity * 0.5)

    if qty > 0:
        logger.info(f"🚀 SELL: {item.stock_name} {qty}ea | {reason}")
        self.kis.sell_market_order(item.stock_code, qty)
        notifier.send_telegram(f"🔔 {item.stock_name} 매도\n{reason}")
```

### 4.8 📊 DB 스키마 (필수 필드)

```python
# database/models.py
class Portfolio(Base):
    __tablename__ = 'portfolio'

    stock_code = Column(String(20), primary_key=True)
    stock_name = Column(String(100))
    quantity = Column(Integer, default=0)
    avg_price = Column(Float, default=0.0)
    current_price = Column(Float, default=0.0)

    # 트레일링용 필드
    max_price_reached = Column(Float, default=0.0)  # 최고가 저장
    sell_stage = Column(Integer, default=0)          # 0:미매도, 1:절반, 2:완료

    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, onupdate=datetime.utcnow)
```

### 4.9 🎯 핵심 요약

```
┌─────────────────────────────────────────────────────────────────┐
│  💡 감정 없는 투자 시스템                                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  매수: 신중하게 (70점 이상 + Safety Check)                      │
│  매도: 기계적으로 (Heartless)                                   │
│                                                                 │
│  ─────────────────────────────────────────────────────────────  │
│                                                                 │
│  손절: -2% ~ -3% → 즉시 전량 매도 (이유 불문)                   │
│  분할: +3.5% → 50% 익절 (심리적 안정)                           │
│  트레일링: +5% → 고점 추적, -2% 하락 시 매도                    │
│  익절: +5.5% → AI 낮으면 전량, 높으면 트레일링                  │
│                                                                 │
│  → 손실은 짧게, 수익은 길게 (추세 추종)                         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 5. 피라미딩 전략 (분할매수)

### 5.1 피라미딩 개요

**핵심 철학:**
```
"한 번에 크게 사지 말고, 시장이 맞다는 증거가 나올 때마다 추가하라"
```

### 5.2 3단계 피라미딩

```
┌─────────────────────────────────────────────────────────────────┐
│                  피라미딩 3-3-3 전략                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1단계: 정찰 매수 (30%) - pyramid_stage = 1                     │
│  ──────────────────────────────────────────────────────────    │
│  • AI 점수 65점 이상                                            │
│  • 소량 진입 (총 예산의 30%)                                    │
│  • 시장 반응 확인                                               │
│  • 목표: +2% 수익 시 2단계                                      │
│  • 손절: -2% 도달 시 즉시 매도                                  │
│                                                                 │
│         [+2% 수익 달성]                                         │
│                ↓                                                │
│                                                                 │
│  2단계: 본대 투입 (50%) - pyramid_stage = 2                     │
│  ──────────────────────────────────────────────────────────    │
│  • 1단계 수익 확인됨                                            │
│  • 본격 투자 (총 예산의 50%)                                    │
│  • 평균단가 재계산                                              │
│  • 목표: +3% 수익 시 3단계                                      │
│  • 손절: 평단 아래 -1% 도달 시                                  │
│                                                                 │
│         [+3% 수익 달성]                                         │
│                ↓                                                │
│                                                                 │
│  3단계: 불타기 (20%) - pyramid_stage = 3                        │
│  ──────────────────────────────────────────────────────────    │
│  • 2단계 추가 수익 확인됨                                       │
│  • 최종 투자 (총 예산의 20%)                                    │
│  • 최종 평균단가 확정                                           │
│  • 목표: +5% 익절 또는 트레일링 스탑                            │
│  • 손절: 평단 아래 -2% 도달 시                                  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 5.3 실전 예제 (오늘 12/08)

**성공 케이스: 기아**

```
총 예산: 9,167,700원
목표: 3단계 피라미딩

[1단계] 10:03 - 7주 @ 125,600원 = 879,200원
  평단: 125,600원
  수익 확인 → 2단계 진입

[2단계] 10:04-10:05 - 38주 @ 125,632원 = 4,774,000원
  평단: 125,627원
  추가 수익 확인 → 3단계 진입

[3단계] 10:12-15:15 - 28주 @ 125,407원 = 3,511,400원
  최종 평단: 125,585원

결과:
  총 73주, 평균 125,585원
  현재가 125,600원
  평가손익: +1,095원 (+0.01%)

✅ 피라미딩으로 리스크 분산하며 안정적 매수
```

### 5.4 피라미딩 장점

| 장점 | 설명 | 예시 |
|-----|------|------|
| **리스크 분산** | 한 번에 큰 금액 투입 회피 | 실패 시 30%만 손실 |
| **평단 최적화** | 수익 종목에만 추가 매수 | 승률 높은 평단 형성 |
| **심리적 안정** | 단계별 확신 증가 | 무리한 매수 방지 |
| **손실 최소화** | 조기 손절 가능 | 큰 손실 방지 |

### 5.5 Portfolio 데이터베이스

```python
# database/models.py
class Portfolio(Base):
    # 피라미딩 필드
    pyramid_stage: Mapped[int] = mapped_column(
        Integer,
        default=0,
        comment="0:미매수, 1:1차 30%, 2:2차 50%, 3:3차 20%"
    )

    pyramid_target: Mapped[int] = mapped_column(
        Integer,
        default=3,
        comment="목표 단계 (보통 3)"
    )

    total_invested: Mapped[float] = mapped_column(
        Float,
        default=0.0,
        comment="총 투자금액"
    )

    pyramid_next_price: Mapped[Optional[float]] = mapped_column(
        Float,
        nullable=True,
        comment="다음 단계 트리거 가격"
    )
```

### 5.6 코드 예제

**피라미딩 실행:**

```python
from brain.pyramid_executor import get_pyramid_executor

executor = get_pyramid_executor()

# 피라미딩 필요 여부 확인
pyramid_info = executor.should_pyramid('005930', current_price=110000)

if pyramid_info:
    # 추가 매수 실행
    stage = pyramid_info['stage']
    amount = pyramid_info['amount']

    print(f"🎯 {stage}단계 피라미딩")
    print(f"  금액: {amount:,}원")
    print(f"  이유: {pyramid_info['reason']}")

    # 실제 매수 주문
    executor.execute_pyramid_buy(
        stock_code='005930',
        stage=stage,
        quantity=calculate_qty(amount, current_price),
        price=current_price
    )
```

### 5.7 내일(12/09) 적용

**피라미딩 설정:**
```json
{
  "pyramiding": {
    "enabled": true,
    "stages": 3,
    "ratios": [0.3, 0.5, 0.2],
    "triggers": [0.02, 0.03],
    "min_score": 65,
    "focus_sectors": ["반도체", "자동차"]
  }
}
```

**실행 전략:**
1. **1단계**: AI 점수 65점 이상, 정찰 매수 30%
2. **2단계**: +2% 수익 확인 후, 본대 50% 투입
3. **3단계**: +3% 수익 확인 후, 불타기 20% 투입
4. **손절**: 각 단계별 손절선 엄격 적용

### 5.8 분할매도 전략 (Scale Out)

**핵심 철학:**
```
"수익이 나면 단계적으로 매도하여 확실한 수익 확보 + 추가 수익 기회 유지"
```

**3단계 분할매도:**

```
┌─────────────────────────────────────────────────────────────────┐
│              분할매도 전략 (Scale Out)                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1차 익절: +3% 수익 → 30% 매도                                  │
│  ──────────────────────────────────────────────────────────    │
│  • 목적: 원금 일부 회수, 심리적 안정                            │
│  • 매도: 보유 수량의 30%                                        │
│  • 남은: 70%                                                    │
│  • 트레일링 스탑: 활성화 (-1.5%)                                │
│  • sell_stage = 1                                               │
│                                                                 │
│         [계속 상승... +5% 달성]                                 │
│                ↓                                                │
│                                                                 │
│  2차 익절: +5% 수익 → 50% 추가 매도                             │
│  ──────────────────────────────────────────────────────────    │
│  • 목적: 대부분 수익 확정                                       │
│  • 매도: 남은 수량의 50% (전체의 35%)                           │
│  • 남은: 35%                                                    │
│  • 트레일링 스탑: 강화 (-1.0%)                                  │
│  • sell_stage = 2                                               │
│                                                                 │
│         [계속 상승... +8% 달성 또는 트레일링]                   │
│                ↓                                                │
│                                                                 │
│  3차 익절: +8% 또는 트레일링 → 전량 매도                        │
│  ──────────────────────────────────────────────────────────    │
│  • 목적: 완전 청산                                              │
│  • 매도: 전량 (남은 35%)                                        │
│  • sell_stage = 3                                               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 5.9 분할매도 장점

| 장점 | 설명 | 효과 |
|-----|------|------|
| **수익 확정** | 단계적 매도로 확실한 수익 | 심리적 안정 |
| **추가 기회** | 남은 포지션으로 추가 수익 | 대박 놓치지 않음 |
| **리스크 감소** | 일부 매도 후 하락해도 안전 | 손실 최소화 |
| **평균 수익↑** | 최고점 근처 일부라도 매도 | 익절 타이밍 최적화 |

### 5.10 통합 예제 (피라미딩 + 분할매도)

**완벽한 거래 시나리오:**

```
총 예산: 1,000,000원

┌─────────────────────────────────────────────────────────────┐
│  [매수 - 피라미딩]                                           │
└─────────────────────────────────────────────────────────────┘
  1차: 300,000원 @ 10,000원 = 30주  (평단: 10,000원)
  2차: 500,000원 @ 10,200원 = 49주  (평단: 10,133원)
  3차: 200,000원 @ 10,400원 = 19주  (평단: 10,224원)
  → 총 98주, 평단 10,224원

┌─────────────────────────────────────────────────────────────┐
│  [매도 - 분할매도]                                           │
└─────────────────────────────────────────────────────────────┘
  현재가: 10,500원 (+2.7% 수익)
  → 아직 +3% 미달, 대기

  현재가: 10,600원 (+3.7% 수익) ✅
  1차 익절: 29주 @ 10,600원
    수익: +10,904원
    남은: 69주

  현재가: 10,900원 (+6.6% 수익) ✅
  2차 익절: 34주 @ 10,900원
    수익: +22,984원
    남은: 35주

  현재가: 11,200원 (+9.5% 수익) ✅
  3차 익절: 35주 @ 11,200원
    수익: +34,160원

총 수익: +68,048원 (+6.8%)

vs 일괄매매:
  일괄 매수 @ 10,500원, 일괄 매도 @ 10,500원
  수익: 0원

차이: +68,048원! 🎯
```

### 5.11 코드 예제

```python
from brain.scale_out_executor import get_scale_out_executor

executor = get_scale_out_executor()

# 분할매도 필요 여부 확인
scale_out_info = executor.should_scale_out(
    stock_code='005930',
    current_price=110500,
    avg_price=110000
)

if scale_out_info:
    stage = scale_out_info['stage']
    ratio = scale_out_info['sell_ratio']

    print(f"💰 {stage}차 익절")
    print(f"  매도 비율: {ratio*100:.0f}%")
    print(f"  수익률: +{scale_out_info['profit_rate']:.2f}%")

    # 실제 매도 주문
    executor.execute_scale_out(
        stock_code='005930',
        stage=stage,
        ratio=ratio,
        price=current_price
    )
```

### 5.12 내일(12/09) 적용

**통합 전략:**
```json
{
  "buy_pyramiding": {
    "stages": 3,
    "ratios": [0.3, 0.5, 0.2],
    "triggers": [0.02, 0.03]
  },
  "sell_scale_out": {
    "stages": 3,
    "ratios": [0.3, 0.5, 1.0],
    "triggers": [0.03, 0.05, 0.08],
    "trailing_stop": [-0.015, -0.010]
  },
  "target_return": 0.02
}
```

---

## 6. 데이터 흐름

### 6.1 전체 데이터 흐름

```
┌─────────────────────────────────────────────────────────────────┐
│                       데이터 흐름도                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [외부 데이터]              [DB 저장]           [Brain 처리]     │
│                                                                 │
│  KIS API ──────────┐                                            │
│  (잔고/체결)        │       ┌─────────┐                          │
│                    ├──────▶│Portfolio│                          │
│  KRX ─────────────┐│       └─────────┘                          │
│  (가격/수급)       ││       ┌─────────┐       ┌──────────┐       │
│                   │├──────▶│DailyPrice├──────▶│          │       │
│  Naver ──────────┐││       └─────────┘       │  Quant   │       │
│  (외국인/기관)    │││       ┌─────────┐       │  Scorer  │       │
│                  ││├──────▶│Investor │───────▶│          │       │
│                  │││       │ Trend   │       └────┬─────┘       │
│                  │││       └─────────┘            │             │
│                  │││       ┌─────────┐            │             │
│                  ││└──────▶│  Stock  │            │             │
│                  ││        └─────────┘            │             │
│                  ││                               ▼             │
│  yfinance ──────┐││        ┌─────────┐     ┌──────────┐        │
│  (글로벌지표)    │││        │ Market  │     │  Final   │        │
│                 ││├───────▶│ Context │────▶│  Score   │        │
│                 │││        └─────────┘     └────┬─────┘        │
│                 │││                             │              │
│                 │││                             ▼              │
│                 │││                       ┌──────────┐         │
│                 │││                       │DeepSeek-V3│        │
│                 │││                       │  Score   │         │
│                 │││                       └──────────┘         │
│                 │││                                            │
│                 ▼▼▼                                            │
│           ┌──────────┐                                         │
│           │    DB    │  ← Source of Truth                      │
│           └──────────┘                                         │
│                                                                │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 Source of Truth 원칙

```
┌─────────────────────────────────────────────────────────────────┐
│                   Source of Truth 원칙                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐                                                │
│  │  KIS API    │  ← 원천 데이터 (실시간)                         │
│  └──────┬──────┘                                                │
│         │                                                       │
│         │ 쓰기 (Write)                                          │
│         ▼                                                       │
│  ┌─────────────┐                                                │
│  │     DB      │  ← 단일 진실 공급원 (Single Source of Truth)    │
│  └──────┬──────┘                                                │
│         │                                                       │
│         │ 읽기 (Read)                                           │
│         ▼                                                       │
│  ┌─────────────┐                                                │
│  │ 모든 모듈   │  Brain, Dashboard, API 등                      │
│  └─────────────┘                                                │
│                                                                 │
│  규칙:                                                          │
│  ├─ 읽기: 항상 DB에서                                           │
│  ├─ 쓰기: KIS Fetcher → DB                                      │
│  └─ 예외: 주문 직전 실시간 가격만 KIS API 직접 조회               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 6. 핵심 설정값 요약

```python
# ═══════════════════════════════════════════════════════════════
#                         핵심 설정값
# ═══════════════════════════════════════════════════════════════

# 점수
QUANT_WEIGHT = 0.57          # Quant Score 가중치
AI_WEIGHT = 0.43             # DeepSeek-V3 Score 가중치
MIN_SCORE = 70               # 매수 최소 점수

# 매수
MAX_POSITIONS = 5            # 최대 보유 종목
MAX_BUY_AMOUNT = 1_200_000   # 1회 최대 매수 (120만원)
MIN_BUY_AMOUNT = 500_000     # 1회 최소 매수 (50만원)
MAX_DAILY_TRADES = 4         # 일일 최대 거래

# 매도
STOP_LOSS_PCT = 2.0          # 손절 -2%
TAKE_PROFIT_PCT = 5.5        # 익절 +5.5%
PARTIAL_PROFIT_PCT = 3.5     # 분할 익절 +3.5%

# 트레일링
TRAILING_ACTIVATION = 5.0    # 트레일링 활성화 +5%
TRAILING_DISTANCE = 2.0      # 고점 대비 추적 거리 -2%
TRAILING_BOOST = 8.0         # 강화 트레일링 +8%

# 안전
ACCOUNT_CIRCUIT_BREAKER = 2.0  # 계좌 서킷브레이커 -2%
MAX_DAILY_LOSS = 3.0           # 일일 최대 손실 -3%
MAX_POSITION_SIZE = 10.0       # 1종목 최대 비중 10%
MIN_BALANCE = 1_000_000        # 최소 잔고 100만원

# 시간
FRIDAY_CUTOFF_HOUR = 14        # 금요일 매수 금지 시작
FRIDAY_CUTOFF_MINUTE = 30      # 14:30 이후 매수 금지
```

---

## 7. 빠른 의사결정 체크리스트

```
┌─────────────────────────────────────────────────────────────────┐
│                    매수 전 체크리스트                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  점수 조건                                                       │
│  ─────────────────────────────────────────────────────────────  │
│  [ ] Final Score ≥ 70점                                         │
│                                                                 │
│  포지션 조건                                                     │
│  ─────────────────────────────────────────────────────────────  │
│  [ ] 보유 종목 < 5개                                            │
│  [ ] 해당 종목 비중 < 10%                                       │
│  [ ] 일일 거래 횟수 < 4회                                       │
│                                                                 │
│  안전 조건                                                       │
│  ─────────────────────────────────────────────────────────────  │
│  [ ] 계좌 손실 < -2%                                            │
│  [ ] 일일 손실 < -3%                                            │
│  [ ] 잔고 > 100만원                                             │
│                                                                 │
│  시간 조건                                                       │
│  ─────────────────────────────────────────────────────────────  │
│  [ ] 금요일이면 14:30 이전인가?                                  │
│                                                                 │
│  ═══════════════════════════════════════════════════════════   │
│                                                                 │
│  모든 항목 ✅  →  매수 실행                                      │
│  하나라도 ❌  →  매수 보류                                       │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 8. 시나리오 시뮬레이션

### 8.1 Bull/Base/Bear 3시나리오

```
┌─────────────────────────────────────────────────────────────────┐
│                    3시나리오 구조 (DeepSeek-V3)                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  현재가: 10,000원                                               │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  🐂 Bull (낙관)                                          │    │
│  │  ─────────────────────────────────────────────────────  │    │
│  │  확률: 25%                                               │    │
│  │  목표가: 11,500원 (+15%)                                 │    │
│  │  트리거: 실적 서프라이즈, 호재 뉴스                        │    │
│  │  기간: 1-2개월                                           │    │
│  └─────────────────────────────────────────────────────────┘    │
│                           │                                     │
│                           ▼                                     │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  📊 Base (기본)                                          │    │
│  │  ─────────────────────────────────────────────────────  │    │
│  │  확률: 55%                                               │    │
│  │  목표가: 10,500원 (+5%)                                  │    │
│  │  트리거: 현재 추세 유지                                   │    │
│  │  기간: 1개월                                             │    │
│  └─────────────────────────────────────────────────────────┘    │
│                           │                                     │
│                           ▼                                     │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  🐻 Bear (비관)                                          │    │
│  │  ─────────────────────────────────────────────────────  │    │
│  │  확률: 20%                                               │    │
│  │  목표가: 9,200원 (-8%)                                   │    │
│  │  트리거: 시장 악화, 수급 이탈                             │    │
│  │  기간: 1-2개월                                           │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 8.2 시나리오 기반 의사결정

```
┌─────────────────────────────────────────────────────────────────┐
│                    시나리오 → 액션 매핑                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Bull 확률 기준:                                                │
│  ─────────────────────────────────────────────────────────────  │
│                                                                 │
│  Bull ≥ 40%  ────────▶  BUY (적극 매수)                         │
│                         포지션: 20-30%                          │
│                                                                 │
│  Bull 25-39% ────────▶  HOLD (관망)                             │
│                         포지션: 10%                             │
│                                                                 │
│  Bull < 25%  ────────▶  AVOID (회피)                            │
│                         포지션: 0%                              │
│                                                                 │
│  ─────────────────────────────────────────────────────────────  │
│                                                                 │
│  리스크/리워드 계산:                                             │
│  ─────────────────────────────────────────────────────────────  │
│                                                                 │
│  예상 수익 = Bull확률 × Bull수익 + Base확률 × Base수익          │
│  예상 손실 = Bear확률 × Bear손실                                │
│                                                                 │
│  R/R Ratio = 예상 수익 / 예상 손실                              │
│                                                                 │
│  R/R ≥ 2.0  →  매수 적합                                       │
│  R/R < 2.0  →  재검토 필요                                      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 8.3 포지션 사이징 공식

```python
# ═══════════════════════════════════════════════════════════════
#                    시나리오 기반 포지션 사이징
# ═══════════════════════════════════════════════════════════════

def calculate_position_size(
    portfolio_value: int,      # 총 자산
    current_price: int,        # 현재가
    stop_loss: int,            # 손절가
    risk_per_trade: float = 0.02  # 트레이드당 리스크 (2%)
) -> dict:
    """
    리스크 기반 포지션 사이징

    원칙: 한 번의 손절로 포트폴리오의 2% 이상 잃지 않는다
    """
    # 리스크 금액
    risk_amount = portfolio_value * risk_per_trade  # 20만원

    # 주당 리스크
    risk_per_share = current_price - stop_loss  # 500원

    # 매수 수량
    shares = risk_amount / risk_per_share  # 400주

    # 투자 금액
    investment = shares * current_price  # 400만원

    return {
        "shares": int(shares),
        "investment": int(investment),
        "position_pct": investment / portfolio_value * 100,
        "max_loss": risk_amount
    }

# 예시) 포트폴리오 1,000만원, 현재가 10,000원, 손절가 9,500원
# → 400주 매수, 400만원 투자 (40%), 최대 손실 20만원 (2%)
```

### 8.4 시나리오 출력 예시

```
┌─────────────────────────────────────────────────────────────────┐
│  📊 삼성전자 (005930) 시나리오 분석                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  현재가: 55,000원                                               │
│                                                                 │
│  [Bull] 25% 확률                                                │
│         목표가: 63,250원 (+15.0%)                               │
│         트리거: AI 반도체 수요 급증, HBM 공급 확대               │
│                                                                 │
│  [Base] 55% 확률                                                │
│         목표가: 57,750원 (+5.0%)                                │
│         트리거: 현재 업황 유지                                   │
│                                                                 │
│  [Bear] 20% 확률                                                │
│         목표가: 50,600원 (-8.0%)                                │
│         트리거: 글로벌 경기침체, 중국 수요 감소                   │
│                                                                 │
│  ─────────────────────────────────────────────────────────────  │
│  추천: HOLD                                                     │
│  포지션: 10%                                                    │
│  손절가: 52,250원 (-5%)                                         │
│  R/R Ratio: 1.8                                                 │
│  핵심 관찰: 수급 안정적이나 모멘텀 부족, 분할 매수 권장           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 9. 실시간 피드백 시스템

### 9.1 피드백 루프 개요

```
┌─────────────────────────────────────────────────────────────────┐
│                    실시간 피드백 루프                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────┐     ┌──────────┐     ┌──────────┐                 │
│  │   매수   │────▶│   보유   │────▶│   매도   │                 │
│  │ Decision │     │ Monitor  │     │ Execute  │                 │
│  └────┬─────┘     └──────────┘     └────┬─────┘                 │
│       │                                  │                       │
│       │                                  ▼                       │
│       │                          ┌──────────────┐                │
│       │                          │  즉시 검증   │                │
│       │                          │ (Validation) │                │
│       │                          └──────┬───────┘                │
│       │                                 │                        │
│       │                                 ▼                        │
│       │                          ┌──────────────┐                │
│       │                          │ 피드백 생성  │                │
│       │                          │  (Feedback)  │                │
│       │                          └──────┬───────┘                │
│       │                                 │                        │
│       │                                 ▼                        │
│       │                          ┌──────────────┐                │
│       │                          │  점수 조정   │                │
│       │◀─────────────────────────│  (Adjust)    │                │
│       │                          └──────────────┘                │
│                                                                 │
│  ═══════════════════════════════════════════════════════════   │
│  핵심: 매도 즉시 → 검증 → 피드백 → 다음 매수에 반영              │
│  ═══════════════════════════════════════════════════════════   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 9.2 매도 후 즉시 검증 (Post-Trade Validation)

```
┌─────────────────────────────────────────────────────────────────┐
│                    매도 후 즉시 검증 프로세스                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  매도 체결 즉시 (3분 내)                                         │
│  ─────────────────────────────────────────────────────────────  │
│                                                                 │
│  ① 거래 결과 기록                                                │
│     │                                                           │
│     ├─ 매수가, 매도가, 수익률                                    │
│     ├─ 보유 기간                                                │
│     ├─ 청산 사유 (TP/SL/Time/DeepSeek-V3 Exit)                  │
│     └─ 매수 시점 점수 (Quant, DeepSeek-V3, Final)               │
│                                                                 │
│  ② 성과 분류                                                     │
│     │                                                           │
│     ▼                                                           │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  SUCCESS (성공)                                          │    │
│  │  ─────────────────────────────────────────────────────  │    │
│  │  조건: 수익률 ≥ +3%                                      │    │
│  │  분류:                                                   │    │
│  │  - PERFECT: +5% 이상 (목표 달성)                         │    │
│  │  - GOOD: +3% ~ +5% (양호)                                │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  NEUTRAL (중립)                                          │    │
│  │  ─────────────────────────────────────────────────────  │    │
│  │  조건: -1% < 수익률 < +3%                                │    │
│  │  의미: 본전 또는 소폭 이익                                │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  FAILURE (실패)                                          │    │
│  │  ─────────────────────────────────────────────────────  │    │
│  │  조건: 수익률 ≤ -1%                                      │    │
│  │  분류:                                                   │    │
│  │  - MINOR_LOSS: -1% ~ -2% (소폭 손실)                     │    │
│  │  - STOP_LOSS: -2% ~ -3% (손절)                           │    │
│  │  - SEVERE_LOSS: -3% 이상 (심각)                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                 │
│  ③ 원인 분석                                                     │
│     │                                                           │
│     ├─ 매수 시점 수급 상태 재확인                                │
│     ├─ 매수 후 수급 변화 추적                                    │
│     ├─ 시장 환경 변화 (Regime)                                  │
│     └─ DeepSeek-V3 점수 vs 실제 결과 비교                       │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 9.3 피드백 데이터 구조

```python
# ═══════════════════════════════════════════════════════════════
#                    피드백 데이터 구조
# ═══════════════════════════════════════════════════════════════

@dataclass
class TradeFeedback:
    """매도 후 생성되는 피드백 데이터"""

    # 기본 정보
    stock_code: str
    trade_date: datetime

    # 거래 결과
    return_pct: float           # 수익률
    holding_days: int           # 보유일
    exit_reason: str            # 청산 사유

    # 매수 시점 점수
    buy_quant_score: int        # 매수 시 Quant 점수
    buy_deepseek_score: int     # 매수 시 DeepSeek-V3 점수
    buy_final_score: int        # 매수 시 Final 점수

    # 매수 시점 수급
    buy_foreigner_net: int      # 매수일 외국인 순매수
    buy_institution_net: int    # 매수일 기관 순매수
    buy_consecutive_days: int   # 매수일 연속 매수일

    # 성과 분류
    result_category: str        # SUCCESS/NEUTRAL/FAILURE
    result_detail: str          # PERFECT/GOOD/MINOR_LOSS/...

    # 원인 분석 (DeepSeek-V3 생성)
    failure_reason: str         # 실패 원인 (실패 시)
    lesson_learned: str         # 교훈

    # 점수 조정 제안
    suggested_adjustment: dict  # 가중치/임계값 조정 제안
```

### 9.4 실시간 피드백 생성 (DeepSeek-V3)

```
┌─────────────────────────────────────────────────────────────────┐
│                DeepSeek-V3 피드백 분석 프롬프트                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [매도 완료 - 피드백 요청]                                       │
│                                                                 │
│  종목: {stock_name} ({stock_code})                              │
│  매수가: {buy_price:,}원 → 매도가: {sell_price:,}원             │
│  수익률: {return_pct:+.1f}%                                     │
│  보유기간: {holding_days}일                                     │
│  청산사유: {exit_reason}                                        │
│                                                                 │
│  [매수 시점 분석]                                                │
│  - Quant Score: {quant_score}점                                 │
│  - DeepSeek-V3 Score: {deepseek_score}점                        │
│  - Final Score: {final_score}점                                 │
│  - 외국인: {foreigner_net:+,}주                                 │
│  - 기관: {institution_net:+,}주                                 │
│  - 연속매수: {consecutive_days}일                               │
│                                                                 │
│  [분석 요청]                                                     │
│  1. 이 거래의 성공/실패 원인을 분석해주세요                       │
│  2. 매수 시점의 점수가 적절했는지 평가해주세요                    │
│  3. 앞으로의 매수 기준 조정이 필요하다면 제안해주세요             │
│                                                                 │
│  JSON 형식으로 응답:                                             │
│  {                                                              │
│    "analysis": "원인 분석...",                                  │
│    "score_evaluation": "점수 평가...",                          │
│    "adjustment": {                                              │
│      "quant_weight": +/-0.01~0.05,                             │
│      "min_score": +/-1~3,                                      │
│      "consecutive_bonus": +/-1~2                               │
│    },                                                           │
│    "lesson": "교훈..."                                          │
│  }                                                              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 9.5 점수 체계 동적 조정

```
┌─────────────────────────────────────────────────────────────────┐
│                    점수 체계 동적 조정 규칙                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ═══════════════════════════════════════════════════════════   │
│  Layer 1: 자동 조정 (규칙 기반)                                  │
│  ═══════════════════════════════════════════════════════════   │
│                                                                 │
│  [연속 실패 시 자동 조정]                                        │
│  ─────────────────────────────────────────────────────────────  │
│                                                                 │
│  3연속 손절 (SL)                                                │
│  ├─ MIN_SCORE += 3 (70 → 73)                                   │
│  ├─ 매수 기준 강화                                              │
│  └─ 알림: "⚠️ 3연속 손절 - 매수 기준 강화"                      │
│                                                                 │
│  5연속 손절 (SL)                                                │
│  ├─ CIRCUIT_BREAKER 발동                                       │
│  ├─ 24시간 매수 중단                                            │
│  └─ 알림: "🚨 5연속 손절 - 24시간 매수 중단"                    │
│                                                                 │
│  [연속 성공 시 자동 조정]                                        │
│  ─────────────────────────────────────────────────────────────  │
│                                                                 │
│  5연속 익절 (TP)                                                │
│  ├─ MIN_SCORE -= 2 (70 → 68) [최소 65]                         │
│  ├─ 매수 기준 완화 (기회 확대)                                   │
│  └─ 알림: "✅ 5연속 성공 - 매수 기준 완화"                       │
│                                                                 │
│  ═══════════════════════════════════════════════════════════   │
│  Layer 2: 학습 기반 조정 (DeepSeek-V3 분석)                      │
│  ═══════════════════════════════════════════════════════════   │
│                                                                 │
│  주간 성과 분석 (매주 일요일)                                    │
│  ─────────────────────────────────────────────────────────────  │
│                                                                 │
│  DeepSeek-V3가 주간 거래 전체 분석 후 조정 제안:                 │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ 분석 결과 예시:                                          │    │
│  │                                                         │    │
│  │ "이번 주 손실 거래 3건 중 2건이 외국인 연속매수            │    │
│  │  3일 미만에서 발생했습니다.                               │    │
│  │                                                         │    │
│  │  제안: CONSECUTIVE_BONUS_MIN을 3일→4일로 상향             │    │
│  │        또는 3일 미만 연속매수 보너스 50% 감소"            │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                 │
│  조정 적용:                                                      │
│  ├─ 관리자 승인 필요 (자동 적용 X)                              │
│  ├─ 승인 시 config에 반영                                       │
│  └─ 변경 이력 DB 기록                                           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 9.6 피드백 데이터 저장 (DB 스키마)

```sql
-- ═══════════════════════════════════════════════════════════════
--                    피드백 테이블 스키마
-- ═══════════════════════════════════════════════════════════════

CREATE TABLE trade_feedback (
    id SERIAL PRIMARY KEY,

    -- 거래 정보
    stock_code VARCHAR(20) NOT NULL,
    buy_date DATE NOT NULL,
    sell_date DATE NOT NULL,

    -- 결과
    return_pct DECIMAL(10,2),
    holding_days INT,
    exit_reason VARCHAR(50),
    result_category VARCHAR(20),  -- SUCCESS/NEUTRAL/FAILURE
    result_detail VARCHAR(30),     -- PERFECT/GOOD/MINOR_LOSS/...

    -- 매수 시점 점수
    buy_quant_score INT,
    buy_deepseek_score INT,
    buy_final_score INT,

    -- 매수 시점 수급
    buy_foreigner_net BIGINT,
    buy_institution_net BIGINT,
    buy_consecutive_days INT,

    -- DeepSeek-V3 분석
    deepseek_analysis TEXT,       -- 원인 분석
    deepseek_lesson TEXT,         -- 교훈

    -- 조정 제안
    suggested_quant_weight DECIMAL(4,2),
    suggested_min_score INT,
    adjustment_applied BOOLEAN DEFAULT FALSE,

    -- 메타
    created_at TIMESTAMP DEFAULT NOW()
);

-- 점수 조정 이력
CREATE TABLE score_adjustment_history (
    id SERIAL PRIMARY KEY,

    adjustment_date TIMESTAMP NOT NULL,
    trigger_reason VARCHAR(100),  -- "3연속 손절" / "주간 분석"

    -- 이전 값
    prev_quant_weight DECIMAL(4,2),
    prev_deepseek_weight DECIMAL(4,2),
    prev_min_score INT,

    -- 새로운 값
    new_quant_weight DECIMAL(4,2),
    new_deepseek_weight DECIMAL(4,2),
    new_min_score INT,

    -- 승인
    approved_by VARCHAR(50),      -- "AUTO" 또는 관리자 ID

    created_at TIMESTAMP DEFAULT NOW()
);
```

### 9.7 피드백 대시보드 표시

```
┌─────────────────────────────────────────────────────────────────┐
│                 📊 실시간 피드백 대시보드                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [최근 거래 피드백]                                              │
│  ─────────────────────────────────────────────────────────────  │
│                                                                 │
│  🟢 15:32 삼성전자 매도                                          │
│     +4.2% (5일 보유) - TP 달성                                  │
│     매수점수 75점 → 적절했음 ✅                                  │
│                                                                 │
│  🔴 14:15 SK하이닉스 매도                                        │
│     -2.8% (3일 보유) - SL 발동                                  │
│     매수점수 71점 → 재검토 필요 ⚠️                              │
│     원인: 매수 다음날 외국인 이탈                                │
│                                                                 │
│  🟡 11:20 카카오 매도                                            │
│     +1.5% (7일 보유) - Time Stop                                │
│     매수점수 72점 → 모멘텀 부족                                  │
│                                                                 │
│  ─────────────────────────────────────────────────────────────  │
│                                                                 │
│  [현재 점수 설정]                                                │
│  ─────────────────────────────────────────────────────────────  │
│                                                                 │
│  Quant 가중치: 57% (기본값)                                     │
│  DeepSeek-V3 가중치: 43% (기본값)                               │
│  최소 점수: 73점 (기본 70 + 3연속손절 조정)  ⚠️                 │
│                                                                 │
│  [주간 통계]                                                     │
│  ─────────────────────────────────────────────────────────────  │
│                                                                 │
│  총 거래: 12건                                                   │
│  성공률: 58.3% (7/12)                                           │
│  평균 수익: +1.8%                                               │
│  연속 손절: 2회 (3회 시 자동 조정)                               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 9.8 피드백 적용 흐름 (전체)

```
┌─────────────────────────────────────────────────────────────────┐
│                  피드백 적용 전체 흐름                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [실시간 - 매도 직후]                                            │
│  ─────────────────────────────────────────────────────────────  │
│                                                                 │
│  매도 체결                                                       │
│      │                                                          │
│      ▼                                                          │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ 1. TradeFeedback 레코드 생성                             │    │
│  │ 2. 결과 분류 (SUCCESS/NEUTRAL/FAILURE)                   │    │
│  │ 3. DB 저장                                               │    │
│  └─────────────────────────────────────────────────────────┘    │
│      │                                                          │
│      ▼                                                          │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ 4. 연속 손절 체크                                        │    │
│  │    - 3연속 → MIN_SCORE +3                                │    │
│  │    - 5연속 → CIRCUIT_BREAKER                             │    │
│  └─────────────────────────────────────────────────────────┘    │
│      │                                                          │
│      ▼                                                          │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ 5. 텔레그램 알림                                         │    │
│  │    - 거래 결과                                           │    │
│  │    - 설정 변경 시 알림                                   │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                 │
│  [배치 - 매주 일요일]                                            │
│  ─────────────────────────────────────────────────────────────  │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ 1. 주간 거래 전체 조회                                   │    │
│  │ 2. DeepSeek-V3 종합 분석 요청                            │    │
│  │ 3. 패턴 발견 및 조정 제안                                │    │
│  │ 4. 관리자 승인 대기                                      │    │
│  │ 5. 승인 시 config 업데이트                               │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                 │
│  [다음 매수 시 적용]                                             │
│  ─────────────────────────────────────────────────────────────  │
│                                                                 │
│  새 종목 평가 시:                                                │
│  ├─ 최신 MIN_SCORE 적용                                        │
│  ├─ 최신 가중치 적용                                           │
│  ├─ 피드백에서 학습한 패턴 체크                                 │
│  └─ 유사 실패 패턴 경고                                         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 9.9 설정값 요약

```python
# ═══════════════════════════════════════════════════════════════
#                    피드백 시스템 설정값
# ═══════════════════════════════════════════════════════════════

# 결과 분류 기준
SUCCESS_THRESHOLD = 3.0          # +3% 이상 = 성공
FAILURE_THRESHOLD = -1.0         # -1% 이하 = 실패
PERFECT_THRESHOLD = 5.0          # +5% 이상 = 완벽
SEVERE_LOSS_THRESHOLD = -3.0     # -3% 이하 = 심각

# 자동 조정 트리거
CONSECUTIVE_LOSS_TRIGGER = 3     # 3연속 손절 시 조정
CIRCUIT_BREAKER_TRIGGER = 5      # 5연속 손절 시 중단
CONSECUTIVE_WIN_TRIGGER = 5      # 5연속 성공 시 완화

# 자동 조정 폭
AUTO_MIN_SCORE_INCREASE = 3      # 손절 시 MIN_SCORE 증가
AUTO_MIN_SCORE_DECREASE = 2      # 성공 시 MIN_SCORE 감소
MIN_SCORE_LOWER_BOUND = 65       # MIN_SCORE 하한선
MIN_SCORE_UPPER_BOUND = 80       # MIN_SCORE 상한선

# 주간 분석
WEEKLY_ANALYSIS_DAY = 6          # 일요일 (0=월요일)
WEEKLY_MIN_TRADES = 5            # 최소 5건 이상 시 분석
```

---

## 10. Claude Opus 4.5 Commander 시스템

> **핵심 원칙**: 다른 AI가 데이터를 수집하고 분석하면, **Opus 4.5가 최종 의사결정**을 내린다.

### 10.1 AI 역할 분담 구조

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         AEGIS AI 계층 구조                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    COMMANDER (최종 의사결정)                      │   │
│  │                                                                   │   │
│  │    ┌─────────────────────────────────────────────────────────┐   │   │
│  │    │            🧠 Claude Opus 4.5                            │   │   │
│  │    │                                                          │   │   │
│  │    │  • 실시간 모니터링 (3분 간격)                            │   │   │
│  │    │  • 매수/매도 최종 결정                                   │   │   │
│  │    │  • 포트폴리오 리밸런싱                                   │   │   │
│  │    │  • 위험 감지 및 긴급 대응                                │   │   │
│  │    │  • KIS API 주문 실행 명령                                │   │   │
│  │    └─────────────────────────────────────────────────────────┘   │   │
│  │                              ▲                                    │   │
│  │                              │ 피드백 즉시 전달                    │   │
│  │                              │                                    │   │
│  └──────────────────────────────┼────────────────────────────────────┘   │
│                                 │                                        │
│  ┌──────────────────────────────┴────────────────────────────────────┐   │
│  │                    ANALYST (분석 및 점수 산출)                      │   │
│  │                                                                    │   │
│  │  ┌──────────────────┐  ┌──────────────────┐  ┌────────────────┐   │   │
│  │  │  DeepSeek-V3     │  │  Gemini Flash    │  │ Quant System   │   │   │
│  │  │  (심층 분석)      │  │  (빠른 스캔)      │  │ (정량 분석)     │   │   │
│  │  │                  │  │                  │  │                │   │   │
│  │  │  • 뉴스 해석     │  │  • 실시간 공시   │  │  • 수급 점수   │   │   │
│  │  │  • 섹터 분석     │  │  • 빠른 필터링   │  │  • 기술 점수   │   │   │
│  │  │  • 리스크 평가   │  │  • 이상 징후     │  │  • 종목 순위   │   │   │
│  │  │  • 시나리오 생성 │  │  • 긴급 알림     │  │  • 위험도 계산 │   │   │
│  │  └──────────────────┘  └──────────────────┘  └────────────────┘   │   │
│  │           │                    │                    │             │   │
│  │           └────────────────────┼────────────────────┘             │   │
│  │                                ▼                                  │   │
│  │                    ┌──────────────────────┐                       │   │
│  │                    │   통합 리포트 생성    │                       │   │
│  │                    │   (점수 + 분석 + 리스크)│                     │   │
│  │                    └──────────────────────┘                       │   │
│  │                                │                                  │   │
│  └────────────────────────────────┼──────────────────────────────────┘   │
│                                   │                                      │
│  ┌────────────────────────────────┴──────────────────────────────────┐   │
│  │                    DATA LAYER (데이터 수집)                         │   │
│  │                                                                    │   │
│  │   KRX │ KIS API │ DART │ 뉴스 │ 글로벌지표 │ PostgreSQL DB         │   │
│  │                                                                    │   │
│  └────────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 10.2 Opus 4.5 Commander 역할 상세

```python
# ═══════════════════════════════════════════════════════════════
#                 Claude Opus 4.5 Commander 역할
# ═══════════════════════════════════════════════════════════════

OPUS_COMMANDER_ROLE = {
    "monitoring": {
        "interval": "3분",
        "targets": ["포트폴리오 손익", "시장 상황", "보유 종목 점수"],
        "triggers": ["손익률 변동", "점수 급변", "시장 이벤트"]
    },

    "decision_making": {
        "buy": "Final Score + 시장상황 + 잔고 → 최종 매수 결정",
        "sell": "손익률 + 점수변화 + 리스크 → 최종 매도 결정",
        "rebalance": "저점수 종목 정리, 고점수 종목 집중"
    },

    "risk_management": {
        "stop_loss": "-3% 손절 자동 실행",
        "take_profit": "+2.5% (점수<50) 익절 자동 실행",
        "circuit_breaker": "5연속 손절 시 거래 중단"
    },

    "execution": {
        "api": "KIS API",
        "order_type": ["시장가", "지정가"],
        "confirmation": "주문 체결 확인 및 로깅"
    }
}
```

### 10.3 피드백 즉시 수신 프로세스

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Opus 4.5 피드백 즉시 수신 흐름                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────┐                                                        │
│  │  매도 체결  │  KIS API 체결 확인                                     │
│  └──────┬──────┘                                                        │
│         │                                                               │
│         ▼ (즉시, 0~3초)                                                 │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    피드백 데이터 생성                             │   │
│  │                                                                   │   │
│  │   {                                                              │   │
│  │     "stock_code": "005930",                                      │   │
│  │     "return_pct": -2.1,                                          │   │
│  │     "holding_days": 3,                                           │   │
│  │     "exit_reason": "stop_loss",                                  │   │
│  │     "buy_final_score": 72,                                       │   │
│  │     "market_condition": "bearish",                               │   │
│  │     "sector_trend": "negative"                                   │   │
│  │   }                                                              │   │
│  │                                                                   │   │
│  └─────────────────────────┬───────────────────────────────────────┘   │
│                            │                                            │
│                            ▼ (즉시)                                     │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │               🧠 Opus 4.5 피드백 수신                             │   │
│  │                                                                   │   │
│  │   1. 결과 분류:                                                   │   │
│  │      ├─ return ≥ +3%  → SUCCESS                                  │   │
│  │      ├─ return ≤ -1%  → FAILURE                                  │   │
│  │      └─ 그 외         → NEUTRAL                                  │   │
│  │                                                                   │   │
│  │   2. 연속 패턴 체크:                                              │   │
│  │      ├─ 3연속 손절? → MIN_SCORE +3                               │   │
│  │      ├─ 5연속 손절? → CIRCUIT_BREAKER                            │   │
│  │      └─ 5연속 익절? → MIN_SCORE -2                               │   │
│  │                                                                   │   │
│  │   3. 즉시 반영 항목:                                              │   │
│  │      ├─ 연속 손실 카운터 업데이트                                │   │
│  │      ├─ 오늘 손익 합계 업데이트                                  │   │
│  │      └─ 동일 종목 재매수 블랙리스트                              │   │
│  │                                                                   │   │
│  └─────────────────────────┬───────────────────────────────────────┘   │
│                            │                                            │
│                            ▼ (0~1초)                                    │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │               Opus 4.5 다음 의사결정 반영                         │   │
│  │                                                                   │   │
│  │   • 방금 손절한 종목 → 24시간 재매수 금지                         │   │
│  │   • 연속 손절 중 → 매수 기준 강화 (MIN_SCORE ↑)                  │   │
│  │   • 시장 하락 감지 → 신규 매수 보류                              │   │
│  │   • 섹터 약세 → 해당 섹터 종목 회피                               │   │
│  │                                                                   │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 10.4 Opus 4.5 실시간 컨텍스트

```python
# ═══════════════════════════════════════════════════════════════
#              Opus 4.5에게 전달되는 실시간 컨텍스트
# ═══════════════════════════════════════════════════════════════

@dataclass
class OpusContext:
    """매 의사결정 시 Opus 4.5가 참조하는 컨텍스트"""

    # 계좌 상태
    total_balance: int           # 총 평가금액
    available_cash: int          # 주문 가능 금액
    total_profit_pct: float      # 총 손익률
    today_profit_pct: float      # 오늘 손익률

    # 포트폴리오 현황
    holdings: List[Dict]         # 보유 종목 리스트
    holding_count: int           # 보유 종목 수

    # 오늘 거래 현황
    today_trades: int            # 오늘 거래 횟수
    today_wins: int              # 오늘 익절 횟수
    today_losses: int            # 오늘 손절 횟수

    # 연속 패턴
    consecutive_losses: int      # 연속 손절 횟수
    consecutive_wins: int        # 연속 익절 횟수

    # 현재 설정값
    current_min_score: int       # 현재 MIN_SCORE
    current_quant_weight: float  # Quant 가중치

    # 시장 상황
    market_regime: str           # "bullish" | "neutral" | "bearish"
    kospi_change: float          # KOSPI 등락률

    # 최근 피드백 요약
    recent_feedback: List[Dict]  # 최근 5건 거래 결과

    # 블랙리스트
    blacklisted_stocks: List[str]  # 재매수 금지 종목

# Opus 4.5 프롬프트 예시
OPUS_DECISION_PROMPT = """
[AEGIS Commander - 의사결정 요청]

현재 상황:
- 계좌 잔고: {total_balance:,}원
- 가용 현금: {available_cash:,}원
- 오늘 손익: {today_profit_pct:+.2f}%
- 보유 종목: {holding_count}개
- 오늘 거래: {today_trades}회 (익절 {today_wins}, 손절 {today_losses})
- 연속 손절: {consecutive_losses}회

최근 피드백:
{recent_feedback_summary}

후보 종목:
{candidate_stocks}

현재 설정:
- MIN_SCORE: {current_min_score}
- Quant 가중치: {current_quant_weight}

시장 상황:
- Regime: {market_regime}
- KOSPI: {kospi_change:+.2f}%

블랙리스트 (24시간 재매수 금지):
{blacklisted_stocks}

위 상황을 종합하여:
1. 매수할 종목과 수량
2. 매도할 종목과 사유
3. 리밸런싱 필요 여부
4. 설정 조정 필요 여부

를 결정해주세요.
"""
```

### 10.5 빠른 대응 체계

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Opus 4.5 빠른 대응 매트릭스                           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌───────────────────┬──────────────────────┬────────────────────────┐ │
│  │      트리거        │       조건           │       대응             │ │
│  ├───────────────────┼──────────────────────┼────────────────────────┤ │
│  │ 즉시 대응         │ 매도 체결 직후        │ • 피드백 기록          │ │
│  │ (0~3초)           │                      │ • 연속 패턴 체크       │ │
│  │                   │                      │ • 블랙리스트 업데이트   │ │
│  ├───────────────────┼──────────────────────┼────────────────────────┤ │
│  │ 자동 조정         │ 3연속 손절           │ • MIN_SCORE +3         │ │
│  │ (1분 내)          │                      │ • 텔레그램 알림        │ │
│  │                   │                      │ • 매수 보수적 전환     │ │
│  ├───────────────────┼──────────────────────┼────────────────────────┤ │
│  │ Circuit Breaker   │ 5연속 손절 OR        │ • 신규 매수 중단       │ │
│  │ (즉시)            │ 일일 손실 -3%        │ • 관리자 알림          │ │
│  │                   │                      │ • 수동 해제 필요       │ │
│  ├───────────────────┼──────────────────────┼────────────────────────┤ │
│  │ 공격 전환         │ 5연속 익절           │ • MIN_SCORE -2         │ │
│  │ (다음 매수 시)    │                      │ • 매수 적극적 전환     │ │
│  ├───────────────────┼──────────────────────┼────────────────────────┤ │
│  │ 긴급 매도         │ 종목 점수 급락       │ • 해당 종목 즉시 매도  │ │
│  │ (실시간)          │ (70점 → 40점 이하)   │ • 원인 분석 기록       │ │
│  ├───────────────────┼──────────────────────┼────────────────────────┤ │
│  │ 시장 대응         │ KOSPI -2% 이상 급락  │ • 신규 매수 보류       │ │
│  │ (실시간)          │                      │ • 손절라인 타이트      │ │
│  └───────────────────┴──────────────────────┴────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 10.6 Opus 4.5 의사결정 로그

```python
# ═══════════════════════════════════════════════════════════════
#                    의사결정 로그 스키마
# ═══════════════════════════════════════════════════════════════

@dataclass
class OpusDecisionLog:
    """Opus 4.5 의사결정 기록"""

    decision_id: str              # UUID
    timestamp: datetime           # 결정 시각
    decision_type: str            # "buy" | "sell" | "hold" | "rebalance"

    # 입력 컨텍스트 요약
    context_snapshot: Dict        # OpusContext 스냅샷

    # 결정 내용
    target_stock: Optional[str]   # 대상 종목
    action: str                   # 실행 액션
    quantity: Optional[int]       # 수량
    reason: str                   # 결정 사유

    # AI 분석
    risk_assessment: str          # 리스크 평가
    confidence_level: float       # 확신도 (0~100)

    # 실행 결과
    executed: bool                # 실행 여부
    execution_result: Optional[Dict]  # 체결 결과

# DB 테이블
"""
CREATE TABLE opus_decision_log (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    timestamp TIMESTAMP NOT NULL DEFAULT NOW(),
    decision_type VARCHAR(20) NOT NULL,

    -- 컨텍스트
    context_json JSONB NOT NULL,

    -- 결정
    target_stock VARCHAR(20),
    action VARCHAR(50) NOT NULL,
    quantity INT,
    reason TEXT NOT NULL,

    -- 분석
    risk_assessment TEXT,
    confidence_level DECIMAL(5,2),

    -- 결과
    executed BOOLEAN DEFAULT FALSE,
    execution_result JSONB,

    -- 인덱스용
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_opus_log_timestamp ON opus_decision_log(timestamp);
CREATE INDEX idx_opus_log_stock ON opus_decision_log(target_stock);
CREATE INDEX idx_opus_log_type ON opus_decision_log(decision_type);
"""
```

### 10.7 피드백 → Opus 4.5 → 다음 결정 흐름

```
┌─────────────────────────────────────────────────────────────────────────┐
│                완전한 피드백 → 의사결정 사이클                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  [T+0] 매도 체결                                                        │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│    KIS API 체결 확인                                                    │
│         │                                                               │
│         ▼                                                               │
│    ┌──────────────────────────────────────────────────────────────┐    │
│    │ 피드백 생성                                                   │    │
│    │ • 수익률 계산: (매도가 - 매수가) / 매수가                     │    │
│    │ • 보유기간: 매도일 - 매수일                                   │    │
│    │ • 매수 당시 점수 조회 (DB)                                    │    │
│    └──────────────────────────────────────────────────────────────┘    │
│         │                                                               │
│         ▼                                                               │
│                                                                         │
│  [T+1초] Opus 4.5 피드백 수신                                           │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│    ┌──────────────────────────────────────────────────────────────┐    │
│    │ 🧠 Opus 4.5 피드백 처리                                       │    │
│    │                                                               │    │
│    │ 1. 결과 분류 (SUCCESS/NEUTRAL/FAILURE)                       │    │
│    │ 2. consecutive_losses/wins 카운터 업데이트                   │    │
│    │ 3. 블랙리스트 추가 (손절 종목 24시간)                        │    │
│    │ 4. 자동 조정 트리거 체크                                     │    │
│    └──────────────────────────────────────────────────────────────┘    │
│         │                                                               │
│         ▼                                                               │
│    ┌────────────────────────────┐                                      │
│    │ 자동 조정 필요?            │                                      │
│    └─────────────┬──────────────┘                                      │
│           ┌──────┴──────┐                                              │
│           │             │                                              │
│         [YES]         [NO]                                             │
│           │             │                                              │
│           ▼             │                                              │
│    ┌────────────────┐   │                                              │
│    │ 설정 조정      │   │                                              │
│    │ • MIN_SCORE ↑↓│   │                                              │
│    │ • 가중치 조정  │   │                                              │
│    │ • 텔레그램 알림│   │                                              │
│    └───────┬────────┘   │                                              │
│            │            │                                              │
│            └─────┬──────┘                                              │
│                  │                                                      │
│                  ▼                                                      │
│                                                                         │
│  [T+3초] 다음 의사결정 준비 완료                                         │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│    ┌──────────────────────────────────────────────────────────────┐    │
│    │ Opus 4.5 컨텍스트 업데이트 완료                               │    │
│    │                                                               │    │
│    │ • 연속 패턴: consecutive_losses = 2                          │    │
│    │ • 블랙리스트: ["005930", "000660"]                           │    │
│    │ • MIN_SCORE: 73 (기본 70 + 조정 +3)                          │    │
│    │ • 오늘 손익: -1.2%                                           │    │
│    │                                                               │    │
│    │ → 다음 매수 판단 시 즉시 반영                                 │    │
│    └──────────────────────────────────────────────────────────────┘    │
│                                                                         │
│  [T+3분] 다음 모니터링 사이클                                            │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│    ┌──────────────────────────────────────────────────────────────┐    │
│    │ 🧠 Opus 4.5 다음 의사결정                                     │    │
│    │                                                               │    │
│    │ • 업데이트된 MIN_SCORE 적용                                  │    │
│    │ • 블랙리스트 종목 자동 제외                                  │    │
│    │ • 연속 손절 상태 → 보수적 매수                               │    │
│    │ • 피드백 학습 내용 반영                                      │    │
│    └──────────────────────────────────────────────────────────────┘    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 10.8 설정값 요약

```python
# ═══════════════════════════════════════════════════════════════
#              Opus 4.5 Commander 시스템 설정값
# ═══════════════════════════════════════════════════════════════

# 모니터링
MONITORING_INTERVAL = 180       # 3분 (초)
FEEDBACK_DELAY_MAX = 3          # 피드백 수신 최대 지연 (초)

# 자동 대응
AUTO_STOP_LOSS = -3.0           # 손절 라인 (%)
AUTO_TAKE_PROFIT = 2.5          # 익절 라인 (점수 < 50인 경우)
SCORE_DROP_THRESHOLD = 30       # 점수 급락 기준 (70 → 40)

# 블랙리스트
BLACKLIST_DURATION_HOURS = 24   # 재매수 금지 기간

# Circuit Breaker
CIRCUIT_BREAKER_CONSECUTIVE = 5 # 연속 손절 횟수
CIRCUIT_BREAKER_DAILY_LOSS = -3.0  # 일일 손실 한도 (%)

# 로깅
LOG_ALL_DECISIONS = True        # 모든 의사결정 기록
LOG_RETENTION_DAYS = 90         # 로그 보관 기간

# 알림
TELEGRAM_ON_ADJUSTMENT = True   # 설정 조정 시 알림
TELEGRAM_ON_CIRCUIT_BREAKER = True  # Circuit Breaker 시 알림
```

---

## 11. v2.8 실시간 피드백 시스템 (Session Feedback)

> **핵심 철학**: "매도 직후 그 결과가 다음 매수 판단에 즉시 반영된다"

### 11.1 피드백 흐름 아키텍처

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    v2.8 실시간 피드백 파이프라인                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  [1] 거래 실행                                                          │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│    AutoTrader._execute_buy_v2() / _execute_sell()                       │
│           │                                                             │
│           ▼                                                             │
│    ┌──────────────────┐                                                 │
│    │  record_trade()  │  ← 거래 즉시 세션에 기록                         │
│    │                  │                                                 │
│    │  • stock_code    │                                                 │
│    │  • trade_type    │                                                 │
│    │  • profit_pct    │                                                 │
│    │  • is_success    │                                                 │
│    │  • holding_time  │                                                 │
│    │  • executed_at   │                                                 │
│    └────────┬─────────┘                                                 │
│             │                                                           │
│             ▼                                                           │
│    ┌──────────────────┐                                                 │
│    │ _session_trades  │  ← 메모리 내 리스트 (당일 거래)                  │
│    │      List        │                                                 │
│    └────────┬─────────┘                                                 │
│             │                                                           │
│                                                                         │
│  [2] 피드백 동기화 (5분마다 + 매 사이클 전)                              │
│  ─────────────────────────────────────────────────────────────────────  │
│             │                                                           │
│             ▼                                                           │
│    ┌───────────────────────────────────────────┐                        │
│    │  AegisScheduler.sync_feedback_context()  │                        │
│    │                                           │                        │
│    │  호출 시점:                               │                        │
│    │  • job_market_regime_check (5분마다)      │                        │
│    │  • job_auto_trading (30초마다)            │                        │
│    │  • job_intraday_analysis (AI 분석 전)     │                        │
│    └───────────────────┬───────────────────────┘                        │
│                        │                                                │
│                        ▼                                                │
│    ┌───────────────────────────────────────────┐                        │
│    │  GeminiAnalyzer.set_session_trades()     │                        │
│    │                                           │                        │
│    │  → Analyzer가 세션 거래 기록 수신         │                        │
│    └───────────────────┬───────────────────────┘                        │
│                        │                                                │
│                                                                         │
│  [3] AI 프롬프트에 피드백 주입                                           │
│  ─────────────────────────────────────────────────────────────────────  │
│                        │                                                │
│                        ▼                                                │
│    ┌───────────────────────────────────────────┐                        │
│    │  format_realtime_feedback()              │                        │
│    │                                           │                        │
│    │  세션 거래를 마크다운 텍스트로 변환        │                        │
│    │                                           │                        │
│    │  출력 예시:                               │                        │
│    │  ─────────────────────────                │                        │
│    │  ## 오늘 거래 피드백 (실시간)             │                        │
│    │                                           │                        │
│    │  ### 세션 요약                            │                        │
│    │  - 총 거래 횟수: 3건                      │                        │
│    │  - 승률: 66.7% (2승 / 1패)                │                        │
│    │  - 실현 손익: +45,200원                   │                        │
│    │                                           │                        │
│    │  ### 최근 거래 결과                       │                        │
│    │  1. 삼성전자 - 매도 +2.3%                 │                        │
│    │  2. SK하이닉스 - 매도 -1.2%               │                        │
│    │                                           │                        │
│    │  ### 즉각 적용 지침                       │                        │
│    │  - 연속 손실 → AI 점수 기준 상향          │                        │
│    └───────────────────┬───────────────────────┘                        │
│                        │                                                │
│                        ▼                                                │
│    ┌───────────────────────────────────────────┐                        │
│    │  create_markdown_report()                │                        │
│    │                                           │                        │
│    │  기본 프롬프트 + 피드백 컨텍스트 결합      │                        │
│    │                                           │                        │
│    │  → DeepSeek-V3 / Gemini에 전달            │                        │
│    └───────────────────────────────────────────┘                        │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 11.2 핵심 데이터 구조

```python
# ═══════════════════════════════════════════════════════════════
#              세션 거래 기록 (Session Trade Record)
# ═══════════════════════════════════════════════════════════════

trade_record = {
    "stock_code": "005930",           # 종목 코드
    "stock_name": "삼성전자",          # 종목명
    "trade_type": "SELL",             # BUY 또는 SELL
    "price": 72100,                   # 체결가
    "quantity": 10,                   # 수량
    "profit_pct": 3.0,                # 수익률 (%) - 매도 시만
    "is_success": True,               # 성공 여부 (profit > 0)
    "holding_time": 48.5,             # 보유 시간 (시간 단위)
    "realized_amount": 21630,         # 실현 손익 (원)
    "executed_at": datetime.now()     # 체결 시각
}
```

### 11.3 상황별 조정 규칙 (FEEDBACK_ADJUSTMENT_RULES)

```python
# ═══════════════════════════════════════════════════════════════
#              피드백 기반 자동 조정 규칙
# ═══════════════════════════════════════════════════════════════

FEEDBACK_ADJUSTMENT_RULES = {

    # 🔴 연속 손실 (2회 이상)
    "consecutive_loss": """
        - 연속 손실 발생 → 다음 매수 시 신중 검토
        - AI 점수 기준 임시 상향 (70 → 75)
        - 매수 금액 20% 축소 권장
    """,

    # 🟢 높은 승률 (70% 이상)
    "high_win_rate": """
        - 승률 양호 → 현재 전략 유지
        - 기존 매매 기준 그대로 적용
    """,

    # 🟡 큰 손실 발생 (-3% 이상)
    "large_loss": """
        - 큰 손실 발생 → 해당 종목/섹터 재검토
        - 동일 섹터 매수 당일 제한 권장
    """,

    # 🔵 빠른 이익 실현 (보유 < 2시간)
    "quick_profit": """
        - 단기 이익 실현 → 스캘핑 모드 활성화 고려
        - 유사 패턴 종목 우선 탐색
    """,

    # ⚪ 기본 (특이사항 없음)
    "default": """
        - 특별한 조정 없음
        - 기존 전략 유지
    """
}
```

### 11.4 동적 설정 조정 (get_feedback_adjusted_config)

```python
def get_feedback_adjusted_config(self) -> Dict[str, Any]:
    """
    피드백 기반 동적 설정 조정

    Returns:
        adjustments: 적용할 조정값 딕셔너리
    """
    adjustments = {}

    if not self._session_trades:
        return adjustments

    # 매도 거래만 필터링
    sell_trades = [t for t in self._session_trades if t['trade_type'] == 'SELL']

    if not sell_trades:
        return adjustments

    # 승/패 카운트
    wins = sum(1 for t in sell_trades if t.get('is_success', False))
    losses = len(sell_trades) - wins

    # ═══════════════════════════════════════════════════════════════
    #              연속 2회 이상 손실 시 → 보수적 전환
    # ═══════════════════════════════════════════════════════════════
    if losses >= 2 and wins == 0:
        adjustments['min_ai_score_boost'] = 5    # 70 → 75
        adjustments['buy_amount_multiplier'] = 0.8  # 20% 축소
        adjustments['mode'] = 'conservative'

    # ═══════════════════════════════════════════════════════════════
    #              승률 70% 이상 → 공격적 전환 가능
    # ═══════════════════════════════════════════════════════════════
    elif wins >= 3 and wins / len(sell_trades) >= 0.7:
        adjustments['mode'] = 'aggressive'
        adjustments['buy_amount_multiplier'] = 1.1  # 10% 증액

    return adjustments
```

### 11.5 피드백 포맷팅 예시

**입력 (세션 거래 기록)**:
```python
session_trades = [
    {"stock_name": "삼성전자", "trade_type": "SELL", "profit_pct": 2.5, "is_success": True},
    {"stock_name": "SK하이닉스", "trade_type": "SELL", "profit_pct": -1.2, "is_success": False},
    {"stock_name": "카카오", "trade_type": "BUY", "profit_pct": 0.0}
]
```

**출력 (AI 프롬프트에 주입되는 텍스트)**:
```markdown
## 오늘 거래 피드백 (실시간)

### 세션 요약
- **총 거래 횟수**: 3건
- **승률**: 50.0% (1승 / 1패)
- **실현 손익**: +9,100원 (+1.30%)

### 최근 거래 결과 (최신순)

**1. 카카오 (035720)** - 매수
   - 체결가: 52,300원
   - 수익률: +0.00%
   - 결과: → 매수 진입

**2. SK하이닉스 (000660)** - 매도
   - 체결가: 180,000원
   - 수익률: -1.20%
   - 결과: ✗ 소폭 손실

**3. 삼성전자 (005930)** - 매도
   - 체결가: 72,100원
   - 수익률: +2.50%
   - 결과: ✓ 수익 실현

### 오늘 배운 교훈
- SK하이닉스: 진입 타이밍 재검토 필요

### 즉각 적용 지침
- 특별한 조정 없음
- 기존 전략 유지
```

### 11.6 관련 파일 및 함수

| 파일 | 함수/클래스 | 역할 |
|-----|-----------|------|
| `brain/prompts.py` | `format_realtime_feedback()` | 세션 거래 → 마크다운 변환 |
| `brain/prompts.py` | `build_feedback_enhanced_prompt()` | 기본 프롬프트 + 피드백 결합 |
| `brain/prompts.py` | `REALTIME_FEEDBACK_TEMPLATE` | 피드백 템플릿 상수 |
| `brain/prompts.py` | `FEEDBACK_ADJUSTMENT_RULES` | 상황별 조정 규칙 |
| `brain/auto_trader.py` | `record_trade()` | 거래 결과 세션에 기록 |
| `brain/auto_trader.py` | `get_session_trades()` | 세션 거래 리스트 반환 |
| `brain/auto_trader.py` | `get_feedback_adjusted_config()` | 동적 설정 조정값 계산 |
| `brain/auto_trader.py` | `_session_trades` | 세션 거래 저장 리스트 |
| `brain/analyzer.py` | `set_session_trades()` | Analyzer에 세션 거래 전달 |
| `scheduler/main_scheduler.py` | `sync_feedback_context()` | AutoTrader → Analyzer 동기화 |

### 11.7 설정값 요약

```python
# ═══════════════════════════════════════════════════════════════
#              v2.8 실시간 피드백 시스템 설정값
# ═══════════════════════════════════════════════════════════════

# 피드백 동기화 시점
SYNC_POINTS = [
    "job_market_regime_check",   # 5분마다
    "job_auto_trading",          # 30초마다 (매매 전)
    "job_intraday_analysis"      # AI 분석 전
]

# 연속 손실 임계치
CONSECUTIVE_LOSS_THRESHOLD = 2   # 2회 연속 손실 시 보수 모드

# 보수 모드 조정값
CONSERVATIVE_SCORE_BOOST = 5     # MIN_SCORE +5 (70 → 75)
CONSERVATIVE_AMOUNT_MULT = 0.8   # 매수금액 20% 축소

# 공격 모드 조건
AGGRESSIVE_WIN_COUNT = 3         # 최소 3승
AGGRESSIVE_WIN_RATE = 0.7        # 승률 70% 이상

# 세션 리셋
SESSION_RESET_TIME = "08:30"     # 매일 08:30 세션 초기화
```

---

## 부록: 용어 정리

| 용어 | 설명 |
|-----|------|
| **Quant Score** | 수학적/통계적 지표 기반 점수 (수급, 기술적 분석) |
| **DeepSeek-V3 Score** | DeepSeek-V3가 맥락을 해석하여 산출한 점수 |
| **Final Score** | Quant×57% + DeepSeek-V3×43% 가중 평균 |
| **Circuit Breaker** | 손실 한도 초과 시 자동 거래 중단 장치 |
| **Trailing Stop** | 고점 추적 손절 (이익 극대화 전략) |
| **오버행** | 대량 매도 대기 물량 (주가 하락 압력) |
| **양매수** | 외국인 + 기관 동시 순매수 |
| **Source of Truth** | 단일 진실 공급원 (DB를 유일한 데이터 소스로) |
| **Bull Scenario** | 낙관적 시나리오 (상승 전망) |
| **Base Scenario** | 기본 시나리오 (현재 추세 유지) |
| **Bear Scenario** | 비관적 시나리오 (하락 전망) |
| **R/R Ratio** | Risk/Reward Ratio (리스크 대비 수익 비율) |
| **TradeFeedback** | 매도 후 생성되는 피드백 데이터 구조 |
| **Post-Trade Validation** | 매도 직후 거래 결과 검증 프로세스 |
| **Dynamic Adjustment** | 피드백 기반 점수/가중치 동적 조정 |
| **Opus 4.5 Commander** | 최종 의사결정 AI (매수/매도/리밸런싱 결정) |
| **OpusContext** | Opus 4.5에게 전달되는 실시간 컨텍스트 데이터 |
| **Blacklist** | 재매수 금지 종목 목록 (손절 후 24시간) |
| **ANALYST Layer** | DeepSeek-V3, Gemini Flash, Quant 분석 계층 |
| **DATA Layer** | KRX, KIS API, DART 등 데이터 수집 계층 |
| **Session Trades** | 당일 세션 내 모든 거래 기록 (메모리 저장) |
| **Realtime Feedback** | 매도 즉시 다음 매수에 반영되는 피드백 시스템 |
| **sync_feedback_context** | AutoTrader → Analyzer 피드백 동기화 함수 |
| **record_trade** | 거래 결과를 세션에 기록하는 함수 |
| **Conservative Mode** | 연속 손실 시 활성화되는 보수적 매매 모드 |
| **Aggressive Mode** | 고승률 시 활성화되는 공격적 매매 모드 |
| **FEEDBACK_ADJUSTMENT_RULES** | 상황별 AI 지침 규칙 상수 |
