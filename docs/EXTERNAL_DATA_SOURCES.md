# AEGIS v2.0 - 외부 데이터 소스 목록

> 시스템에서 가져오는 모든 외부 데이터 정리

---

## 1. 글로벌 시장 데이터 (yfinance)

### 1.1 환율/통화

| 티커 | 데이터명 | 중요도 | 해석 |
|------|----------|--------|------|
| `DX-Y.NYB` | 달러 인덱스 | ⭐⭐⭐ | 글로벌 유동성 흐름. 104 이상 → 지수 하방 압력 |
| `KRW=X` | 원/달러 환율 | ⭐⭐⭐ | 수출주/외국인 수급 |
| `CNH=X` | 달러/위안화 (역외) | ⭐⭐⭐⭐⭐ | **외국인 수급 선행지표.** 위안화 약세 → 외국인 한국 매도 |
| `JPYKRW=X` | 엔/원 환율 (100엔당) | ⭐⭐⭐⭐ | **자동차/철강 경쟁력.** 엔저 → 현대차, POSCO 악재 |

> 💡 **위안화(CNH)**: 외국인은 한국을 "중국 경제의 대리인(Proxy)"으로 봄
> 💡 **엔화(JPY)**: "현대차 주가가 왜 안 가지?" → 엔화 환율 확인

### 1.2 변동성/공포 지표

| 티커 | 데이터명 | 중요도 | 해석 |
|------|----------|--------|------|
| `^VIX` | VIX 공포지수 | ⭐⭐⭐ | 단기 변동성/위험 회피 |
| `^VIX1M` | VIX 1개월 선물 | ⭐⭐ | 변동성 기간 구조 |
| `VIXY` | VIX ETF | ⭐⭐ | VIX 추종 |
| `^MOVE` | MOVE Index | ⭐⭐⭐ | 채권 공포지수. 스파이크 → 위험회피 |
| `^TNX` | 미국 10년물 국채 금리 | ⭐⭐⭐ | 외국인 수급 신호등. 금리 급등 → 외국인 매도 |
| `HYG` | 하이일드 채권 ETF | ⭐⭐⭐ | **"탄광 속 카나리아"** HYG↓ → 신흥국 자금 이탈 |

> 💡 **HYG**: 나스닥이 올라도 HYG가 떨어지면 '가짜 상승'일 확률 높음

### 1.3 미국 지수 & 선물

| 티커 | 데이터명 | 용도 |
|------|----------|------|
| `^GSPC` | S&P 500 | 글로벌 위험선호도 |
| `^IXIC` | 나스닥 종합 | 기술주 심리 |
| `^DJI` | 다우존스 | 경기 민감 섹터 |
| `^RUT` | 러셀 2000 | 중소형주 심리 |
| `ES=F` | S&P 500 선물 | 장외 선물 방향 |
| `NQ=F` | 나스닥 100 선물 | 기술주 선물 방향 |

### 1.4 반도체 섹터

| 티커 | 데이터명 | 한국 연동 |
|------|----------|-----------|
| `^SOX` | 필라델피아 반도체 지수 | ⭐⭐⭐ 삼성전자/하이닉스 시초가. SOX↑ → 갭상승 80% |
| `^TWII` | 대만 가권지수 | IT/반도체 섹터 |
| `MU` | 마이크론 | 삼성전자, SK하이닉스 쌍둥이 |
| `AMD` | AMD | SK하이닉스 (HBM) |
| `TSM` | TSMC ADR | 삼성전자, DB하이텍 |
| `ASML` | ASML Holding | 반도체 장비 |
| `NVDA` | 엔비디아 | AI/반도체 심리 |

### 1.5 2차전지/에너지

| 티커 | 데이터명 | 한국 연동 |
|------|----------|-----------|
| `LIT` | 리튬 & 배터리 ETF | ⭐⭐⭐⭐ LG에너지솔루션, 에코프로비엠 |
| `ALB` | 앨버말 (리튬) | 포스코퓨처엠, 에코프로 |
| `TSLA` | 테슬라 | 2차전지/자동차 |
| `ETN` | 이튼 (전력) | LS일렉트릭, 효성중공업 |
| `GEV` | GE Vernova | 두산에너빌리티 |
| `URA` | 우라늄 ETF | 원전 테마 |

### 1.6 방산

| 티커 | 데이터명 | 한국 연동 |
|------|----------|-----------|
| `LMT` | 록히드마틴 | 한화에어로스페이스 |
| `RTX` | RTX (레이시온) | LIG넥스원 |
| `RNMBF` / `RHM.DE` | 라인메탈 | 방산 섹터 |

### 1.7 조선/해운

| 티커 | 데이터명 | 한국 연동 |
|------|----------|-----------|
| `BDRY` | 건화물 운임 ETF | ⭐⭐⭐⭐ **BDI 대용.** HD한국조선해양, HMM 직결 |

### 1.8 원자재

| 티커 | 데이터명 | 영향 섹터 |
|------|----------|----------|
| `CL=F` | WTI 원유 선물 | 정유/화학 |
| `BZ=F` | 브렌트유 선물 | 정유/화학 |
| `HG=F` | 구리 선물 | 경기 선행/전기차 |
| `GC=F` | 금 선물 | 안전자산/인플레이션 |

### 1.9 미국 섹터 ETF

| 티커 | 섹터 | 한국 연동 |
|------|------|----------|
| `XLK` | Technology | 삼성전자, SK하이닉스, 네이버 |
| `XLF` | Financials | KB금융, 신한지주 |
| `XLE` | Energy | SK이노베이션, S-Oil |
| `XLV` | Healthcare | 삼성바이오, 셀트리온 |
| `XLY` | Consumer Discretionary | 현대차, 기아 |
| `XLI` | Industrials | 현대중공업, 삼성중공업 |
| `XLB` | Materials | POSCO, 롯데케미칼 |
| `XLRE` | Real Estate | 리츠 관련주 |

### 1.10 국가/지역 ETF

| 티커 | 데이터명 | 한국 영향 |
|------|----------|-----------|
| `EWY` | MSCI 한국 ETF | ⭐⭐⭐ 야간 선물 대용. EWY↑ → KOSPI 시초가↑ |
| `FXI` | 중국 A50 ETF | 중국 경기 → 한국 수출주 |
| `KSA` | 사우디 ETF | 건설/플랜트 |
| `INDA` | 인도 ETF | 신흥국 소비재 |
| `VNM` | 베트남 ETF | 베트남 진출 기업 |

### 1.11 M7 빅테크

| 티커 | 데이터명 | 영향 |
|------|----------|------|
| `NVDA` | 엔비디아 | AI/반도체 심리 |
| `TSLA` | 테슬라 | 2차전지/자동차 |
| `AAPL` | 애플 | IT 하드웨어 |
| `MSFT` | 마이크로소프트 | 클라우드/AI |
| `GOOGL` | 구글 | 플랫폼/광고 |
| `META` | 메타 | 메타버스/광고 |
| `AMZN` | 아마존 | 이커머스/클라우드 |

### 1.12 한국 ADR

| 티커 | 데이터명 | 원주 |
|------|----------|------|
| `PKX` | POSCO ADR | POSCO홀딩스 |
| `CPNG` | 쿠팡 | 쿠팡 |
| `KB` | KB금융 ADR | KB금융 |
| `SHG` | 신한금융 ADR | 신한지주 |
| `WF` | 우리금융 ADR | 우리금융 |
| `LPL` | LG Display ADR | LG디스플레이 |

### 1.13 기타 글로벌

| 티커 | 데이터명 | 해석 |
|------|----------|------|
| `NVO` | 노보노디스크 ADR | 바이오/제약 |
| `BTC-USD` | 비트코인 | 위험선호도/유동성 지표 |

---

## 2. 한국 시장 데이터 (pykrx)

### 2.1 종목 데이터

| 데이터 | 설명 | 용도 |
|--------|------|------|
| 일별 OHLCV | 시가/고가/저가/종가/거래량 | 가격 분석 |
| 투자자별 순매수 | 외국인/기관/개인 | 수급 분석 |
| 펀더멘탈 | PER, PBR, 시가총액 | 밸류에이션 |
| 대차잔고 | 공매도 잔고 | 오버행 리스크 |

### 2.2 투자자 세분화

| 투자자 | 설명 |
|--------|------|
| 외국인 | 외국인 투자자 순매수 |
| 기관 | 기관 투자자 총합 |
| 연기금 | 국민연금, 공무원연금 등 |
| 금융투자 | 증권사 |
| 투신 | 자산운용사 |
| 보험 | 보험사 |
| 기타법인 | 일반 법인 |

---

## 3. 한국투자증권 API (KIS)

### 3.1 시세 데이터

| API | 설명 | 용도 |
|-----|------|------|
| `FHKUP03500100` | KOSPI200 현물 시세 | 베이시스 계산 |
| `FHKIF03010200` | KOSPI200 선물 시세 | 베이시스 계산 |
| `FHKIF03020100` | 선물옵션 투자자별 매매동향 | ⭐⭐⭐⭐⭐ **외국인 선물 누적 순매수** (웩더독 현상 주범) |
| `FHKST01010600` | 프로그램 매매 동향 | ⭐⭐⭐⭐⭐ **프로그램 비차익 순매수** (메이저 세력의 진짜 바구니) |

### 3.2 계좌 API

| 기능 | 설명 |
|------|------|
| 예수금 조회 | 가용 자금 확인 |
| 보유 종목 | 포트폴리오 현황 |
| 주문 체결 | 자동 매매 |
| 거래 내역 | 실현 손익 |

---

## 3.3 🇰🇷 한국 시장 특화 핵심 학습 지표 Top 5

> **"한국 시장의 수급 논리"를 AI에게 학습시키는 결정적 지표**

### 순위 1️⃣: 외국인 선물 누적 순매수 ⭐⭐⭐⭐⭐

**중요도**: 최상

**AI 학습 포인트**: "웩더독(Wag the dog) 현상의 주범"

한국장은 외국인이 선물을 대량 매수하면 → 기관이 프로그램으로 현물을 사게 되어 있습니다.
당일 순매수뿐만 아니라 **'누적' 포지션의 변곡점이 지수 방향을 결정**합니다.

- **데이터 소스**: KIS API (`FHKIF03020100`)
- **업데이트 주기**: 실시간
- **AI 학습 공식**:
  ```
  IF 외국인 선물 누적 순매수 > +5,000계약:
      → 기관 프로그램 매수 유입 예상
      → KOSPI 200 대형주 매수 비중 확대
  ```

### 순위 2️⃣: 프로그램 비차익 순매수 ⭐⭐⭐⭐⭐

**중요도**: 최상

**AI 학습 포인트**: "메이저 세력의 진짜 바구니"

기관/외국인이 바스켓(묶음)으로 주식을 살 때 **'비차익' 거래**를 씁니다.
지수가 오르는데 비차익이 마이너스라면 그 상승은 **'가짜(속임수)'**일 확률이 90% 이상입니다.

- **데이터 소스**: KIS API (`FHKST01010600`)
- **업데이트 주기**: 실시간
- **AI 학습 공식**:
  ```
  IF KOSPI 상승 중 AND 프로그램 비차익 < 0:
      → "개인만 사고 있는 껍데기 상승"
      → 추격 매수 금지 (Hold/Sell)
      → trap_type: "fake_rise"
  ```

### 순위 3️⃣: 시장 베이시스 (Basis) ⭐⭐⭐⭐

**중요도**: 상

**AI 학습 포인트**: "선물과 현물의 가격 차이"

베이시스가 양수(콘탱고)면 프로그램 매수가 들어오고, 음수(백워데이션)면 매도 폭탄이 쏟아집니다.
AI가 **"오늘은 프로그램이 들어올 날인지"** 판단하는 핵심 근거입니다.

- **데이터 소스**: KIS API (선물 시세 - 현물 지수)
  - 현물: `FHKUP03500100` (KOSPI200 현물)
  - 선물: `FHKIF03010200` (KOSPI200 선물)
- **계산식**: `Basis = 선물가격 - 현물지수 × 배수(25만원)`
- **업데이트 주기**: 실시간
- **AI 학습 공식**:
  ```
  IF Basis > 5포인트 (콘탱고):
      → 프로그램 매수 유입 예상
      → 지수 상승 국면
  ELSE IF Basis < -5포인트 (백워데이션):
      → 프로그램 매도 폭탄
      → 지수 하락 국면
  ```

### 순위 4️⃣: 신용융자 잔고율 추이 ⭐⭐⭐⭐

**중요도**: 상

**AI 학습 포인트**: "개미 무덤 판독기"

주가는 하락하는데 신용잔고가 줄지 않고 버티고 있다면, 조만간 **'반대매매(투매)'**가 나와 폭락할 징조입니다.
한국의 높은 개인 비중 때문에 발생하는 고유 특성입니다.

- **데이터 소스**:
  - 금융투자협회 (KOFIA) - 웹 스크래핑
  - 네이버 금융 - 종목별 신용잔고율
- **업데이트 주기**: 일 1회 (장 마감 후)
- **AI 학습 공식**:
  ```
  IF 주가 < 20일 이평선 AND 신용잔고율 > 역대 최고치:
      → "반대매매 물량 출회 임박"
      → 전량 매도 및 현금화 (Emergency Exit)
      → trap_type: "margin_call_imminent"
  ```

### 순위 5️⃣: 대차잔고 증감 ⭐⭐⭐

**중요도**: 중

**AI 학습 포인트**: "공매도 대기 물량"

(공매도가 금지된 시기라도) 대차잔고가 급증하는 종목은 외국인/기관이 **"하락에 베팅하고 있다"**는 가장 강력한 선행 신호입니다.
주가 상승의 천장을 막는 역할을 합니다.

- **데이터 소스**:
  - pykrx (`stock.get_shorting_status_by_ticker()`)
  - KIS API (종목별 대차잔고)
- **업데이트 주기**: 일 1회
- **AI 학습 공식**:
  ```
  IF 대차잔고 전일 대비 +50% 이상 증가:
      → "외국인/기관의 하락 베팅"
      → 상승 시 매도벽 작용
      → trap_type: "short_selling_pressure"
  ```

---

### 🧠 한국 시장 수급 논리 학습 공식

위 5가지 데이터를 통해 AI가 학습해야 할 **인과관계**:

#### 1. 선물 주도 패턴
```python
if (foreign_futures_net > 5000 and basis > 5):
    signal = "BUY"
    reason = "외국인 선물 매수 + 베이시스 호전 → 기관 프로그램 매수 유입 예상"
    target_sector = "KOSPI 200 대형주"
```

#### 2. 가짜 상승 필터링
```python
if (kospi_change > 0 and program_non_arbitrage < 0):
    signal = "AVOID"
    reason = "지수 상승 중이나 프로그램 비차익 순매도 → 개인만 사고 있는 껍데기 상승"
    trap_type = "fake_rise"
```

#### 3. 폭락 전조 감지
```python
if (price < ma20 and margin_debt_ratio >= historical_max):
    signal = "EMERGENCY_EXIT"
    reason = "주가 20일선 이탈 + 신용잔고율 역대 최고 → 반대매매 투매 임박"
    action = "전량 매도 및 현금화"
```

#### 4. 공매도 압력 감지
```python
if (short_balance_change_pct > 50):
    signal = "CAUTION"
    reason = "대차잔고 급증 → 외국인/기관 하락 베팅 → 상승 천장 형성"
    recommendation = "상승 시 익절 or 보유 축소"
```

---

## 4. DART 공시 API

### 4.1 엔드포인트

| 엔드포인트 | 설명 | 용도 |
|------------|------|------|
| `/list` | 최근 공시 목록 | 실시간 신호 포착 |
| `/company` | 기업 기본 정보 | 종목 정보 |
| `/fnlttSinglAcnt` | 재무제표 | 펀더멘탈 분석 |
| `corpCode.xml` | DART 고유번호 | 종목 코드 매핑 |

### 4.2 공시 신호 키워드

| 구분 | 키워드 |
|------|--------|
| **호재** | 공급계약, 판매계약, 수주, 무상증자, 자사주취득, 제3자배정(대기업/VC) |
| **악재** | 유상증자(주주배정/일반공모), CB/BW 발행, 추가상장, 불성실공시, 횡령, 배임 |

---

## 5. 웹 스크래핑

### 5.1 네이버 금융

| URL | 데이터 | 인코딩 |
|-----|--------|--------|
| `finance.naver.com/sise/theme.naver` | 시장 테마 | EUC-KR |
| `finance.naver.com/item/main.naver` | 컨센서스/목표가 | EUC-KR |
| `finance.naver.com/item/coinfo.naver` | 기업 정보 | EUC-KR |
| `finance.naver.com/item/news.naver` | 종목 뉴스 | EUC-KR |

### 5.2 기타 소스

| 소스 | 데이터 |
|------|--------|
| Google News RSS | `news.google.com/rss/search?q={query}&hl=ko&gl=KR&ceid=KR:ko` |
| CNN Fear & Greed | `production.dataviz.cnn.io/index/fearandgreed/graphdata` |
| 관세청 (뉴스 검색) | 수출입 현황 |
| 금융투자협회 (KOFIA) | 신용잔고/예탁금 |
| Investing.com | CDS 프리미엄 |

---

## 6. 경제 캘린더

### 6.1 주요 이벤트

| 이벤트 | 주기 | 영향 |
|--------|------|------|
| FOMC 회의 | 6주 | 금리 방향 |
| 미국 고용보고서 (NFP) | 매월 첫째 금요일 | 경기 판단 |
| 미국 CPI | 매월 중순 | 인플레이션 |
| 삼중 위칭데이 | 분기별 | 변동성 급증 |
| VIX 옵션 만기 | 매월 | 변동성 리셋 |

### 6.2 글로벌 경기 지표

| 지표 | 발표 국가 | 용도 |
|------|-----------|------|
| ISM PMI | 미국 | 제조업 경기 |
| Caixin PMI | 중국 | 수출 영향 |
| 유로존 PMI | 유럽 | 글로벌 경기 |
| 독일 IFO | 독일 | 유럽 경기 선행 |

---

## 7. 한국 수출 모니터링 섹터

| 섹터 | 관련 종목 |
|------|----------|
| 반도체 | 삼성전자, SK하이닉스 |
| 자동차 | 현대차, 기아 |
| 2차전지 | LG에너지솔루션, 삼성SDI |
| 석유화학 | LG화학, 롯데케미칼 |
| 조선 | HD한국조선해양, 삼성중공업 |

---

## 8. 데이터 수집 주기

| 카테고리 | 주기 | 메모 |
|----------|------|------|
| 미국 선물/지수 | 실시간 ~ 15분 | 장중 |
| 한국 투자자 수급 | 일 1회 | 장 마감 후 |
| DART 공시 | 5분 | 실시간 모니터링 |
| 네이버 테마 | 15분 | 캐시 |
| 경제 캘린더 | 주 1회 | 정적 |

---

## 9. 환경 변수

```bash
# 한국투자증권
KIS_APP_KEY=...
KIS_APP_SECRET=...
KIS_ACCOUNT_NUMBER=...

# DART 공시
DART_API_KEY=...

# AI (DeepSeek)
DEEPSEEK_API_KEY=...
```

---

## 10. 🔄 Fetcher 역할 분담

### 10.1 KIS Fetcher (`fetchers/kis_fetcher.py`)

**담당 데이터**:
- ✅ 외국인 선물 누적 순매수 (`FHKIF03020100`)
- ✅ 프로그램 비차익 순매수 (`FHKST01010600`)
- ✅ 베이시스 계산 (`FHKUP03500100` + `FHKIF03010200`)
- ✅ 계좌 정보 (예수금, 보유 종목, 주문 체결)
- ✅ 실시간 시세 (종목별 현재가)

**수집 주기**:
- 실시간: WebSocket 연결 (선물/프로그램/베이시스)
- 5초~1분: REST API 폴링 (백업)

**부담 수준**: ⭐⭐⭐ (중간) - WebSocket으로 효율적 처리 가능

---

### 10.2 Stock Fetcher (`fetchers/stock_fetcher.py`)

**담당 데이터**:
- ✅ pykrx 종목 데이터 (OHLCV, 투자자별 순매수)
- ✅ 대차잔고 증감 (pykrx `get_shorting_status_by_ticker()`)
- ✅ 펀더멘탈 (PER, PBR, 시가총액)

**수집 주기**:
- 일 1회 (장 마감 후)

**부담 수준**: ⭐⭐ (낮음) - 일 1회만 실행, 캐싱 활용

---

### 10.3 Market Data Fetcher (신규 필요)

**담당 데이터**:
- ⚠️ **신용융자 잔고율** (금융투자협회/네이버 웹 스크래핑)
- ⚠️ 시장 지수 (KOSPI, KOSDAQ, KOSPI200)
- ⚠️ 섹터 지수 (반도체, 자동차, 2차전지 등)

**수집 주기**:
- 일 1회 (신용잔고)
- 실시간 (지수/섹터)

**부담 수준**: ⭐⭐ (낮음) - 웹 스크래핑은 캐싱 활용

---

### 10.4 Global Market Fetcher (`fetchers/global_fetcher.py`)

**담당 데이터**:
- ✅ yfinance 글로벌 지표 (환율, VIX, 미국 지수, 반도체 섹터)
- ✅ 미국 선물 (ES=F, NQ=F)
- ✅ 원자재 (원유, 구리, 금)

**수집 주기**:
- 15분 (장중)
- 1시간 (장 마감 후)

**부담 수준**: ⭐⭐ (낮음) - yfinance는 무료, 캐싱 활용

---

### 10.5 DART Fetcher (`fetchers/dart_fetcher.py`)

**담당 데이터**:
- ✅ 공시 목록 (`/list`)
- ✅ 재무제표 (`/fnlttSinglAcnt`)
- ⚠️ CB/BW 상장 예정일 (공시 파싱)

**수집 주기**:
- 5분 (공시 목록)
- 요청 시 (재무제표)

**부담 수준**: ⭐ (매우 낮음) - API 호출 제한 내에서 충분

---

### 10.6 총 Fetcher 부담 평가

| Fetcher | 데이터 개수 | 실시간 여부 | 부담 수준 | 비고 |
|---------|------------|------------|----------|------|
| KIS Fetcher | 5개 핵심 지표 | ✅ 실시간 | ⭐⭐⭐ | WebSocket으로 효율화 |
| Stock Fetcher | 3개 지표 | ❌ 일 1회 | ⭐⭐ | 캐싱 활용 |
| Market Data Fetcher | 2개 지표 | ⚠️ 혼합 | ⭐⭐ | 웹 스크래핑 필요 |
| Global Fetcher | 40+ 지표 | ❌ 15분 | ⭐⭐ | yfinance 무료 |
| DART Fetcher | 공시 | ❌ 5분 | ⭐ | API 제한 여유 |

**결론**: ✅ **Fetcher가 충분히 감당 가능**

- 실시간 데이터는 WebSocket으로 효율적 처리
- 일별 데이터는 캐싱으로 부하 최소화
- 한국 시장 특화 지표 5개는 기존 KIS/Stock Fetcher로 대부분 커버

---

### 10.7 신규 구현 필요 항목

#### 🆕 Market Data Fetcher 생성
```python
# fetchers/market_fetcher.py (신규)

class MarketFetcher:
    """
    한국 시장 지수 및 신용잔고 수집
    """

    async def fetch_margin_debt_ratio(self, stock_code: str) -> float:
        """
        신용융자 잔고율 조회 (네이버 금융)

        Returns:
            신용잔고율 (%)
        """
        pass

    async def fetch_kospi_status(self) -> Dict:
        """
        KOSPI 지수 현황

        Returns:
            {
                'index': 2500.0,
                'change_pct': 1.2,
                'volume': 500000000
            }
        """
        pass
```

#### 🔧 KIS Fetcher 확장
```python
# fetchers/kis_fetcher.py (수정)

async def fetch_futures_net_buy(self) -> Dict:
    """
    외국인 선물 누적 순매수 (FHKIF03020100)

    Returns:
        {
            'foreign_net': 5200,  # 계약 수
            'inst_net': -1500,
            'individual_net': -3700
        }
    """
    pass

async def fetch_program_trading(self) -> Dict:
    """
    프로그램 비차익 순매수 (FHKST01010600)

    Returns:
        {
            'arbitrage_net': 1200,  # 억원
            'non_arbitrage_net': -850,  # 비차익 (핵심!)
            'total_net': 350
        }
    """
    pass

async def calculate_basis(self) -> float:
    """
    시장 베이시스 계산

    Returns:
        베이시스 포인트 (예: 5.2)
    """
    futures_price = await self.fetch_kospi200_futures()
    spot_index = await self.fetch_kospi200_spot()
    basis = futures_price - (spot_index * 250000 / 100)
    return basis
```

---

*Last Updated: 2025-12-09*
