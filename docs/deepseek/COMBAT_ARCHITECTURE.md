# AEGIS Combat Architecture v3.1

## 개요
AEGIS(Advanced Equity Guardian & Intelligent System) Combat Architecture는 실전 매매 운영을 위한 이벤트 기반 고성능 트레이딩 시스템 구조입니다. 본 문서는 실전 운영 관점에서 시스템의 설계, 운영 지표, 장애 대응 시나리오를 명시합니다.

**구현 상태 표기 규칙**:
- ✅ 구현완료 (Production 운영 중)
- ⚠️ 부분구현 (Staging 테스트 중)
- ❌ 미구현 (Backlog)

---

## 1. 핵심 아키텍처 구성 요소

### 1.1 Opus 세션 제약 모델 (✅ 구현완료)
**특징**: Stateless API 아키텍처 기반의 상태 관리
- **Context Injection**: 모든 세션 시작 시 Redis Cache(실시간) + PostgreSQL(영구)에서 상태 로드
- **세션 타임아웃**: 3분 (실시간 시장 대응을 위한 제한)
- **상태 저장 주기**: 10초마다 증분 저장, 세션 종료 시 전체 저장

### 1.2 AI 역할 분담 체계 (✅ 구현완료)
| 역할 | 모델 | 주요 책임 | 응답시간 목표 |
|------|------|-----------|---------------|
| **분석관** | deepseek-v3 | 시장 데이터 분석, 패턴 식별, 위험 평가 | < 2초 |
| **검증관** | deepseek-r1 | 전략 논리 검증, 리스크 확인, 거부권 행사 | < 1.5초 |
| **지휘관** | opus | 최종 결정, 주문 실행, 포지션 관리 | < 1초 |

### 1.3 이벤트 기반 매매 트리거 (✅ 구현완료)
**이벤트 소스**:
- 시장 데이터 웹소켓 (실시간 가격, 거래량)
- 경제 지표 API (예약 이벤트)
- 뉴스 피드 (자연어 처리 트리거)
- 시스템 모니터링 (자체 상태 이벤트)

---

## 2. 실시간 처리 흐름도

```mermaid
sequenceDiagram
    participant M as Market Event
    participant I as Input Gateway
    participant C as Context Loader
    participant A as 분석관(deepseek-v3)
    participant V as 검증관(deepseek-r1)
    participant O as 지휘관(opus)
    participant E as Execution Engine
    participant D as DB/Cache
    
    M->>I: 시장 이벤트 발생
    I->>C: 이벤트 컨텍스트화
    C->>D: 상태 조회 (Redis → PostgreSQL)
    D-->>C: 컨텍스트 응답
    C->>A: 분석 요청 with Context
    A->>V: 분석 결과 전달
    V->>O: 검증 완료 보고
    O->>E: 실행 명령
    E->>D: 상태 업데이트
    E->>I: 결과 피드백
    
    Note over A,V,O: 병렬 검증 모드: 분석과 동시에 검증관이 독립 검증


**흐름 제어 조건**:
- 단계별 타임아웃 초과 시 즉시 실패 처리
- 검증관 거부 시 즉시 중단 (에스컬레이션 없음)
- 연속 3회 실패 시 해당 전투태세로 자동 전환

---

## 3. 전투 태세별 운영 전략

### 3.1 공세 태세 (Offensive Mode) ⚠️ 부분구현
**활성 조건**: VIX < 15, 시장 변동성 낮음, 추세 강함
- **진입 크기**: 자본금의 2.5%
- **손절 수준**: -1.5%
- **익절 목표**: +3.0%
- **최대 보유 포지션**: 5개
- **주문 유형**: 리밋 오더 70%, 마켓 오더 30%

### 3.2 게릴라 태세 (Guerrilla Mode) ✅ 구현완료
**활성 조건**: VIX 15-25, 중간 변동성, 횡보장
- **진입 크기**: 자본금의 2.0%
- **손절 수준**: -1.2%
- **익절 목표**: +2.4%
- **최대 보유 포지션**: 3개
- **주문 유형**: 리밋 오더 90%, 마켓 오더 10%

### 3.3 방어 태세 (Defensive Mode) ✅ 구현완료
**활성 조건**: VIX > 25, 고변동성, 하락장
- **진입 크기**: 자본금의 1.5%
- **손절 수준**: -0.8%
- **익절 목표**: +1.8%
- **최대 보유 포지션**: 2개
- **주문 유형**: 리밋 오더 100%

**태세 전환 로직**:
- 자동: 지표 기반 30분마다 평가
- 수동: 운영자 개입 가능
- 긴급: 연속 3회 손절 시 방어 태세 강제 전환

---

## 4. 장애 대응 시나리오

### 4.1 API 장애 대응 (✅ 구현완료)
**증상**: 외부 API 응답 지연/실패

1차 대응 (5초 내):
  - 페일오버: 예비 API 엔드포인트 자동 전환
  - 캐시 데이터 활용: 최신 30초 데이터로 제한적 운영

2차 대응 (30초 경과):
  - '제한 모드' 전환: 신규 진입 중단, 기존 포지션만 관리
  - 알림 트리거: 운영팀 SMS/Email

3차 대응 (5분 경과):
  - '안전 모드' 전환: 모든 포지션 청산 시작
  - 시스템 로그 보존 및 상태 스냅샷


### 4.2 네트워크 단절 대응 (⚠️ 부분구현)
**증상**: 데이터 피드 끊김, 지연 증가

- 3초 이내 재연결 시: 정상 운영
- 3-10초 단절: 캐시 데이터로 분석 지속
- 10초 초과: 모든 주문 취소, 청산 프로세스 시작
- 30초 초과: 완전 셧다운


### 4.3 데이터 불일치 대응 (✅ 구현완료)
**증상**: 브로커 API 데이터 vs 시장 데이터 불일치

- 0.5% 미만 차이: 무시 및 계속 운영
- 0.5-2% 차이: 검증관 추가 확인 요청
- 2% 초과 차이: 즉시 거래 중단, 수동 확인 요청


---

## 5. 성능 지표 목표치

### 5.1 응답 시간 목표 (SLA)
| 단계 | 목표치 | 경고 임계치 | 위험 임계치 |
|------|--------|-------------|-------------|
| 이벤트 감지 → 분석 시작 | < 50ms | 100ms | 200ms |
| 분석 완료 | < 2,000ms | 3,000ms | 5,000ms |
| 검증 완료 | < 1,500ms | 2,500ms | 4,000ms |
| 실행 명령 → 주문 접수 | < 500ms | 1,000ms | 2,000ms |
| **전체 사이클** | **< 4초** | **6초** | **10초** |

### 5.2 처리량 목표
- **동시 처리 이벤트**: 최대 50개/초
- **일간 분석 결정**: 10,000건
- **주문 처리량**: 200건/분
- **데이터 수집**: 1,000종목/초

### 5.3 정확도 목표
- **분석 예측 정확도**: > 65% (7일 이동 평균)
- **거부 적중률** (검증관): > 80%
- **실행 성공률**: > 99.5%

---

## 6. 모니터링 및 알림 체계

### 6.1 실시간 모니터링 대시보드
**포함 지표**:
- 시스템 건강도 (CPU, 메모리, 네트워크)
- 응답 시간 분포 (P50, P95, P99)
- 주문 실행 성공률
- 포지션 PnL 실시간
- AI 모델 신뢰도 점수

### 6.2 알림 조건 및 에스컬레이션

| 수준 | 조건 | 알림 채널 | 응답 요구 시간 |
|------|------|------------|----------------|
| **정보** | - 태세 전환<br>- 일일 목표 80% 달성 | 슬랙 #알림 | 24시간 내 확인 |
| **경고** | - 응답시간 SLA 2회 연속 위반<br>- 단일 포지션 -2% 손실 | 슬랙 #긴급 + Email | 1시간 내 조치 |
| **위험** | - 시스템 연속 3회 오류<br>- 분당 손실 한도 초과 | SMS + 전화 + Email | 10분 내 즉시 조치 |
| **심각** | - 자본금 5% 이상 손실<br>- 데이터 무결성 위반 | SMS 연속 3회 + 전화 콜백 | 즉시 시스템 정지 |

### 6.3 에스컬레이션 매트릭스

1차 담당자 (트레이딩 엔지니어)
  ↓ 5분 내 응답 없음
2차 담당자 (시스템 아키텍트)
  ↓ 10분 내 응답 없음
3차 담당자 (투자 책임자 + CTO)
  ↓ 15분 내 응답 없음
긴급 대응팀 (전원 집합)


---

## 7. 운영 체크리스트

### 7.1 시전 전 점검 (일일)
- [ ] API 키 유효성 확인 (브로커, 데이터)
- [ ] 시스템 건강도 점검
- [ ] 일일 한도 설정 확인
- [ ] 백업 시스템 상태 확인

### 7.2 시전 중 모니터링
- [ ] 10분마다 응답 시간 로그 확인
- [ ] 30분마다 PnL 현황 점검
- [ ] 시간당 성공률 계산
- [ ] 이상 패턴 자동 감지 시스템 가동

### 7.3 시전 후 정리
- [ ] 미체결 주문 정리
- [ ] 로그 파일 보관
- [ ] 성과 보고서 자동 생성
- [ ] 다음 거래일 준비 상태 확인

---

## 8. 구현 상태 종합

| 구성 요소 | 구현 상태 | 운영 시작일 | 마지막 검증일 |
|-----------|-----------|-------------|----------------|
| Opus 세션 관리 | ✅ | 2024.01.15 | 2024.05.20 |
| AI 역할 분담 | ✅ | 2024.02.10 | 2024.05.20 |
| 이벤트 기반 트리거 | ✅ | 2024.03.05 | 2024.05.19 |
| 전투 태세 시스템 | ⚠️ | 2024.04.12 | 2024.05.18 |
| 장애 대응 프레임워크 | ⚠️ | 2024.04.25 | 2024.05.17 |
| 모니터링 체계 | ✅ | 2024.03.30 | 2024.05.20 |
| 백테스트 환경 | ❌ | - | - |

---

## 결론
AEGIS Combat Architecture v3.1은 실전 운영 안정성과 신속한 시장 대응을 동시에 달성하기 위한 이벤트 기반 고성능 시스템입니다. 본 문서에 명시된 성능 지표, 장애 대응 시나리오, 모니터링 체계를 기반으로 지속적인 운영 개선이 이루어져야 합니다.

**문서 관리 정보**:
- 버전: v3.1
- 최종 갱신: 2024년 5월 20일
- 담당: AEGIS 운영팀
- 다음 검토일: 2024년 6월 20일

