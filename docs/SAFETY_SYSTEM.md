# AEGIS v3.0 - Safety System (안전 시스템)

*Version: 1.0*
*Last Updated: 2025-12-08*

---

## 1. 안전 시스템 개요

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      🛡️ AEGIS SAFETY SYSTEM                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  "수익보다 중요한 것은 생존이다"                                            │
│  "한국전력 사태를 반복하지 않는다"                                          │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                        안전 레이어 구조                              │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │   Layer 4: 🚨 EMERGENCY STOP (비상 정지)                            │    │
│  │            ─ 전체 시스템 즉시 중단                                   │    │
│  │                                                                      │    │
│  │   Layer 3: 🔴 CIRCUIT BREAKER (회로 차단기)                         │    │
│  │            ─ 일일 손실 한도 도달 시 매매 중단                        │    │
│  │                                                                      │    │
│  │   Layer 2: 🟡 POSITION GUARD (포지션 보호)                          │    │
│  │            ─ 종목별/전체 포지션 한도 관리                            │    │
│  │                                                                      │    │
│  │   Layer 1: 🟢 TRADE VALIDATOR (거래 검증)                           │    │
│  │            ─ 개별 거래 전 검증                                       │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. Layer 1: Trade Validator (거래 검증)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      🟢 TRADE VALIDATOR                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  모든 매수/매도 주문 전 검증 수행                                           │
│                                                                              │
│  [매수 전 체크리스트]                                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                                                                      │    │
│  │  ☑️ 1. AI 점수 확인                                                  │    │
│  │     └─ ai_score >= 70 필수                                          │    │
│  │     └─ model_used 기록 필수                                         │    │
│  │     └─ reasoning 기록 필수                                          │    │
│  │                                                                      │    │
│  │  ☑️ 2. 중복 매수 방지                                                │    │
│  │     └─ 이미 보유 중인 종목인가?                                     │    │
│  │     └─ 피라미딩 조건 충족하는가?                                    │    │
│  │                                                                      │    │
│  │  ☑️ 3. 거래 정지 종목 확인                                           │    │
│  │     └─ 상장폐지 예정 종목인가?                                      │    │
│  │     └─ 거래정지 상태인가?                                           │    │
│  │                                                                      │    │
│  │  ☑️ 4. 시장가 괴리 확인                                              │    │
│  │     └─ 호가 스프레드 5% 이상이면 거부                               │    │
│  │     └─ 급등/급락 중 (±10%) 이면 경고                                │    │
│  │                                                                      │    │
│  │  ☑️ 5. 잔고 확인                                                     │    │
│  │     └─ 주문 금액 <= 예수금                                          │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  [매도 전 체크리스트]                                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                                                                      │    │
│  │  ☑️ 1. 보유 수량 확인                                                │    │
│  │     └─ 매도 수량 <= 보유 수량                                       │    │
│  │                                                                      │    │
│  │  ☑️ 2. 손절가 도달 확인                                              │    │
│  │     └─ 손절 조건 충족 시 즉시 실행                                  │    │
│  │                                                                      │    │
│  │  ☑️ 3. 익절 조건 확인                                                │    │
│  │     └─ 분할 매도 단계 확인                                          │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 검증 결과 코드

| 코드 | 의미 | 처리 |
|------|------|------|
| `APPROVED` | 검증 통과 | 주문 실행 |
| `REJECTED_LOW_SCORE` | AI 점수 부족 | 주문 거부 |
| `REJECTED_DUPLICATE` | 중복 매수 | 주문 거부 |
| `REJECTED_SUSPENDED` | 거래 정지 종목 | 주문 거부 |
| `REJECTED_HIGH_SPREAD` | 호가 스프레드 과다 | 주문 거부 |
| `REJECTED_INSUFFICIENT` | 잔고 부족 | 주문 거부 |
| `WARNING_VOLATILE` | 급등락 경고 | 경고 후 진행 |

---

## 3. Layer 2: Position Guard (포지션 보호)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      🟡 POSITION GUARD                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                     포지션 한도 규칙                                 │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  [종목별 한도]                                                       │    │
│  │  ┌──────────────┬──────────────┬──────────────────────────────────┐ │    │
│  │  │     구분     │     한도     │            설명                  │ │    │
│  │  ├──────────────┼──────────────┼──────────────────────────────────┤ │    │
│  │  │ 단일 종목    │ 총자산 10%   │ 1종목에 최대 10% 투자            │ │    │
│  │  │ 피라미딩 후  │ 총자산 15%   │ 3차 피라미딩까지 최대 15%        │ │    │
│  │  │ 동일 섹터    │ 총자산 30%   │ 같은 섹터에 최대 30%             │ │    │
│  │  └──────────────┴──────────────┴──────────────────────────────────┘ │    │
│  │                                                                      │    │
│  │  [전체 포지션 한도]                                                  │    │
│  │  ┌──────────────┬──────────────┬──────────────────────────────────┐ │    │
│  │  │     구분     │     한도     │            설명                  │ │    │
│  │  ├──────────────┼──────────────┼──────────────────────────────────┤ │    │
│  │  │ 최대 보유    │ 10종목       │ 분산 투자                        │ │    │
│  │  │ 투자 비중    │ 총자산 80%   │ 예수금 20% 유지                  │ │    │
│  │  │ 신규 매수    │ 1일 3종목    │ 일일 신규 매수 제한              │ │    │
│  │  └──────────────┴──────────────┴──────────────────────────────────┘ │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  [예시]                                                                     │
│  총자산: 10,000,000원                                                       │
│                                                                              │
│  ├─ 단일 종목 한도: 1,000,000원 (10%)                                      │
│  ├─ 피라미딩 후 한도: 1,500,000원 (15%)                                    │
│  ├─ 동일 섹터 한도: 3,000,000원 (30%)                                      │
│  ├─ 최대 투자 금액: 8,000,000원 (80%)                                      │
│  └─ 유지 예수금: 2,000,000원 (20%)                                         │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. Layer 3: Circuit Breaker (회로 차단기)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      🔴 CIRCUIT BREAKER                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                     일일 손실 한도 시스템                            │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  [손실 레벨]                                                         │    │
│  │                                                                      │    │
│  │  ────────────────────────────────────────────────────────────────    │    │
│  │                                                                      │    │
│  │   0%   -0.5%   -1.0%   -1.5%   -2.0%   -3.0%                        │    │
│  │   │      │       │       │       │       │                          │    │
│  │   ▼      ▼       ▼       ▼       ▼       ▼                          │    │
│  │  정상   경고    주의    신규    모든    긴급                         │    │
│  │  운영   알림    모드    매수    매수    청산                         │    │
│  │                        중단    중단                                  │    │
│  │                                                                      │    │
│  ────────────────────────────────────────────────────────────────────    │    │
│                                                                              │
│  [레벨별 대응]                                                              │
│  ┌──────────────┬──────────────┬──────────────────────────────────────┐    │
│  │    레벨      │   손실률     │              대응                    │    │
│  ├──────────────┼──────────────┼──────────────────────────────────────┤    │
│  │ NORMAL       │ 0% ~ -0.5%   │ 정상 운영                            │    │
│  │ WARNING      │ -0.5% ~ -1%  │ 텔레그램 경고 알림                   │    │
│  │ CAUTION      │ -1% ~ -1.5%  │ 신규 매수 금액 50% 축소              │    │
│  │ STOP_NEW     │ -1.5% ~ -2%  │ 신규 매수 완전 중단                  │    │
│  │ STOP_ALL     │ -2% ~ -3%    │ 모든 매수 중단 (피라미딩 포함)       │    │
│  │ EMERGENCY    │ -3% 이상     │ 전 종목 청산 검토                    │    │
│  └──────────────┴──────────────┴──────────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 손실 계산 기준

```python
# 일일 손실률 계산
daily_loss_rate = (current_total_asset - day_start_total_asset) / day_start_total_asset * 100

# 예시
day_start_total_asset = 10,000,000원
current_total_asset = 9,850,000원
daily_loss_rate = (9,850,000 - 10,000,000) / 10,000,000 * 100 = -1.5%
# → STOP_NEW 레벨 발동
```

---

## 5. Layer 4: Emergency Stop (비상 정지)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      🚨 EMERGENCY STOP                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                      비상 정지 조건                                  │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  🚨 1. 일일 손실 -3% 초과                                           │    │
│  │     └─ 자동: 전 시스템 정지 + 관리자 알림                           │    │
│  │                                                                      │    │
│  │  🚨 2. API 연속 에러 10회                                           │    │
│  │     └─ KIS API 연속 실패 시 시스템 이상으로 판단                    │    │
│  │                                                                      │    │
│  │  🚨 3. 주문 체결 불일치                                             │    │
│  │     └─ DB 잔고와 실제 잔고 차이 발생 시                             │    │
│  │                                                                      │    │
│  │  🚨 4. 관리자 수동 정지                                             │    │
│  │     └─ 텔레그램 /emergency 명령                                     │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  [비상 정지 시 행동]                                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                                                                      │    │
│  │  1. 모든 대기 주문 취소                                             │    │
│  │  2. 스케줄러 일시 중지                                              │    │
│  │  3. 자동매매 플래그 OFF                                             │    │
│  │  4. 관리자 긴급 알림 (텔레그램 + 이메일)                            │    │
│  │  5. 시스템 로그 저장                                                │    │
│  │  6. 보유 종목 리스트 저장                                           │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  [재시작 조건]                                                              │
│  ├─ 관리자가 수동으로 /resume 명령 실행                                    │
│  ├─ 원인 분석 및 해결 확인                                                 │
│  └─ 시스템 상태 정상 확인                                                  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. 손절/익절 규칙

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      💰 손절/익절 규칙                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  [손절 규칙 - 무조건 실행]                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                                                                      │    │
│  │  기본 손절: -2%                                                      │    │
│  │  ├─ AI 점수 70-79: -2%                                              │    │
│  │  ├─ AI 점수 80-89: -2.5% (확신도 높음)                              │    │
│  │  └─ AI 점수 90+: -3% (매우 높은 확신)                               │    │
│  │                                                                      │    │
│  │  ⚠️ 손절은 무조건 실행 - 예외 없음                                   │    │
│  │  ⚠️ "더 떨어지면 사자" 금지                                          │    │
│  │  ⚠️ 손절 후 재매수 금지 (당일)                                       │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  [익절 규칙 - 분할 매도]                                                    │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                                                                      │    │
│  │  매수가: 10,000원 기준                                               │    │
│  │                                                                      │    │
│  │  ┌──────────┬──────────┬──────────┬──────────────────────────────┐  │    │
│  │  │  단계    │  수익률  │ 매도비율 │           설명               │  │    │
│  │  ├──────────┼──────────┼──────────┼──────────────────────────────┤  │    │
│  │  │ 1차 익절 │ +3.5%    │   50%    │ 이익 일부 확보               │  │    │
│  │  │ 트레일링 │ +5%      │    -     │ 고점 추적 시작               │  │    │
│  │  │ 2차 익절 │ +5.5%    │  나머지  │ 목표 달성                    │  │    │
│  │  └──────────┴──────────┴──────────┴──────────────────────────────┘  │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  [트레일링 스탑]                                                            │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                                                                      │    │
│  │  시작 조건: +5% 수익 도달                                           │    │
│  │  트레일링 폭: 고점 대비 -2%                                         │    │
│  │                                                                      │    │
│  │  예시:                                                               │    │
│  │  ├─ 현재가 10,500원 (+5%) → 트레일링 시작                          │    │
│  │  ├─ 고점 11,000원 (+10%) → 스탑가 10,780원                         │    │
│  │  ├─ 현재가 10,780원 하락 → 매도 실행                               │    │
│  │  └─ 결과: +7.8% 수익 확정                                          │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 7. 블랙리스트 시스템

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      🚫 BLACKLIST SYSTEM                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  [자동 블랙리스트 조건]                                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                                                                      │    │
│  │  1. 연속 손절 2회                                                   │    │
│  │     └─ 같은 종목에서 2번 연속 손절 시 30일 블랙리스트               │    │
│  │                                                                      │    │
│  │  2. 거래정지 이력                                                   │    │
│  │     └─ 과거 1년 내 거래정지 이력 있는 종목                          │    │
│  │                                                                      │    │
│  │  3. CB/BW 희석 과다                                                 │    │
│  │     └─ 희석 비율 30% 이상 종목                                      │    │
│  │                                                                      │    │
│  │  4. 관리종목 지정                                                   │    │
│  │     └─ 관리종목/투자경고 종목                                       │    │
│  │                                                                      │    │
│  │  5. 급등주 (당일)                                                   │    │
│  │     └─ 당일 +15% 이상 급등 종목 (추격 매수 방지)                    │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  [블랙리스트 해제 조건]                                                     │
│  ├─ 30일 경과 후 자동 해제                                                 │
│  ├─ 관리자 수동 해제 (/unblock 종목코드)                                   │
│  └─ 펀더멘털 개선 확인 시                                                  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 8. 시장 국면별 안전 모드

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      📊 MARKET REGIME SAFETY                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  [시장 국면 판단]                                                           │
│  ┌──────────────┬──────────────┬──────────────────────────────────────┐    │
│  │    국면      │   VIX 기준   │           안전 설정                  │    │
│  ├──────────────┼──────────────┼──────────────────────────────────────┤    │
│  │ BULL         │ VIX < 15     │ 정상 운영                            │    │
│  │ NORMAL       │ 15-20        │ 정상 운영                            │    │
│  │ CAUTION      │ 20-25        │ 신규 매수 금액 50% 축소              │    │
│  │ DEFENSIVE    │ 25-30        │ 신규 매수 중단, 손절 -1.5%로 축소    │    │
│  │ IRON_SHIELD  │ VIX > 30     │ 전면 방어, 기존 포지션만 관리        │    │
│  └──────────────┴──────────────┴──────────────────────────────────────┘    │
│                                                                              │
│  [IRON_SHIELD 모드]                                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                                                                      │    │
│  │  VIX > 30 발동 시:                                                  │    │
│  │                                                                      │    │
│  │  ❌ 신규 매수 전면 금지                                             │    │
│  │  ❌ 피라미딩 금지                                                   │    │
│  │  ✅ 손절 기준 -1.5%로 강화                                          │    │
│  │  ✅ 보유 종목 모니터링 강화 (5분마다)                               │    │
│  │  ✅ 현금 비중 50% 이상 유지                                         │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 9. 안전 시스템 데이터 흐름

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      📊 SAFETY DATA FLOW                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  [주문 요청 시]                                                             │
│                                                                              │
│  ┌─────────────┐                                                            │
│  │ 주문 요청   │                                                            │
│  └──────┬──────┘                                                            │
│         │                                                                    │
│         ▼                                                                    │
│  ┌─────────────┐     NO      ┌─────────────┐                               │
│  │ L1: Trade   │────────────►│   REJECT    │                               │
│  │  Validator  │             │   주문거부  │                               │
│  └──────┬──────┘             └─────────────┘                               │
│         │ YES                                                               │
│         ▼                                                                    │
│  ┌─────────────┐     NO      ┌─────────────┐                               │
│  │ L2: Position│────────────►│   REJECT    │                               │
│  │    Guard    │             │  한도초과   │                               │
│  └──────┬──────┘             └─────────────┘                               │
│         │ YES                                                               │
│         ▼                                                                    │
│  ┌─────────────┐     NO      ┌─────────────┐                               │
│  │ L3: Circuit │────────────►│   REJECT    │                               │
│  │   Breaker   │             │  손실한도   │                               │
│  └──────┬──────┘             └─────────────┘                               │
│         │ YES                                                               │
│         ▼                                                                    │
│  ┌─────────────┐                                                            │
│  │   EXECUTE   │                                                            │
│  │   주문실행  │                                                            │
│  └─────────────┘                                                            │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 10. 구현 체크리스트

### Layer 1: Trade Validator
- [ ] AI 점수 검증 (>= 70)
- [ ] model_used, reasoning 필수 체크
- [ ] 중복 매수 방지
- [ ] 거래 정지 종목 필터
- [ ] 호가 스프레드 검증
- [ ] 잔고 확인

### Layer 2: Position Guard
- [ ] 종목별 한도 검증 (10%)
- [ ] 섹터별 한도 검증 (30%)
- [ ] 전체 포지션 한도 (80%)
- [ ] 일일 신규 매수 제한 (3종목)

### Layer 3: Circuit Breaker
- [ ] 일일 손실률 계산
- [ ] 레벨별 대응 로직
- [ ] 텔레그램 알림 연동

### Layer 4: Emergency Stop
- [ ] 비상 정지 조건 모니터링
- [ ] 전체 시스템 정지 로직
- [ ] 관리자 알림
- [ ] 재시작 프로세스

### 기타
- [ ] 블랙리스트 관리
- [ ] 시장 국면별 모드 전환
- [ ] 손절/익절 규칙 적용

---

## 9. 🇰🇷 Layer 0: Korean Market Trap Detector (한국 시장 함정 감지)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                  🚨 KOREAN MARKET TRAP DETECTOR (Layer 0)                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  "한국 시장 특유의 함정 패턴을 사전에 차단한다"                              │
│  "전강후약(Gap Up & Die) 패턴을 학습하고 회피한다"                           │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │              10가지 한국 시장 함정 패턴 (우선순위 순)               │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  🚨 1. 수급 이탈 (Fake Rise) ⭐⭐⭐⭐⭐                                │    │
│  │     └─ 주가 상승 + 외국인/기관 순매도 → 개미 유인 함정             │    │
│  │     └─ 신뢰도: 95% | 권장: AVOID (매수 금지)                        │    │
│  │                                                                      │    │
│  │  ⚠️  2. 갭 과열 (Gap Overheat) ⭐⭐⭐⭐⭐                              │    │
│  │     └─ 시초가 전일 대비 +3.5% 이상 → 차익 실현 위험               │    │
│  │     └─ 신뢰도: 90% | 권장: WAIT (눌림목 대기)                       │    │
│  │                                                                      │    │
│  │  🔻 3. 프로그램 매도 가속 (Program Dump) ⭐⭐⭐⭐⭐                   │    │
│  │     └─ 프로그램 순매수 음수 + 매도 기울기 가파름                   │    │
│  │     └─ 신뢰도: 85% | 권장: AVOID (오후장 폭락 전조)                 │    │
│  │                                                                      │    │
│  │  📰 4. 뉴스 후 음봉 (Sell on News) ⭐⭐⭐⭐                           │    │
│  │     └─ 호재 뉴스 + 거래량 급증 + 현재가 < 시초가                   │    │
│  │     └─ 신뢰도: 80% | 권장: AVOID (재료 소멸)                        │    │
│  │                                                                      │    │
│  │  💨 5. 거래량 없는 상승 (Hollow Rise) ⭐⭐⭐⭐                        │    │
│  │     └─ 주가 +3% 이상 + 거래량 < 전일 50%                           │    │
│  │     └─ 신뢰도: 75% | 권장: REDUCE_SIZE (취약한 상승)                │    │
│  │                                                                      │    │
│  │  🧱 6. 매도벽 (Resistance Wall) ⭐⭐⭐                               │    │
│  │     └─ 1~2호가에 평소 거래량의 5배 매도 물량                       │    │
│  │     └─ 신뢰도: 70% | 권장: WAIT (돌파 불가능)                       │    │
│  │                                                                      │    │
│  │  🔀 7. 섹터 디커플링 (Sector Decouple) ⭐⭐⭐                        │    │
│  │     └─ 내 종목 +3% + 섹터 지수 -1% (괴리 2%p 이상)                │    │
│  │     └─ 신뢰도: 65% | 권장: WAIT (곧 따라 내려감)                    │    │
│  │                                                                      │    │
│  │  💱 8. 환율 쇼크 (FX Impact) ⭐⭐⭐                                   │    │
│  │     └─ 원/달러 환율 +0.5% 이상 급등                                │    │
│  │     └─ 신뢰도: 60% | 권장: REDUCE_SIZE (외국인 Exit)                │    │
│  │                                                                      │    │
│  │  📊 9. 장기 이평선 저항 (MA Resistance) ⭐⭐                         │    │
│  │     └─ 현재가가 120일선/200일선에 근접 (±1%)                       │    │
│  │     └─ 신뢰도: 55% | 권장: WAIT (80% 여기서 떨어짐)                 │    │
│  │                                                                      │    │
│  │  💣 10. 오버행 상장 (Dilution Day) ⭐⭐⭐⭐⭐                         │    │
│  │      └─ CB/BW/신주 상장일                                           │    │
│  │      └─ 신뢰도: 90% | 권장: AVOID (물량 공급 쇼크)                  │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 9.1 실전 사례: 2025-12-09 삼성전자/SK하이닉스

**상황**:
```
시간: 09:05
종목: 삼성전자, SK하이닉스
시초가: +3.5% 갭상승 (미국장 엔비디아 호재)
AI 판단: "미국장 호재 + 갭상승 = BUY!"
CEO 판단: "만류" (수급 이상 감지)
실제 거래: 최고점 풀매수 실행
```

**결과**:
```
외국인/기관: 차익 실현 물량 쏟아냄
주가: 시초가 이후 질질 흘러내림
종가: 음봉 마감 (-2.17%)
패턴: 전강후약 (Gap Up & Die)
```

**함정 감지기 적용 시**:
```
🚨 함정 감지 1: "갭 과열 (Gap Overheat)"
   - 시초가 +3.5% → 기준 +3.5% 초과
   - 신뢰도: 90%
   - 권장: WAIT (눌림목 대기)

🚨 함정 감지 2: "수급 이탈 (Fake Rise)"
   - 프로그램 비차익 순매수: -850억원 (순매도)
   - 외국인/기관: 매도 우위
   - 신뢰도: 95%
   - 권장: AVOID (개인만 사고 있는 껍데기 상승)

최종 결정: AI 점수 85점 → 0점 (CRITICAL 페널티)
          Final Score: 40점 (BUY 기준 70점 미달)
          결과: 매수 회피 ✅
```

### 9.2 AI 학습 피드백 루프

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      🧠 AI LEARNING FEEDBACK LOOP                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  1. 함정 감지                                                                │
│     └─→ Trap Detector가 패턴 감지                                          │
│         └─→ trap_type, severity, confidence                                │
│                                                                              │
│  2. 매수 결정                                                                │
│     └─→ CRITICAL: AI 점수 -100점 (강제 0점)                                │
│     └─→ HIGH/MEDIUM: AI 점수 감점 (confidence × 20점)                      │
│     └─→ 매수 회피 (AVOID) or 대기 (WAIT) or 축소 (REDUCE_SIZE)            │
│                                                                              │
│  3. 실제 결과 수집                                                           │
│     └─→ 1시간 후 가격                                                       │
│     └─→ 종가                                                                │
│     └─→ 실제 수익률                                                         │
│                                                                              │
│  4. 판단 결과                                                                │
│     └─→ CORRECT: 함정 맞음 (회피 성공)                                     │
│     └─→ WRONG: 함정 틀림 (기회 상실)                                       │
│                                                                              │
│  5. 가중치 조정                                                              │
│     └─→ CORRECT: weight += 0.01 (최대 0.99)                                │
│     └─→ WRONG: weight -= 0.02 (최소 0.30)                                  │
│                                                                              │
│  6. 패턴 강화/약화                                                           │
│     └─→ DB 저장 (trap_patterns, trade_feedback)                            │
│     └─→ 정확도 추적 (accuracy = correct_count / total_count)               │
│     └─→ 시간이 갈수록 정확도 향상 (Self-Learning)                          │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 9.3 한국 시장 수급 논리 학습

#### 학습 공식 1: 선물 주도 패턴
```python
if (foreign_futures_net > 5000 and basis > 5):
    signal = "BUY"
    reason = "외국인 선물 매수 + 베이시스 호전 → 기관 프로그램 매수 유입"
    target_sector = "KOSPI 200 대형주"
```

#### 학습 공식 2: 가짜 상승 필터링 ⭐ 핵심
```python
if (kospi_change > 0 and program_non_arbitrage < 0):
    signal = "AVOID"
    trap_type = "fake_rise"
    confidence = 0.95
    reason = "지수 상승 중이나 프로그램 비차익 순매도 → 개인만 사고 있는 껍데기 상승"
```

#### 학습 공식 3: 폭락 전조 감지
```python
if (price < ma20 and margin_debt_ratio >= historical_max):
    signal = "EMERGENCY_EXIT"
    trap_type = "margin_call_imminent"
    reason = "주가 20일선 이탈 + 신용잔고율 역대 최고 → 반대매매 투매 임박"
    action = "전량 매도 및 현금화"
```

#### 학습 공식 4: 공매도 압력 감지
```python
if (short_balance_change_pct > 50):
    signal = "CAUTION"
    trap_type = "short_selling_pressure"
    reason = "대차잔고 급증 → 외국인/기관 하락 베팅 → 상승 천장 형성"
```

### 9.4 통합 지점

#### Analyzer 통합
**파일**: `brain/analyzer.py`
**위치**: Quant Score 계산 후, AI Score 적용 전

```python
# 한국 시장 함정 감지
traps = await korean_trap_detector.detect_traps(
    stock_code=stock_code,
    stock_name=stock_name,
    current_price=current_price,
    market_data=market_data,
    realtime_data=realtime_data
)

# 함정 감지 시 AI 점수 페널티
if traps:
    critical_traps = [t for t in traps if t.severity == "CRITICAL"]
    if critical_traps:
        # CRITICAL 함정 → AI 점수 0점
        ai_score = 0
        trap_info = critical_traps[0]
    else:
        # HIGH/MEDIUM 함정 → AI 점수 감점
        penalty = sum(t.confidence * 20 for t in traps)
        ai_score = max(0, ai_score - penalty)
```

#### Safety Checker 통합
**파일**: `brain/safety_checker.py`

기존 5가지 체크에 **한국 시장 함정 감지 추가**:
```
기존:
1. 보유 종목 수 < 5개
2. 일일 거래 < 4회
3. 금요일 14:30 이전
4. 계좌 손실 < -2%
5. 종목 비중 < 10%

신규 추가:
6. 🇰🇷 한국 시장 함정 없음 (10가지 패턴)
```

### 9.5 데이터 소스

#### 5대 핵심 지표

| 순위 | 지표명 | 중요도 | 데이터 소스 | 업데이트 |
|------|--------|--------|------------|----------|
| 1️⃣ | 외국인 선물 누적 순매수 | ⭐⭐⭐⭐⭐ | KIS API (`FHKIF03020100`) | 실시간 |
| 2️⃣ | 프로그램 비차익 순매수 | ⭐⭐⭐⭐⭐ | KIS API (`FHKST01010600`) | 실시간 |
| 3️⃣ | 시장 베이시스 | ⭐⭐⭐⭐ | KIS API (선물-현물) | 실시간 |
| 4️⃣ | 신용융자 잔고율 추이 | ⭐⭐⭐⭐ | 금투협/네이버 | 일 1회 |
| 5️⃣ | 대차잔고 증감 | ⭐⭐⭐ | pykrx / KIS API | 일 1회 |

### 9.6 구현 상태

- [x] Trap Detector 클래스 생성 (`brain/korean_market_traps.py`)
- [x] 10가지 함정 패턴 구현
- [x] AI 학습 피드백 루프 구현
- [x] DB 모델 생성 (`app/models/learning.py`)
- [x] Analyzer 통합
- [ ] KIS Fetcher 확장 (실시간 수급 데이터)
- [ ] Market Data Fetcher 생성 (신용잔고)
- [ ] Safety Checker 통합 (6번째 체크)
- [ ] 백테스트 검증
- [ ] 실전 배포

### 9.7 관련 문서

- 한국 시장 함정 감지: `docs/dev/22-KOREAN-MARKET-TRAPS.md`
- 한국 시장 데이터 통합: `docs/dev/23-KOREAN-MARKET-DATA-INTEGRATION.md`
- 외부 데이터 소스: `docs/EXTERNAL_DATA_SOURCES.md` (Section 3.3, 10)
- Safety Checker: `docs/dev/20-SAFETY-CHECKER.md`

---

*Document maintained by AEGIS Development Team*
*Last Updated: 2025-12-09*
