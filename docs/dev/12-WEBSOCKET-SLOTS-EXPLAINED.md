# WebSocket ìŠ¬ë¡¯: 40ê°œëŠ” ì–¸ì œ 40ê°œì¸ê°€?

> ì‘ì„±ì¼: 2025-12-09
> ì¤‘ìš”ë„: â­â­â­â­â­

---

## ğŸ¤” ì§ˆë¬¸: "40ê°œ ë“±ë¡ì´ë¼ëŠ”ë° ì–¸ì œ 40ê°œëƒ?"

**ë‹µë³€**: 40ê°œëŠ” **KIS APIì˜ ê¸°ìˆ ì  ìµœëŒ€ í•œë„**ì…ë‹ˆë‹¤. ì‹¤ì œë¡œëŠ” í•„ìš”ì— ë”°ë¼ **10~40ê°œ ì‚¬ì´ì—ì„œ ë™ì ìœ¼ë¡œ ë³€ë™**í•©ë‹ˆë‹¤.

---

## ğŸ“Š ì‹¤ì œ ìŠ¬ë¡¯ ì‚¬ìš©ëŸ‰

### ì‹œë‚˜ë¦¬ì˜¤ë³„ ì˜ˆì‹œ

#### 1ï¸âƒ£ ì¥ ì‹œì‘ (09:00)

```
ë³´ìœ ì¢…ëª©: 5ê°œ
Daily Picks: 20ê°œ
ê¸‰ë“±ì£¼: 0ê°œ (ì•„ì§ ë°œê²¬ ì „)

ì´ ì‚¬ìš©: 25ê°œ / 40ê°œ (62.5%)
```

#### 2ï¸âƒ£ ì˜¤ì „ì¥ (10:00)

```
ë³´ìœ ì¢…ëª©: 5ê°œ
Daily Picks: 20ê°œ
ê¸‰ë“±ì£¼: 8ê°œ (Market Scannerê°€ ë°œê²¬)

ì´ ì‚¬ìš©: 33ê°œ / 40ê°œ (82.5%)
```

#### 3ï¸âƒ£ ì˜¤í›„ì¥ (14:00)

```
ë³´ìœ ì¢…ëª©: 3ê°œ (2ê°œ ë§¤ë„ ì™„ë£Œ)
Daily Picks: 20ê°œ
ê¸‰ë“±ì£¼: 15ê°œ (ê³„ì† ë°œê²¬)

ì´ ì‚¬ìš©: 38ê°œ / 40ê°œ (95%)
â†’ ìŠ¬ë¡¯ ë¶€ì¡±! ê¸‰ë“±ì£¼ Priority 3 ì¤‘ ê°€ì¥ ì˜¤ë˜ëœ ê²ƒ ì œê±°
```

#### 4ï¸âƒ£ ê·¹ë‹¨ì  ì¼€ì´ìŠ¤ (ë³´ìœ  ë§ìŒ)

```
ë³´ìœ ì¢…ëª©: 25ê°œ (í¬íŠ¸í´ë¦¬ì˜¤ í¼)
Daily Picks: 20ê°œ

ì´ í•„ìš”: 45ê°œ â†’ 40ê°œ ì œí•œ ì´ˆê³¼!
í•´ê²°: Daily Picks ì¤‘ í•˜ìœ„ 5ê°œ ì œê±° (Priority 2)
```

---

## ğŸ¯ Priority ê¸°ë°˜ ë™ì  ê´€ë¦¬

### Priority ì •ì˜

```python
Priority 1: ë³´ìœ ì¢…ëª© (ìµœìš°ì„ , ì ˆëŒ€ ì œê±° ì•ˆí•¨)
Priority 2: AI Daily Picks (ì¤‘ìš”, ìŠ¬ë¡¯ ë¶€ì¡± ì‹œ ì¼ë¶€ ì œê±°)
Priority 3: ê¸‰ë“±ì£¼ (ë‚®ìŒ, ê°€ì¥ ë¨¼ì € ì œê±°)
```

### ìŠ¬ë¡¯ ë¶€ì¡± ì‹œ ì œê±° ìˆœì„œ

```
1. Priority 3 (ê¸‰ë“±ì£¼) ì¤‘ ê°€ì¥ ì˜¤ë˜ëœ ê²ƒ
2. Priority 3 ì „ë¶€ ì œê±°í–ˆëŠ”ë°ë„ ë¶€ì¡±í•˜ë©´
3. Priority 2 (Daily Picks) ì¤‘ í•˜ìœ„ ìˆœìœ„
```

---

## ğŸ“‹ êµ¬ì²´ì  í• ë‹¹ ì „ëµ

### 1. ë³´ìœ ì¢…ëª© (Priority 1)

**ê°œìˆ˜**: ë³€ë™ (0~30ê°œ)
**íŠ¹ì§•**:
- ì‹¤ì œ ë³´ìœ  ì¢…ëª© ìˆ˜ì— ë”°ë¼ ë³€ë™
- ë§¤ìˆ˜/ë§¤ë„ ì‹œ ìë™ ì¶”ê°€/ì œê±°
- ì ˆëŒ€ ì œê±° ì•ˆë¨ (ìµœìš°ì„ )

```python
# ì˜ˆì‹œ
ë³´ìœ  5ê°œ â†’ Priority 1 = 5ê°œ
ë³´ìœ  15ê°œ â†’ Priority 1 = 15ê°œ
ë³´ìœ  0ê°œ â†’ Priority 1 = 0ê°œ
```

**ì½”ë“œ**:
```python
async def sync_with_portfolio(self):
    """ë³´ìœ ì¢…ëª© ë™ê¸°í™”"""
    portfolio = await portfolio_service.get_portfolio()

    for stock in portfolio:
        await self.subscribe(
            stock_code=stock.stock_code,
            stock_name=stock.stock_name,
            priority=1  # ìµœìš°ì„ 
        )
```

---

### 2. AI Daily Picks (Priority 2)

**ê°œìˆ˜**: 20ê°œ ê³ ì • (ëª©í‘œ)
**íŠ¹ì§•**:
- 07:20ì— DeepSeek R1ì´ ì„ ì •
- ë§¤ì¼ 20ê°œë¡œ ê³ ì •í•˜ë ¤ê³  ì‹œë„
- ìŠ¬ë¡¯ ë¶€ì¡± ì‹œ ì¼ë¶€ë§Œ ë“±ë¡

```python
# ì˜ˆì‹œ
Daily Picks 20ê°œ ì„ ì •
ìŠ¬ë¡¯ ì—¬ìœ : 20ê°œ â†’ ì „ë¶€ ë“±ë¡ (20ê°œ)
ìŠ¬ë¡¯ ì—¬ìœ : 10ê°œ â†’ ìƒìœ„ 10ê°œë§Œ ë“±ë¡
ìŠ¬ë¡¯ ì—¬ìœ : 0ê°œ â†’ ë“±ë¡ ë¶ˆê°€
```

**ì½”ë“œ**:
```python
async def update_daily_picks(self, picks: list):
    """Daily Picks ì—…ë°ì´íŠ¸"""
    # ìµœëŒ€ 20ê°œ ì‹œë„
    for pick in picks[:20]:
        result = await self.subscribe(
            stock_code=pick["stock_code"],
            stock_name=pick["stock_name"],
            priority=2
        )
        if not result:
            # ìŠ¬ë¡¯ ë¶€ì¡±ìœ¼ë¡œ ì‹¤íŒ¨
            break
```

---

### 3. ê¸‰ë“±ì£¼ (Priority 3)

**ê°œìˆ˜**: 0~10ê°œ (ë™ì )
**íŠ¹ì§•**:
- Market Scannerê°€ 1ë¶„ë§ˆë‹¤ ë°œê²¬
- ìŠ¬ë¡¯ ì—¬ìœ  ìˆì„ ë•Œë§Œ ì¶”ê°€
- ì˜¤ë˜ëœ ê²ƒë¶€í„° ìë™ ì œê±°

```python
# ì˜ˆì‹œ
ìŠ¤ìº” ê²°ê³¼: 5ê°œ ë°œê²¬
ìŠ¬ë¡¯ ì—¬ìœ : 10ê°œ â†’ 5ê°œ ì „ë¶€ ë“±ë¡
ìŠ¬ë¡¯ ì—¬ìœ : 2ê°œ â†’ 2ê°œë§Œ ë“±ë¡
ìŠ¬ë¡¯ ì—¬ìœ : 0ê°œ â†’ ë“±ë¡ ë¶ˆê°€
```

**ì½”ë“œ**:
```python
async def run_scanner(self):
    """Market Scanner (1ë¶„ë§ˆë‹¤)"""
    candidates = await self.scan_top_gainers(limit=20)

    # 70ì  ì´ìƒ í•„í„°ë§
    for candidate in candidates:
        if candidate['score'] >= 70:
            await ws_manager.subscribe(
                stock_code=candidate['stock_code'],
                stock_name=candidate['stock_name'],
                priority=3  # ë‚®ì€ ìš°ì„ ìˆœìœ„
            )
            # ìŠ¬ë¡¯ ë¶€ì¡±í•˜ë©´ ìë™ìœ¼ë¡œ ì‹¤íŒ¨
```

---

## ğŸ”„ ë™ì  í• ë‹¹ ì˜ˆì‹œ

### Case 1: ì—¬ìœ  ìˆìŒ

```
ì‹œê°: 09:00
ë³´ìœ : 5ê°œ
Daily Picks: 20ê°œ
ê¸‰ë“±ì£¼: 0ê°œ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ì´ ì‚¬ìš©: 25 / 40 âœ…
ì—¬ìœ : 15ê°œ
```

**ê²°ê³¼**: ëª¨ë‘ ë“±ë¡ ì„±ê³µ, ê¸‰ë“±ì£¼ 15ê°œê¹Œì§€ ì¶”ê°€ ê°€ëŠ¥

---

### Case 2: ì ë‹¹í•¨

```
ì‹œê°: 11:00
ë³´ìœ : 8ê°œ
Daily Picks: 20ê°œ
ê¸‰ë“±ì£¼: 10ê°œ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ì´ ì‚¬ìš©: 38 / 40 âœ…
ì—¬ìœ : 2ê°œ
```

**ê²°ê³¼**:
- ëª¨ë‘ ë“±ë¡ ì„±ê³µ
- ê¸‰ë“±ì£¼ 2ê°œê¹Œì§€ ì¶”ê°€ ê°€ëŠ¥
- ìƒˆ ê¸‰ë“±ì£¼ ë°œê²¬ ì‹œ ì˜¤ë˜ëœ ê²ƒ ì œê±°

---

### Case 3: ë¶€ì¡± (ì¼ë°˜)

```
ì‹œê°: 14:00
ë³´ìœ : 6ê°œ
Daily Picks: 20ê°œ
ê¸‰ë“±ì£¼: 15ê°œ (ë°œê²¬)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
í•„ìš”: 41ê°œ > 40ê°œ âŒ
```

**í•´ê²°**:
```python
# 1. Priority 3 (ê¸‰ë“±ì£¼) ì¤‘ ê°€ì¥ ì˜¤ë˜ëœ 1ê°œ ì œê±°
await ws_manager.evict_lowest_priority(required_priority=3)

# 2. ìƒˆë¡œìš´ ê¸‰ë“±ì£¼ ì¶”ê°€
await ws_manager.subscribe(new_stock, priority=3)
```

**ê²°ê³¼**:
- ë³´ìœ  6ê°œ âœ…
- Daily Picks 20ê°œ âœ…
- ê¸‰ë“±ì£¼ 14ê°œ (1ê°œ ì œê±°, 1ê°œ ì¶”ê°€)
- ì´ 40ê°œ

---

### Case 4: ë¶€ì¡± (ê·¹ë‹¨)

```
ì‹œê°: 13:00
ë³´ìœ : 30ê°œ (í¬íŠ¸í´ë¦¬ì˜¤ í¼)
Daily Picks: 20ê°œ
ê¸‰ë“±ì£¼: 0ê°œ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
í•„ìš”: 50ê°œ > 40ê°œ âŒ
```

**í•´ê²°**:
```python
# 1. Priority 3 ì „ë¶€ ì œê±° (ì—†ìŒ)
# 2. Priority 2 (Daily Picks) í•˜ìœ„ 10ê°œ ì œê±°
for i in range(10):
    await ws_manager.evict_lowest_priority(required_priority=2)
```

**ê²°ê³¼**:
- ë³´ìœ  30ê°œ âœ… (Priority 1, ì ˆëŒ€ ì œê±° ì•ˆí•¨)
- Daily Picks 10ê°œ (ìƒìœ„ 10ê°œë§Œ)
- ê¸‰ë“±ì£¼ 0ê°œ
- ì´ 40ê°œ

---

## ğŸ’» ìŠ¬ë¡¯ ë¶€ì¡± ì²˜ë¦¬ ë¡œì§

### subscribe() ë©”ì„œë“œ

```python
async def subscribe(self, stock_code: str, stock_name: str, priority: int) -> bool:
    """
    ì¢…ëª© êµ¬ë…

    Returns:
        True: êµ¬ë… ì„±ê³µ
        False: ìŠ¬ë¡¯ ë¶€ì¡±ìœ¼ë¡œ ì‹¤íŒ¨
    """
    # ì´ë¯¸ êµ¬ë… ì¤‘ì´ë©´ ìŠ¤í‚µ
    if stock_code in self.slots:
        return True

    # ìŠ¬ë¡¯ ë¶€ì¡±
    if len(self.slots) >= self.MAX_SLOTS:
        # ë‚®ì€ ìš°ì„ ìˆœìœ„ ì œê±° ì‹œë„
        evicted = await self.evict_lowest_priority(priority)

        if not evicted:
            logger.warning(f"âš ï¸  Slot full, cannot subscribe: {stock_name}")
            return False  # ì‹¤íŒ¨

    # WebSocket êµ¬ë…
    await self._send_subscribe_message(stock_code)

    # ìŠ¬ë¡¯ ê¸°ë¡
    self.slots[stock_code] = WebSocketSlot(
        stock_code=stock_code,
        stock_name=stock_name,
        priority=priority,
        ...
    )

    return True  # ì„±ê³µ
```

### evict_lowest_priority() ë©”ì„œë“œ

```python
async def evict_lowest_priority(self, required_priority: int) -> bool:
    """
    ê°€ì¥ ë‚®ì€ ìš°ì„ ìˆœìœ„ ì œê±°

    Args:
        required_priority: í•„ìš”í•œ ìš°ì„ ìˆœìœ„

    Returns:
        True: ì œê±° ì„±ê³µ
        False: ì œê±° ë¶ˆê°€ (ëª¨ë‘ ë†’ì€ ìš°ì„ ìˆœìœ„)
    """
    # Priority 3 ì¤‘ ê°€ì¥ ì˜¤ë˜ëœ ê²ƒ ì°¾ê¸°
    priority3_slots = [
        (code, slot) for code, slot in self.slots.items()
        if slot.priority == 3
    ]

    if priority3_slots:
        # ê°€ì¥ ì˜¤ë˜ëœ ê²ƒ ì œê±°
        oldest_code, _ = min(priority3_slots, key=lambda x: x[1].subscribed_at)
        await self.unsubscribe(oldest_code)
        return True

    # Priority 3 ì—†ìŒ, Priority 2 í™•ì¸
    if required_priority <= 2:
        # Priority 2 ì¤‘ ê°€ì¥ ìˆœìœ„ ë‚®ì€ ê²ƒ ì œê±°
        # (Daily PicksëŠ” rank ì†ì„± ìˆìŒ)
        # ...
        return True

    # ì œê±° ë¶ˆê°€ (ëª¨ë‘ Priority 1)
    return False
```

---

## ğŸ“Š ì‹¤ì œ ì‚¬ìš©ëŸ‰ í†µê³„ (ì˜ˆìƒ)

### ì¼ë°˜ì ì¸ ê²½ìš°

```
ì‹œê°„ëŒ€     | ë³´ìœ  | Daily | ê¸‰ë“± | ì´ì‚¬ìš© | ì—¬ìœ 
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€
09:00    |  5  |  20  |  0  |  25   | 15
10:00    |  5  |  20  |  5  |  30   | 10
11:00    |  6  |  20  |  8  |  34   |  6
12:00    |  6  |  20  | 10  |  36   |  4
13:00    |  4  |  20  | 12  |  36   |  4
14:00    |  4  |  20  | 14  |  38   |  2
15:00    |  3  |  20  | 15  |  38   |  2

í‰ê· : 34 / 40 (85% ì‚¬ìš©ë¥ )
```

### ë³´ìœ  ë§ì€ ê²½ìš°

```
ì‹œê°„ëŒ€     | ë³´ìœ  | Daily | ê¸‰ë“± | ì´ì‚¬ìš© | ì—¬ìœ 
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€
09:00    | 20  |  20  |  0  |  40   |  0
10:00    | 20  |  20  |  0  |  40   |  0
11:00    | 22  |  18  |  0  |  40   |  0
12:00    | 25  |  15  |  0  |  40   |  0
13:00    | 25  |  15  |  0  |  40   |  0
14:00    | 23  |  17  |  0  |  40   |  0
15:00    | 20  |  20  |  0  |  40   |  0

í‰ê· : 40 / 40 (100% ì‚¬ìš©ë¥ )
ê¸‰ë“±ì£¼ ë“±ë¡ ë¶ˆê°€ (ë³´ìœ +Dailyë¡œ ì´ë¯¸ ê½‰ì°¸)
```

---

## ğŸ¯ ìµœì¢… ë‹µë³€

### Q: "40ê°œëŠ” ì–¸ì œ 40ê°œëƒ?"

**A**: 40ê°œëŠ” **ìµœëŒ€ í•œë„**ì¼ ë¿, ì‹¤ì œ ì‚¬ìš©ëŸ‰ì€:

```
ìµœì†Œ: 20ê°œ (ë³´ìœ  0 + Daily 20)
ì¼ë°˜: 30~35ê°œ (ë³´ìœ  5~10 + Daily 20 + ê¸‰ë“± 5~10)
ìµœëŒ€: 40ê°œ (ë³´ìœ  ë§ê±°ë‚˜ ê¸‰ë“±ì£¼ ë§ì„ ë•Œ)

í‰ê·  ì‚¬ìš©ë¥ : 80~90%
```

### í•µì‹¬

```
âœ… 40ê°œ = KIS API ì œí•œ (ê¸°ìˆ ì  ìµœëŒ€)
âœ… ì‹¤ì œ ì‚¬ìš© = í•„ìš”ì— ë”°ë¼ ë³€ë™ (ë™ì )
âœ… Priority ê¸°ë°˜ ìë™ ê´€ë¦¬
âœ… ìŠ¬ë¡¯ ë¶€ì¡± ì‹œ ë‚®ì€ ìš°ì„ ìˆœìœ„ë¶€í„° ì œê±°
âŒ í•­ìƒ 40ê°œë¥¼ ì±„ìš°ë ¤ê³  í•˜ì§€ ì•ŠìŒ
```

---

## ğŸ”® ê°œì„  ì‚¬í•­ (TODO)

### 1. ìŠ¬ë¡¯ ì‚¬ìš©ëŸ‰ ëª¨ë‹ˆí„°ë§

```python
# í˜„ì¬ ìŠ¬ë¡¯ ìƒíƒœ ì¡°íšŒ
status = await ws_manager.get_status()
print(f"ì‚¬ìš©: {status['used_slots']} / {status['total_slots']}")
print(f"Priority 1: {status['priority_1_count']}ê°œ")
print(f"Priority 2: {status['priority_2_count']}ê°œ")
print(f"Priority 3: {status['priority_3_count']}ê°œ")
```

### 2. ìŠ¬ë¡¯ ì—¬ìœ  ê¸°ë°˜ ì „ëµ

```python
# ìŠ¬ë¡¯ ì—¬ìœ  80% ì´ìƒì´ë©´
# Market Scanner ë” ì ê·¹ì ìœ¼ë¡œ (30ê°œê¹Œì§€ í‰ê°€)

# ìŠ¬ë¡¯ ì—¬ìœ  20% ì´í•˜ë©´
# Market Scanner ë³´ìˆ˜ì ìœ¼ë¡œ (10ê°œë§Œ í‰ê°€)
```

### 3. Daily Picks ìœ ì—°í•œ ì¡°ì •

```python
# í˜„ì¬: ë¬´ì¡°ê±´ 20ê°œ ì‹œë„
# ê°œì„ : ìŠ¬ë¡¯ ì—¬ìœ ì— ë”°ë¼ ì¡°ì •

if available_slots >= 25:
    register_picks = 20  # ì „ë¶€
elif available_slots >= 15:
    register_picks = 15  # ìƒìœ„ 15ê°œ
else:
    register_picks = 10  # ìƒìœ„ 10ê°œ
```

---

**ì‘ì„±**: Claude Code
**ì¤‘ìš”ë„**: â­â­â­â­â­
**ëª…í™•í™”**: âœ… ì™„ë£Œ
