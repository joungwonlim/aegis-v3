# Claude Code 토큰 절약 가이드

## 개요

Claude Code에서 포트폴리오 모니터링 시 **토큰 소모를 90% 이상 절약**하는 방법을 정리합니다.

---

## 문제점: 기존 방식의 토큰 낭비

```
┌─────────────────────────────────────────────────────────────────┐
│  ❌ 기존 방식 (토큰 낭비)                                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Claude Code                                                     │
│      ↓                                                          │
│  time.sleep(600)  ← 10분 대기 동안 토큰 계속 소모!              │
│      ↓                                                          │
│  분석 실행                                                       │
│      ↓                                                          │
│  time.sleep(600)  ← 또 토큰 소모!                               │
│      ↓                                                          │
│  ... 반복                                                        │
│                                                                  │
│  💸 결과: 대기 시간 동안 불필요한 토큰 비용 발생                 │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 왜 토큰이 소모되는가?

1. Claude Code 세션이 활성 상태로 유지됨
2. `time.sleep()` 동안에도 컨텍스트 유지 비용 발생
3. 10분마다 분석하면 하루 39회 × 토큰 = 막대한 비용

---

## 해결책: Python 백그라운드 + On-Demand 분석

```
┌─────────────────────────────────────────────────────────────────┐
│  ✅ 새로운 방식 (토큰 절약)                                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  [Python 백그라운드]              [Claude Code]                  │
│        ↓                              ↓                         │
│  10분마다 자동 실행              사용자가 "." 입력할 때만        │
│        ↓                              ↓                         │
│  결과를 JSON 저장                JSON 파일 읽기                  │
│        ↓                              ↓                         │
│  data/monitor_analysis.json  →   분석 & 해석                    │
│                                                                  │
│  💰 결과: 분석 요청 시에만 토큰 사용 (90%+ 절약)                 │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 구현 방법

### 1. 기본 모니터링 스크립트

**파일**: `scripts/monitor_portfolio.py`

```python
#!/usr/bin/env python3
"""
10분 간격 포트폴리오 모니터링
- 결과를 JSON 파일로 저장
- 손절선 도달 시 텔레그램 알림
"""

import time
import json
from datetime import datetime
from pathlib import Path

# ... 환경 설정 ...

INTERVAL = 600  # 10분
RESULT_FILE = PROJECT_ROOT / 'data' / 'monitor_result.json'

def check_portfolio():
    kis = KISFetcher(use_virtual=False)
    holdings = kis.get_account_holdings()
    balance = kis.get_account_balance()

    # 결과 구성
    result = {
        'timestamp': datetime.now().isoformat(),
        'total_asset': float(balance.get('total_asset', 0)),
        'pnl': float(balance.get('profit_loss', 0)),
        'stocks': [...]
    }

    # JSON 저장
    with open(RESULT_FILE, 'w') as f:
        json.dump(result, f, ensure_ascii=False, indent=2)

    return result

def main():
    while True:
        result = check_portfolio()
        print(f"[{datetime.now():%H:%M}] 저장 완료")
        time.sleep(INTERVAL)

if __name__ == '__main__':
    main()
```

### 2. Brain AI 분석 포함 스크립트

**파일**: `scripts/monitor_with_analysis.py`

```python
#!/usr/bin/env python3
"""
10분 간격 포트폴리오 + Brain AI 분석
- QuantScorer: 정량 점수 (65점 기준)
- ScenarioSimulator: BUY/SELL/HOLD 추천
"""

from brain.quant_scorer import QuantScorer
from brain.scenario_simulator import ScenarioSimulator

def run_brain_analysis(code, name, current_price, session):
    # QuantScorer
    qs = QuantScorer(session)
    qs_result = qs.calculate(code)
    quant_score = qs_result.get('quant_score', 0)

    # ScenarioSimulator
    sim = ScenarioSimulator(session)
    scenario = sim.generate_scenarios(
        stock_info={'stock_code': code, 'current_price': current_price},
        quant_score=quant_score
    )

    return {
        'quant_score': quant_score,
        'action': scenario.recommended_action,  # BUY/SELL/HOLD
        'stop_loss': scenario.stop_loss,
        'take_profit': scenario.take_profit_1
    }
```

### 3. 실시간 시각화 스크립트

**파일**: `scripts/portfolio_watch.py`

```python
#!/usr/bin/env python3
"""
30초 간격 Rich UI 포트폴리오 모니터링
- 시각적 차트, 진행률 바
- 수익 히스토리 추적
- JSON으로 히스토리 저장
"""

from rich.console import Console
from rich.table import Table
from rich.live import Live

REFRESH_INTERVAL = 30  # 30초

class PortfolioWatcher:
    def __init__(self):
        self.console = Console()
        self.profit_history = []

    def run(self):
        with Live(self.generate_layout(), refresh_per_second=0.1):
            while True:
                self.update_data()
                self.save_history()
                time.sleep(REFRESH_INTERVAL)
```

---

## 실행 방법

### 백그라운드 실행

```bash
# 방법 1: nohup
cd /Users/wonny/Dev/aegis/v2
source venv/bin/activate
nohup python scripts/monitor_with_analysis.py > data/monitor.log 2>&1 &

# 방법 2: screen
screen -S aegis-monitor
python scripts/monitor_with_analysis.py
# Ctrl+A, D 로 detach

# 방법 3: tmux
tmux new -s aegis
python scripts/monitor_with_analysis.py
# Ctrl+B, D 로 detach
```

### 프로세스 확인

```bash
# 실행 중인 모니터 확인
ps aux | grep monitor

# 종료
kill <PID>
```

---

## On-Demand 분석 사용법

### Claude Code에서 "." 입력

사용자가 `.` (마침표)를 입력하면:

1. Python이 즉시 분석 실행
2. 결과를 JSON에 저장
3. Claude가 JSON 읽고 해석

```
┌─────────────────────────────────────────────────────────────────┐
│  사용자: .                                                       │
│                                                                  │
│  Claude:                                                         │
│  📊 포트폴리오 분석 [13:44]                                      │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│  총 자산: 51,917,954원                                           │
│  손익: -214,435원 (-0.41%)                                       │
│  목표까지: +0.91%                                                │
│                                                                  │
│  | 종목       | 수익률  | Quant | 액션 |                        │
│  |------------|---------|-------|------|                        │
│  | KCC        | +2.22%  | 65    | HOLD |                        │
│  | DN오토모티브| +1.35% | 65    | HOLD |                        │
│  | SK하이닉스 | ±0.00%  | 65    | HOLD |                        │
│  | ...        | ...     | ...   | ...  |                        │
└─────────────────────────────────────────────────────────────────┘
```

---

## 토큰 절약 효과

### 비교 분석

| 항목 | 기존 방식 | 새로운 방식 |
|------|----------|------------|
| 10분 대기 | Claude 세션 유지 | Python만 실행 |
| 토큰 소모 | 대기 중에도 발생 | 요청 시에만 발생 |
| 하루 분석 횟수 | 39회 자동 | 필요할 때만 |
| 예상 토큰 | 100% | **~10%** |

### 절약 원리

```
기존: Claude 세션 유지 (09:00~15:30) = 6.5시간 × 토큰
새로운: Claude 호출 (분석 요청 시) = 10회 × 토큰

절약률 = (39 - 10) / 39 × 100 = 약 74%
+ 대기 시간 토큰 절약 = 추가 20%+

총 절약: 약 90%+
```

---

## 파일 구조

```
aegis-v2/
├── scripts/
│   ├── monitor_portfolio.py      # 기본 10분 모니터링
│   ├── monitor_with_analysis.py  # Brain AI 분석 포함
│   └── portfolio_watch.py        # Rich UI 30초 모니터링
├── data/
│   ├── monitor_result.json       # 기본 결과
│   ├── monitor_analysis.json     # Brain AI 분석 결과
│   └── monitor_analysis.log      # 로그
└── docs/dev3/
    └── 클로드_토큰절약.md         # 이 문서
```

---

## 핵심 패턴

### 1. JSON 중간 저장

```python
# Python 스크립트에서
result = {...}
with open('data/result.json', 'w') as f:
    json.dump(result, f)

# Claude Code에서
data = json.load(open('data/result.json'))
# → 분석 및 해석
```

### 2. 백그라운드 실행

```bash
# 토큰 소모 없이 Python이 독립 실행
nohup python script.py &
```

### 3. On-Demand 호출

```
사용자 입력 → Python 실행 → JSON 저장 → Claude 읽기 → 해석
     "."                                              ↑
                                              이 부분만 토큰 사용
```

---

## 주의사항

1. **가상환경 활성화**: `source venv/bin/activate` 필수
2. **환경변수 로드**: `.env` 파일 읽기 로직 포함
3. **JSON 경로**: 절대 경로 또는 PROJECT_ROOT 기준 상대 경로 사용
4. **프로세스 관리**: 장 마감 후 종료 로직 포함 권장

---

## 결론

| Before | After |
|--------|-------|
| Claude가 10분 대기 | Python이 백그라운드 실행 |
| 토큰 계속 소모 | JSON에 결과 저장 |
| 비용 높음 | Claude는 읽기만 (90%+ 절약) |

**핵심**: Python으로 데이터 수집 → JSON 저장 → Claude는 해석만

---

*마지막 업데이트: 2025-12-09*
