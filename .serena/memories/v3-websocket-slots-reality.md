# WebSocket 슬롯: 40개의 진실

## 핵심 답변

**Q: "40개는 언제 40개냐?"**

**A**: 40개는 **KIS API 기술적 최대 한도**. 실제로는 **필요에 따라 10~40개 사이에서 동적 변동**.

## 실제 사용량

```
최소: 20개 (보유 0 + Daily 20)
일반: 30~35개 (보유 5~10 + Daily 20 + 급등 5~10)
최대: 40개 (슬롯 꽉 찰 때)

평균 사용률: 80~90%
```

## Priority 별 할당

### Priority 1: 보유종목 (변동)
- 개수: 0~30개 (실제 보유 수)
- 특징: 절대 제거 안됨
- 예: 보유 5개면 5개만 사용

### Priority 2: AI Daily Picks (20개 목표)
- 개수: 0~20개 (슬롯 여유 따라)
- 특징: 07:20 DeepSeek R1 선정
- 예: 슬롯 여유 10개면 상위 10개만

### Priority 3: 급등주 (동적)
- 개수: 0~10개 (발견 시마다)
- 특징: 가장 먼저 제거됨
- 예: 슬롯 여유 없으면 등록 불가

## 시나리오별 예시

### 일반 케이스
```
09:00 - 보유 5 + Daily 20 + 급등 0 = 25개 (62%)
10:00 - 보유 5 + Daily 20 + 급등 5 = 30개 (75%)
14:00 - 보유 4 + Daily 20 + 급등 14 = 38개 (95%)
```

### 보유 많은 케이스
```
09:00 - 보유 25 + Daily 15 + 급등 0 = 40개 (100%)
14:00 - 보유 30 + Daily 10 + 급등 0 = 40개 (100%)
```

## 슬롯 부족 시 제거 순서

```
1. Priority 3 (급등주) 중 가장 오래된 것
2. Priority 3 전부 제거해도 부족하면
3. Priority 2 (Daily Picks) 중 하위 순위
4. Priority 1 (보유종목)은 절대 제거 안함
```

## 코드 동작

### subscribe() 로직
```python
if len(self.slots) >= 40:
    # 낮은 우선순위 제거 시도
    evicted = await self.evict_lowest_priority(priority)

    if not evicted:
        return False  # 구독 실패

# 구독 성공
self.slots[stock_code] = WebSocketSlot(...)
return True
```

### 결과
- ✅ 여유 있으면 구독 성공
- ❌ 꽉 차고 제거 불가하면 구독 실패
- 🔄 낮은 우선순위 제거하고 구독 성공

## 핵심 정리

```
✅ 40개 = 최대 한도 (기술적 제한)
✅ 실제 = 10~40개 (동적 변동)
✅ Priority 기반 자동 관리
✅ 슬롯 부족 시 자동 제거
❌ 항상 40개 채우려 하지 않음
```

## 개선 방향

1. 슬롯 사용량 모니터링 API
2. 슬롯 여유 기반 Scanner 전략 조정
3. Daily Picks 유연한 개수 조정 (10~20개)
