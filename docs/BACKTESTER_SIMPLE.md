# AEGIS Backtester - Simple Guide

> **Simple is Best** - 핵심만 담은 백테스트 시스템

---

## 1. 백테스터 개요

### 1.1 목적

```
┌─────────────────────────────────────────────────────────────────┐
│                      백테스터 역할                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  📊 전략 검증                                                    │
│  ─────────────────────────────────────────────────────────────  │
│  과거 데이터로 전략의 유효성 검증                                 │
│  실제 투자 전 리스크 파악                                        │
│                                                                 │
│  🎯 핵심 질문                                                    │
│  ─────────────────────────────────────────────────────────────  │
│  1. 이 전략이 과거에 돈을 벌었는가?                              │
│  2. 최대 손실(MDD)은 얼마인가?                                  │
│  3. 승률은 얼마인가?                                            │
│  4. 다양한 시장 상황에서도 유효한가? (몬테카를로)                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 현실적 시뮬레이션 요소

```
┌─────────────────────────────────────────────────────────────────┐
│                    현실 반영 요소 (v2.7)                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  💸 슬리피지 (Slippage)                                         │
│  ─────────────────────────────────────────────────────────────  │
│  기본: 0.3% (매수/매도 시 불리한 방향으로 체결)                   │
│  거래량 5% 초과 주문 시 추가 슬리피지                            │
│                                                                 │
│  💰 세금 + 수수료                                                │
│  ─────────────────────────────────────────────────────────────  │
│  거래세: 0.23% (매도 시만)                                      │
│  수수료: 0.015% (매수+매도)                                     │
│                                                                 │
│  📉 유동성 필터                                                  │
│  ─────────────────────────────────────────────────────────────  │
│  최소 거래량: 50,000주 이상만 거래 가능                          │
│  거래량 부족 종목은 스킵                                         │
│                                                                 │
│  🤖 DeepSeek-V3 결정 모방                                        │
│  ─────────────────────────────────────────────────────────────  │
│  실제 API 호출 없이 수급 데이터 기반 점수 시뮬레이션              │
│  외국인/기관 순매수 → +점수                                     │
│  오버행 → -점수                                                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. 백테스트 설정

### 2.1 핵심 설정값

```python
# ═══════════════════════════════════════════════════════════════
#                      백테스트 설정 (BacktestConfig)
# ═══════════════════════════════════════════════════════════════

# 자본금
INITIAL_CAPITAL = 10_000_000     # 1,000만원

# 포지션
MAX_POSITION_PCT = 0.10          # 종목당 최대 10%
MAX_POSITIONS = 10               # 최대 보유 종목 수

# 청산 규칙
TAKE_PROFIT = 0.05               # +5% 익절
STOP_LOSS = -0.03                # -3% 손절
MAX_HOLD_DAYS = 10               # 최대 보유일

# 현실 시뮬레이션
SLIPPAGE_PCT = 0.003             # 0.3% 슬리피지
TAX_RATE = 0.0023                # 0.23% 거래세
COMMISSION_RATE = 0.00015        # 0.015% 수수료

# 유동성
MIN_VOLUME = 50_000              # 최소 거래량
VOLUME_IMPACT_THRESHOLD = 0.05   # 5% 초과시 추가 슬리피지

# DeepSeek-V3 시뮬레이션
AI_SCORE_MEAN = 72.0             # DeepSeek-V3 점수 평균
AI_SCORE_STD = 8.0               # DeepSeek-V3 점수 표준편차
AI_THRESHOLD = 65.0              # 매수 임계값
```

### 2.2 전략 타입

```
┌─────────────────────────────────────────────────────────────────┐
│                        전략 타입                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Type-A (Value)     : 저평가 턴어라운드                          │
│  Type-D (Sugeup)    : 수급 추적 (기본 전략)                      │
│  Type-E (Momentum)  : 테마/모멘텀                                │
│  Type-N (News)      : 뉴스 스나이핑                              │
│                                                                 │
│  * 현재 백테스터는 Type-D (수급 추적) 중심으로 구현               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. 백테스트 흐름

### 3.1 일일 루프

```
┌─────────────────────────────────────────────────────────────────┐
│                     백테스트 일일 루프                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  for each 거래일:                                                │
│                                                                 │
│  ① 큐에 있는 매수 실행 (시가 + 슬리피지)                         │
│     │                                                           │
│     ▼                                                           │
│  ② 보유 종목 청산 체크                                           │
│     │                                                           │
│     ├─ 수익률 ≥ +5%    → Take Profit                            │
│     ├─ 수익률 ≤ -3%    → Stop Loss                              │
│     └─ 보유일 ≥ 10일   → Time Stop                              │
│     │                                                           │
│     ▼                                                           │
│  ③ 신규 매수 후보 스크리닝                                       │
│     │                                                           │
│     ├─ 외국인 순매수 > 0                                        │
│     ├─ 기관 순매수 > 0                                          │
│     ├─ 오버행 < 5%                                              │
│     ├─ 유동성 충족                                              │
│     └─ DeepSeek-V3 점수 ≥ 65 (시뮬레이션)                       │
│     │                                                           │
│     ▼                                                           │
│  ④ 상위 3종목 매수 큐에 추가                                     │
│     │                                                           │
│     ▼                                                           │
│  ⑤ 자산 가치 기록 (Equity Curve)                                │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 매수/매도 실행

```
┌─────────────────────────────────────────────────────────────────┐
│                      매수 실행 상세                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  목표 매수가: 10,000원                                           │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ Step 1: 슬리피지 반영                                    │    │
│  │ ─────────────────────────────────────────────────────── │    │
│  │ 실제 매수가 = 10,000 + (10,000 × 0.3%)                   │    │
│  │            = 10,000 + 30                                 │    │
│  │            = 10,030원                                    │    │
│  └─────────────────────────────────────────────────────────┘    │
│                           │                                     │
│                           ▼                                     │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ Step 2: 수수료 계산                                      │    │
│  │ ─────────────────────────────────────────────────────── │    │
│  │ 매수 수수료 = 10,030 × 100주 × 0.015%                   │    │
│  │            = 150원                                       │    │
│  └─────────────────────────────────────────────────────────┘    │
│                           │                                     │
│                           ▼                                     │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ Step 3: 총 비용                                          │    │
│  │ ─────────────────────────────────────────────────────── │    │
│  │ 총 비용 = 10,030 × 100주 + 150원                        │    │
│  │        = 1,003,000 + 150                                │    │
│  │        = 1,003,150원                                    │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                      매도 실행 상세                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  목표 매도가: 10,500원                                           │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ Step 1: 슬리피지 반영                                    │    │
│  │ ─────────────────────────────────────────────────────── │    │
│  │ 실제 매도가 = 10,500 - (10,500 × 0.3%)                   │    │
│  │            = 10,500 - 31.5                               │    │
│  │            = 10,468원                                    │    │
│  └─────────────────────────────────────────────────────────┘    │
│                           │                                     │
│                           ▼                                     │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ Step 2: 세금 + 수수료                                    │    │
│  │ ─────────────────────────────────────────────────────── │    │
│  │ 거래세 = 10,468 × 100주 × 0.23% = 2,408원               │    │
│  │ 수수료 = 10,468 × 100주 × 0.015% = 157원                │    │
│  │ 총 비용 = 2,565원                                       │    │
│  └─────────────────────────────────────────────────────────┘    │
│                           │                                     │
│                           ▼                                     │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ Step 3: 순수익 계산                                      │    │
│  │ ─────────────────────────────────────────────────────── │    │
│  │ 매도 금액 = 10,468 × 100주 = 1,046,800원                │    │
│  │ 순수익 = 1,046,800 - 2,565 - 1,003,150                  │    │
│  │        = 41,085원 (+4.1%)                               │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 4. 성과 지표

### 4.1 핵심 지표

```
┌─────────────────────────────────────────────────────────────────┐
│                       성과 지표 설명                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  📊 Sharpe Ratio (샤프 비율)                                     │
│  ─────────────────────────────────────────────────────────────  │
│  공식: (연환산 수익률 - 무위험 이자율) / 연환산 변동성            │
│                                                                 │
│  해석:                                                          │
│  ≥ 1.0  →  ✅ 양호 (위험 대비 수익 적절)                        │
│  < 1.0  →  ⚠️ 개선 필요                                        │
│                                                                 │
│  ─────────────────────────────────────────────────────────────  │
│                                                                 │
│  📈 Profit Factor (수익 팩터)                                    │
│  ─────────────────────────────────────────────────────────────  │
│  공식: 총 이익 / 총 손실 (절대값)                                │
│                                                                 │
│  해석:                                                          │
│  ≥ 1.5  →  ✅ 양호 (이기는 금액이 지는 금액의 1.5배)            │
│  < 1.5  →  ⚠️ 수익/손실 비율 개선 필요                         │
│                                                                 │
│  ─────────────────────────────────────────────────────────────  │
│                                                                 │
│  📉 MDD (Maximum Drawdown)                                       │
│  ─────────────────────────────────────────────────────────────  │
│  공식: (최고점 - 최저점) / 최고점 × 100                          │
│                                                                 │
│  해석:                                                          │
│  ≤ 10%  →  ✅ 양호 (낙폭 관리 우수)                             │
│  > 10%  →  ⚠️ 리스크 관리 강화 필요                            │
│                                                                 │
│  ─────────────────────────────────────────────────────────────  │
│                                                                 │
│  🎯 Calmar Ratio (칼마 비율)                                     │
│  ─────────────────────────────────────────────────────────────  │
│  공식: 연환산 수익률 / MDD (절대값)                              │
│                                                                 │
│  해석: 낙폭 대비 수익률, 높을수록 좋음                           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 리포트 예시

```
═══════════════════════════════════════════════════════════════
📊 AEGIS v2.7 Advanced Backtest Report
═══════════════════════════════════════════════════════════════
Strategy       : Type-D (Supply Driven)
Period         : 2024-01-01 → 2024-11-30
───────────────────────────────────────────────────────────────
💰 CAPITAL
  Initial      :      10,000,000 KRW
  Final        :      11,250,000 KRW
  Return       :          12.50%
───────────────────────────────────────────────────────────────
📈 PERFORMANCE METRICS
  Sharpe Ratio :            1.25
  Profit Factor:            1.65
  MDD          :           -8.50%
  Calmar Ratio :            1.47
───────────────────────────────────────────────────────────────
🎯 TRADE STATISTICS
  Total Trades :              45
  Win / Loss   :      28 / 17
  Win Rate     :          62.22%
  Avg Win      :           4.50%
  Avg Loss     :          -2.80%
  Avg Hold Days:            5.2
───────────────────────────────────────────────────────────────
💸 COST ANALYSIS (Realistic)
  Slippage     :          45,000 KRW
  Tax          :          28,000 KRW
  Commission   :           8,500 KRW
  Total Costs  :          81,500 KRW (0.82%)
───────────────────────────────────────────────────────────────
```

---

## 5. 몬테카를로 시뮬레이션

### 5.1 목적

```
┌─────────────────────────────────────────────────────────────────┐
│                   몬테카를로 시뮬레이션 목적                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  🎲 왜 필요한가?                                                 │
│  ─────────────────────────────────────────────────────────────  │
│  백테스트 1회 = 특정 시장 조건의 결과                            │
│                                                                 │
│  다양한 조건에서 전략의 "강건성" 테스트:                         │
│  - 슬리피지가 더 클 수도 있음                                   │
│  - DeepSeek-V3 점수가 더 낮을 수도 있음                         │
│  - 시장 변동성이 더 클 수도 있음                                │
│                                                                 │
│  📊 결과 해석                                                    │
│  ─────────────────────────────────────────────────────────────  │
│  100회 시뮬레이션 후:                                           │
│  - 평균 수익률이 양수인가?                                      │
│  - 5% 최악 시나리오에서도 손실이 허용 범위인가?                  │
│  - 샤프 비율이 일관되게 양호한가?                                │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 시뮬레이션 방법

```
┌─────────────────────────────────────────────────────────────────┐
│                   몬테카를로 시뮬레이션 흐름                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  for i in range(100):  # 100회 반복                             │
│      │                                                          │
│      ▼                                                          │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ 조건 변형                                                │    │
│  │ ─────────────────────────────────────────────────────── │    │
│  │ 슬리피지 = 기본값 × random(0.8, 1.2)                    │    │
│  │ DeepSeek-V3 점수 평균 = 기본값 + random(-3, +3)         │    │
│  └─────────────────────────────────────────────────────────┘    │
│      │                                                          │
│      ▼                                                          │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ 백테스트 실행                                            │    │
│  │ ─────────────────────────────────────────────────────── │    │
│  │ 수익률, 샤프비율, MDD, 승률 기록                         │    │
│  └─────────────────────────────────────────────────────────┘    │
│      │                                                          │
│      ▼                                                          │
│  결과 집계 (평균, 표준편차, 5%/95% 분위)                        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 5.3 결과 해석

```
═══════════════════════════════════════════════════════════════
🎲 Monte Carlo Simulation Results
═══════════════════════════════════════════════════════════════
  Iterations   :          100
───────────────────────────────────────────────────────────────
  RETURN (%)
    Mean       :       10.50%      ← 평균 수익률
    Std        :        4.20%      ← 변동성
    5th Pctl   :        2.30%      ← 최악 5% 시나리오
    95th Pctl  :       18.70%      ← 최고 5% 시나리오
───────────────────────────────────────────────────────────────
  SHARPE RATIO
    Mean       :         1.15      ← 평균 샤프비율
    Std        :         0.35      ← 일관성
───────────────────────────────────────────────────────────────
  MDD (%)
    Mean       :        -7.80%     ← 평균 MDD
    Worst      :       -15.20%     ← 최악 MDD
═══════════════════════════════════════════════════════════════

📋 해석:
─────────────────────────────────────────────────────────────────
✅ 평균 수익률 10.5%: 전략 유효
✅ 5% 최악 시나리오에서도 +2.3%: 손실 리스크 낮음
✅ 평균 샤프 1.15: 위험 대비 수익 양호
⚠️ 최악 MDD -15.2%: 극단 상황 대비 필요
─────────────────────────────────────────────────────────────────
```

---

## 6. 사용 방법

### 6.1 기본 백테스트

```python
from backtester.engine_v2 import AdvancedBacktester, BacktestConfig

# 설정
config = BacktestConfig(
    initial_capital=10_000_000,  # 1,000만원
    slippage_pct=0.003,          # 0.3%
    take_profit=0.05,            # +5%
    stop_loss=-0.03,             # -3%
    max_hold_days=10
)

# 백테스터 생성
backtester = AdvancedBacktester(
    config=config,
    start_date='2024-01-01',
    end_date='2024-11-30'
)

# 실행
report = backtester.run()
```

### 6.2 몬테카를로 시뮬레이션

```python
from backtester.engine_v2 import run_monte_carlo, BacktestConfig

config = BacktestConfig(initial_capital=10_000_000)

# 100회 시뮬레이션
results = run_monte_carlo(
    config=config,
    start_date='2024-01-01',
    end_date='2024-11-30',
    iterations=100
)
```

---

## 7. 핵심 설정값 요약

```python
# ═══════════════════════════════════════════════════════════════
#                    백테스트 권장 설정값
# ═══════════════════════════════════════════════════════════════

# 자본금
INITIAL_CAPITAL = 10_000_000     # 시작 자금

# 청산 규칙 (Brain과 동일)
TAKE_PROFIT = 5.0                # +5% 익절
STOP_LOSS = -3.0                 # -3% 손절
MAX_HOLD_DAYS = 10               # 최대 보유일

# 현실 비용
SLIPPAGE = 0.3                   # 0.3% 슬리피지
TAX = 0.23                       # 0.23% 거래세
COMMISSION = 0.015               # 0.015% 수수료

# DeepSeek-V3 시뮬레이션
AI_SCORE_MEAN = 72               # DeepSeek-V3 평균 점수
AI_THRESHOLD = 65                # 매수 임계값

# 몬테카를로
MONTE_CARLO_ITERATIONS = 100     # 기본 반복 횟수
```

---

## 부록: 용어 정리

| 용어 | 설명 |
|-----|------|
| **Sharpe Ratio** | 위험 대비 수익률 (높을수록 좋음, ≥1.0 권장) |
| **Profit Factor** | 총이익/총손실 비율 (≥1.5 권장) |
| **MDD** | Maximum Drawdown, 최대 낙폭 (≤10% 권장) |
| **Calmar Ratio** | 연수익률/MDD (높을수록 좋음) |
| **Slippage** | 주문가와 체결가의 차이 |
| **Monte Carlo** | 무작위 변수로 여러 번 시뮬레이션하는 기법 |
| **Equity Curve** | 시간에 따른 자산 가치 그래프 |
| **Time Stop** | 최대 보유일 초과 시 강제 청산 |
