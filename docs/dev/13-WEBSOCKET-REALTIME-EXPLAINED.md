# KIS WebSocket 실시간 데이터: 40개의 정확한 의미

> 작성일: 2025-12-09
> 중요도: ⭐⭐⭐⭐⭐ (핵심 개념)

---

## 🤔 질문: "40개는 1초당 40개? 아니면 총 40개?"

**답변**: **동시에 구독 가능한 총 종목 수 = 40개**

---

## 📡 WebSocket의 작동 원리

### ❌ 잘못된 이해 (REST API 방식)

```
매초마다:
- 요청 1: 삼성전자 현재가 조회
- 요청 2: SK하이닉스 현재가 조회
- 요청 3: NAVER 현재가 조회
...
- 요청 40: 카카오 현재가 조회

→ 1초에 40번 요청 가능
→ 다음 초에 또 40번 요청
→ 매초 반복
```

**이게 아닙니다!**

---

### ✅ 올바른 이해 (WebSocket 구독 방식)

```
최초 구독 (한 번만):
├─ 삼성전자 구독 신청
├─ SK하이닉스 구독 신청
├─ NAVER 구독 신청
...
└─ 카카오 구독 신청 (총 40개)

이후 자동으로:
├─ 삼성전자: 체결 발생할 때마다 실시간 전송 (초당 수십~수백 건)
├─ SK하이닉스: 체결 발생할 때마다 실시간 전송
├─ NAVER: 체결 발생할 때마다 실시간 전송
...
└─ 카카오: 체결 발생할 때마다 실시간 전송

→ 구독 해제 전까지 계속 받음
→ 추가 요청 불필요
→ 서버가 알아서 push
```

---

## 🎯 핵심 차이점

### REST API (v2 방식)

```python
# 매초마다 반복 요청 필요
while True:
    for stock_code in watch_list:  # 2000개
        price = await kis_client.get_current_price(stock_code)
        # API 호출 1회

    await asyncio.sleep(1)  # 1초 대기 후 다시

# 문제:
# - 2000개 조회 = 2000번 API 호출
# - 1초에 2000번? 불가능!
# - 분산해도 너무 느림
# - API 제한 초과
```

### WebSocket (v3 방식)

```python
# 최초 1회만 구독
ws_manager = KISWebSocketManager()

# 40개 종목 구독 (한 번만)
for stock_code in top_40:
    await ws_manager.subscribe(stock_code)

# 이후 자동 수신 (무한 반복)
@ws_manager.on_price_update
async def handle_price(data):
    # 체결 발생 시 자동 호출됨
    # 초당 40개? 아니요!
    # 초당 수백~수천 건 수신 가능!
    print(f"{data['stock_code']}: {data['price']}")

# 특징:
# - 구독 후 계속 받음
# - 추가 요청 불필요
# - 체결 즉시 전송 (지연 0.1초 이내)
# - 40개 종목 모두 동시에 모니터링
```

---

## 📊 실시간 데이터 흐름

### 09:05:00 ~ 09:05:01 (1초 동안)

```
삼성전자:
├─ 09:05:00.123 - 체결 78,000원 (→ 즉시 수신)
├─ 09:05:00.456 - 체결 78,100원 (→ 즉시 수신)
├─ 09:05:00.789 - 체결 78,200원 (→ 즉시 수신)
└─ 09:05:00.901 - 체결 78,100원 (→ 즉시 수신)

SK하이닉스:
├─ 09:05:00.234 - 체결 150,000원 (→ 즉시 수신)
├─ 09:05:00.567 - 체결 150,500원 (→ 즉시 수신)
└─ 09:05:00.890 - 체결 150,300원 (→ 즉시 수신)

... (나머지 38개 종목도 동일)

→ 1초에 수백~수천 건 수신 가능!
→ 40개 제한은 "동시 구독 가능 종목 수"
→ 데이터 수신 개수가 아님!
```

**핵심**:
- **40개 = 동시에 모니터링 가능한 종목 수**
- **초당 수신 건수 = 무제한** (체결 발생량에 따라 수백~수천 건)

---

## 🔢 구체적 예시

### 시나리오 1: 조용한 종목

```
종목: 소형주 (거래 적음)
├─ 09:05:00 - 체결 1건
├─ 09:05:05 - 체결 1건
├─ 09:05:12 - 체결 1건
└─ 09:05:30 - 체결 1건

→ 1분에 4건 정도 수신
```

### 시나리오 2: 활발한 종목

```
종목: 삼성전자 (거래 많음)
├─ 09:05:00.000~09:05:00.999 - 체결 100건
├─ 09:05:01.000~09:05:01.999 - 체결 150건
├─ 09:05:02.000~09:05:02.999 - 체결 80건
└─ ...

→ 1초에 100~150건 수신
```

### 40개 종목 전체 (오전장 활발 시)

```
총 수신량 (1초):
- 삼성전자: 100건
- SK하이닉스: 80건
- NAVER: 60건
- 카카오: 70건
- ... (36개 더)
─────────────────
합계: 약 2,000~3,000건/초

→ 1초에 2,000~3,000건 수신 가능!
→ 40개 제한과 무관!
```

---

## 💡 왜 40개로 제한?

### KIS API 서버 부하 관리

```
사용자 1명당:
- WebSocket 연결 1개
- 동시 구독 40개까지

만약 무제한이라면:
- 사용자가 2,000개 구독
- 서버가 2,000개 실시간 전송
- 10,000명 사용자 = 2천만 개 스트림
- 서버 과부하!

40개 제한으로:
- 사용자당 40개 스트림
- 10,000명 = 40만 개 스트림
- 관리 가능한 수준
```

---

## 🎯 v3의 전략: 3-Layer 모니터링

### Layer 3: 전체 스캔 (2,000개)
```
07:20 - DeepSeek R1
├─ 전체 2,000개 종목 분석
└─ 상위 20개 선정
   → WebSocket Layer 1로 전달
```

### Layer 2: 빠른 스캔 (100개)
```
09:05~15:20 (1분마다)
├─ 등락률 상위 100개 조회 (REST API)
├─ gemini-2.0-flash 빠른 평가
└─ 70점 이상 발견 시
   → WebSocket Layer 1로 전달
```

### Layer 1: 실시간 모니터링 (40개)
```
09:00~15:30 (연결 유지)
├─ Priority 1: 보유종목 (10개)
├─ Priority 2: AI Daily Picks (20개)
└─ Priority 3: 급등주 (10개)
   ─────────────
   총 40개 동시 구독

실시간 수신:
├─ 체결가 (H0STCNT0)
├─ 호가 (H0STASP0)
└─ 프로그램 매매 (H0STPGM0)

→ 초당 2,000~3,000건 수신
→ 매수/매도 기회 즉시 포착
```

---

## 📈 REST vs WebSocket 비교

### REST API 방식 (불가능)

```
2,000개 종목 모니터링:
├─ 1초에 40개 조회 가능
├─ 2,000개 / 40개 = 50초
└─ 전체 스캔 = 50초 소요

결과:
- 실시간 아님 (50초 지연)
- 매수 기회 놓침
- API 제한 초과 위험
```

### WebSocket 방식 (현실적)

```
40개 종목 모니터링:
├─ 1회 구독 (0.1초)
├─ 이후 무한 수신
└─ 체결 즉시 전송 (0.1초 이내)

결과:
- 진짜 실시간
- 매수 기회 즉시 포착
- API 제한 무관
```

---

## 🔄 동적 구독 관리

### 구독 추가/제거

```python
# 오전 9시 - 보유 5 + Daily 20 = 25개 구독
await ws_manager.subscribe("005930", priority=1)  # 삼성전자
await ws_manager.subscribe("000660", priority=2)  # SK하이닉스
...

# 10시 - 급등주 발견 (Priority 3)
await ws_manager.subscribe("035720", priority=3)  # 카카오

# 슬롯 부족 시 (40개 초과)
# → Priority 3 중 가장 오래된 것 자동 제거
# → 새 종목 구독

# 14시 - 보유 종목 매도
await ws_manager.unsubscribe("005930")  # 삼성전자
# → 슬롯 1개 확보
```

**특징**:
- 구독/해제 자유로움
- 슬롯 여유 있으면 즉시 추가
- 슬롯 부족하면 Priority 기반 제거

---

## 📊 데이터 수신 통계 (예상)

### 오전장 활발 (09:00~10:00)

```
40개 종목 구독:
├─ 초당 수신: 2,000~3,000건
├─ 분당 수신: 120,000~180,000건
└─ 시간당 수신: 7,200,000~10,800,000건

1시간에 약 720만~1080만 건!
```

### 점심장 조용 (12:00~13:00)

```
40개 종목 구독:
├─ 초당 수신: 200~500건
├─ 분당 수신: 12,000~30,000건
└─ 시간당 수신: 720,000~1,800,000건

1시간에 약 72만~180만 건
```

---

## 🎯 최종 정리

### Q: "40개는 1초당 40개?"

**A**: ❌ **아닙니다!**

### Q: "그럼 총 40개?"

**A**: ✅ **맞습니다!**

**정확한 의미**:
```
40개 = 동시에 구독 가능한 종목 수 (최대 한도)

한 번 구독하면:
├─ 해제할 때까지 계속 수신
├─ 체결 발생 시마다 실시간 전송
├─ 초당 수신 건수 = 무제한
│   (거래량에 따라 수천 건 가능)
└─ 추가 요청 불필요
```

### 비유

```
REST API:
└─ 매초 40번 전화 걸어서 가격 물어보기
   (힘들고 느림)

WebSocket:
└─ 40개 종목에 "가격 바뀌면 알려줘" 한 번 말하기
   그 후 자동으로 계속 알려줌
   (편하고 빠름)
```

---

**작성**: Claude Code
**중요도**: ⭐⭐⭐⭐⭐ (핵심 개념 명확화)
**결론**: 40개 = 동시 구독 종목 수 (데이터 수신 횟수 아님!)
