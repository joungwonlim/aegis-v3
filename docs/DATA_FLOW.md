# AEGIS v3.0 - Data Flow (데이터 흐름)

*Version: 1.0*
*Last Updated: 2025-12-08*

---

## 1. Source of Truth 원칙

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      📌 SINGLE SOURCE OF TRUTH                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────┐                                                            │
│  │  KIS API    │  ← 원천 데이터 (실시간)                                     │
│  │  WebSocket  │                                                            │
│  └──────┬──────┘                                                            │
│         │                                                                    │
│         │ 쓰기 (Write Only)                                                 │
│         ▼                                                                    │
│  ┌─────────────┐                                                            │
│  │     DB      │  ← 단일 진실 공급원 (Single Source of Truth)                │
│  │ PostgreSQL  │                                                            │
│  └──────┬──────┘                                                            │
│         │                                                                    │
│         │ 읽기 (Read Only)                                                  │
│         ▼                                                                    │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                        모든 모듈                                     │    │
│  │  Brain | Dashboard | Scheduler | API | Telegram                     │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ✅ 규칙:                                                                   │
│  ├─ 읽기: 항상 DB에서                                                       │
│  ├─ 쓰기: KIS Fetcher → DB                                                  │
│  └─ 예외: 주문 직전 실시간 가격만 KIS API 직접 조회                          │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 보유종목 (Portfolio) 데이터 흐름

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      📊 PORTFOLIO DATA FLOW                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  [KIS WebSocket]                                                            │
│       │                                                                      │
│       │ 체결 알림                                                           │
│       ▼                                                                      │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐                   │
│  │ KIS Fetcher │────►│  portfolio  │◄────│    Brain    │                   │
│  │             │     │   테이블    │     │             │                   │
│  └─────────────┘     └─────────────┘     └─────────────┘                   │
│       │                    │                   │                            │
│       │                    │                   │                            │
│  WRITE 필드:          READ 모듈:          WRITE 필드:                       │
│  • quantity           • Dashboard         • ai_action                       │
│  • avg_price          • Scheduler         • stop_loss_price                 │
│  • current_price      • Telegram          • target_price                    │
│  • profit_rate        • Brain             • pyramid_stage                   │
│                                           • sell_stage                      │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Portfolio 테이블 필드별 Source

| 필드 | Write Source | 업데이트 시점 |
|------|-------------|--------------|
| `stock_code` | KIS Fetcher | 매수 체결 시 |
| `quantity` | KIS Fetcher | 매수/매도 체결 시 |
| `avg_price` | KIS Fetcher | 매수 체결 시 |
| `current_price` | KIS Fetcher | 실시간 (장중) |
| `profit_rate` | KIS Fetcher | 실시간 계산 |
| `pyramid_stage` | Brain | AI 분석 후 |
| `ai_action` | Brain | AI 분석 후 |
| `stop_loss_price` | Brain | AI 분석 후 |
| `target_price` | Brain | AI 분석 후 |
| `sell_stage` | Brain | 분할매도 시 |
| `max_price_reached` | System | 실시간 계산 |

---

## 3. 매매 기록 (Trade) 데이터 흐름

```
.
```

---

## 5. AI 분석 데이터 흐름

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      🧠 AI ANALYSIS DATA FLOW                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐                   │
│  │daily_prices │     │market_macro │     │ intel_feed  │                   │
│  │ (수급/기술) │     │ (VIX/환율)  │     │ (뉴스/공시) │                   │
│  └──────┬──────┘     └──────┬──────┘     └──────┬──────┘                   │
│         │                   │                   │                           │
│         └───────────────────┼───────────────────┘                           │
│                             │                                               │
│                             ▼                                               │
│                      ┌─────────────┐                                        │
│                      │    Brain    │                                        │
│                      │ Integration │                                        │
│                      └──────┬──────┘                                        │
│                             │                                               │
│         ┌───────────────────┼───────────────────┐                           │
│         ▼                   ▼                   ▼                           │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐                   │
│  │ daily_picks │     │  ai_reports │     │ market_     │                   │
│  │ (일일 추천) │     │ (AI 분석)   │     │ regime      │                   │
│  └─────────────┘     └─────────────┘     └─────────────┘                   │
│                                                                              │
│  daily_picks 필드:                                                          │
│  • stock_code, rank                                                         │
│  • quant_score, ai_score                                                    │
│  • expected_entry_price                                                     │
│  • is_executed (매수 여부)                                                  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. 데이터 갱신 주기

| 테이블 | 갱신 주기 | Source | 트리거 |
|--------|----------|--------|--------|
| `daily_prices` | 일 1회 | pykrx | 장 마감 후 (15:40) |
| `market_macro` | 일 1회 | yfinance | 장 시작 전 (08:30) |
| `portfolio` | 실시간 | KIS WebSocket | 체결 시 |
| `trade_logs` | 실시간 | KIS WebSocket | 체결 시 |
| `daily_picks` | 일 1회 | Brain | 장 시작 전 (08:50) |
| `trade_feedbacks` | 매도 시 | System | 매도 체결 후 |
| `intel_feed` | 5분 | DART/Naver | 정기 스케줄 |

---

## 7. 금지 사항

```
❌ Dashboard에서 KIS API 직접 호출
❌ Brain에서 KIS API 직접 호출
❌ Telegram에서 KIS API 직접 호출
❌ Scheduler에서 KIS API 직접 호출 (Fetcher 제외)

⚠️ 유일한 예외:
✅ 주문 실행 직전 실시간 가격 확인 → KIS API 직접 조회 허용
```

---

## 8. 매도 조건 예제

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            💹 매도 조건                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  매수가: 10,000원 기준                                                       │
│                                                                              │
│         손절                분할익절          트레일링          익절         │
│          │                    │                 │                │          │
│          ▼                    ▼                 ▼                ▼          │
│  ────────┼────────────────────┼─────────────────┼────────────────┼───────── │
│       9,800원             10,350원          10,500원         10,550원        │
│        -2%                 +3.5%              +5%             +5.5%          │
│          │                    │                 │                │          │
│          ▼                    ▼                 ▼                ▼          │
│      전량 매도            50% 매도         고점 추적        전량 매도        │
│      (손실 확정)         (이익 확보)         시작           (목표 달성)       │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 매도 규칙 상세

| 조건 | 가격 | 수익률 | 매도 비율 | 설명 |
|------|------|--------|----------|------|
| **손절** | 9,800원 | -2% | 100% | 손실 최소화, 즉시 청산 |
| **분할익절** | 10,350원 | +3.5% | 50% | 이익 일부 확보 |
| **트레일링 시작** | 10,500원 | +5% | - | 고점 추적 시작 |
| **익절** | 10,550원 | +5.5% | 나머지 전량 | 목표 달성 |

### 트레일링 스탑 로직

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         📈 트레일링 스탑 예제                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  매수가: 10,000원                                                           │
│  트레일링 시작: +5% (10,500원)                                              │
│  트레일링 폭: 고점 대비 -2%                                                 │
│                                                                              │
│  [가격 상승 시나리오]                                                       │
│                                                                              │
│  10,500원 ──► 10,800원 ──► 11,000원 ──► 10,780원                           │
│     │            │            │            │                                │
│     ▼            ▼            ▼            ▼                                │
│  트레일링     고점 갱신    고점 갱신    매도 트리거!                         │
│    시작       (+8%)       (+10%)      (고점 대비 -2%)                       │
│     │            │            │            │                                │
│  스탑가:     스탑가:      스탑가:      스탑가:                               │
│  10,290원    10,584원     10,780원     10,780원 ← 매도!                     │
│                                                                              │
│  결과: +7.8% 수익 확정 (고점 +10%에서 -2% 하락 시 청산)                     │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 9. 피라미딩 (분할매수) 예제

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         📊 피라미딩 전략                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  총 투자금: 1,000,000원                                                     │
│  목표 분할: 3단계                                                           │
│                                                                              │
│  ┌──────────┬──────────┬──────────┬──────────┐                             │
│  │  단계    │  비율    │  금액    │  조건    │                             │
│  ├──────────┼──────────┼──────────┼──────────┤                             │
│  │ 1차 정찰 │   30%    │ 300,000  │ AI 점수 ≥ 70 │                         │
│  │ 2차 본대 │   50%    │ 500,000  │ +2% 수익 확인 │                        │
│  │ 3차 불타기│   20%    │ 200,000  │ +5% 수익 확인 │                        │
│  └──────────┴──────────┴──────────┴──────────┘                             │
│                                                                              │
│  [실제 예제]                                                                │
│                                                                              │
│  1차: 10,000원 × 30주 = 300,000원  (pyramid_stage = 1)                     │
│       ↓ +2% 상승 확인                                                       │
│  2차: 10,200원 × 49주 = 500,000원  (pyramid_stage = 2)                     │
│       ↓ +5% 상승 확인                                                       │
│  3차: 10,500원 × 19주 = 200,000원  (pyramid_stage = 3)                     │
│                                                                              │
│  총: 98주 보유, 평균단가 10,204원, 총 투자 1,000,000원                      │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

*Document maintained by AEGIS Development Team*
