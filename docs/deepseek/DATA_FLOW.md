# AEGIS v3.1 데이터 흐름 문서

## 1. 개요
AEGIS(Algorithmic Equity Generation & Intelligent System) v3.1의 데이터 처리 파이프라인은 한국 주식시장을 대상으로 데이터 수집부터 매매 실행까지의 엔드투엔드 자동화 흐름을 정의합니다.

## 2. 처리 방식 구분

### 2.1 실시간 처리 (Real-time)
- **트리거**: 시장 개장 시간(09:00~15:30) 활성화
- **대상**: 
  - 주가 변동 감지 (초 단위)
  - 호가창 변화
  - 뉴스/공시 실시간 피드
  - 매매 신호 생성 및 실행
- **특징**: 이벤트 기반 처리, 우선순위 큐 사용

### 2.2 배치 처리 (Batch)
- **스케줄**:
  - **일간**: 08:30 (전일 데이터 정제), 18:00 (당일 데이터 정리)
  - **주간**: 토요일 02:00 (주간 리밸런싱)
  - **월간**: 월말 마지막 토요일 04:00 (팩터 재계산)
- **대상**:
  - 재무제표 정제
  - 팩터 스코어 재계산
  - AI 모델 재학습
  - 성과 분석 리포트

## 3. 데이터 흐름 단계별 상세

### 3.1 데이터 수집 (Data Collection)

소스 → 수집기 → 검증 → DB 저장


#### 3.1.1 데이터 소스
| 소스 | 주기 | 지연 시간 | 데이터 유형 |
|------|------|-----------|------------|
| **KIS API** | 실시간 | 0.5~2초 | 실시간 주가, 호가, 체결 |
| **pykrx** | 10분/일간 | 5분/다음일 | 종가, 거래량, 지표 |
| **DART** | 실시간/일간 | 0~30분 | 공시, 재무제표 |
| **야후 파이낸스** | 일간 | 15분 | 글로벌 지표, 환율 |

#### 3.1.2 오류 처리
- **데이터 누락**: 최대 3회 재시도, 실패 시 대체 데이터소스 활용
- **비정상 값**: IQR 기반 이상치 필터링, Z-score 검증
- **연결 실패**: 폴백 모드 (마지막 정상 데이터 사용 + 경고)

### 3.2 분석 파이프라인 (Analytics Pipeline)

Screener → Quant Score → AI Score → Final Score


#### 3.2.1 스크리너 (Screener)
- **입력**: 전체 종목 (2,800+)
- **필터링 기준**:
  1. 유동성 (일평균 거래대금 > 10억원)
  2. 시가총액 (> 500억원)
  3. 거래 정지 상태 제외
- **출력**: 150~200 종목
- **처리 시간**: 30초 (배치), 5초 (실시간)

#### 3.2.2 퀀트 스코어 (Quant Score)
- **팩터 모델**: 5개 카테고리 12개 팩터
  - 밸류 (PBR, PER, PCR)
  - 퀄리티 (ROE, 영업이익률, 부채비율)
  - 모멘텀 (3개월 수익률, 12개월 수익률)
  - 변동성 (베타, 변동성)
  - 성장 (매출성장률, 순이익성장률)
- **가중치**: 동적 가중치 (시장 레짐 기반)
- **처리 시간**: 45초

#### 3.2.3 AI 스코어
- **모델 1**: LSTM 기반 가격 예측 (단기, 5일)
- **모델 2**: Transformer 기반 시장 영향도 분석
- **모델 3**: GNN 기반 섹터 유사도 평가
- **앙상블**: 가중 투표 방식
- **처리 시간**: 60초 (GPU 가속 시 15초)

#### 3.2.4 최종 스코어
- **조합 방식**: Quant(40%) + AI(60%)
- **정규화**: Min-Max → Z-score 변환
- **출력**: 0~100 점수, 매수/중립/매도 추천

### 3.3 매매 실행 (Trading Execution)

Signal → Validation → Order → Execution


#### 3.3.1 신호 생성 (Signal)
- **기준**: Final Score ≥ 75 (매수), ≤ 25 (매도)
- **위험 관리**: 
  - 포지션 크기 제한 (최대 10% per trade)
  - 일간 최대 손실 제한 (-2%)
  - 섹터 과중집중 제한

#### 3.3.2 검증 (Validation)
1. **시장 상태**: 거래 가능 시간, 공휴일 확인
2. **유동성**: 호가창 깊이 검증
3. **위험 한도**: 포트폴리오 리스크 초과 여부
4. **중복 주문**: 동일 종목 중복 매매 방지
- **처리 시간**: 2초

#### 3.3.3 주문 전송 (Order)
- **주문 유형**:
  - **실시간**: 지정가 (80%), 시장가 (20%)
  - **배치**: VWAP, TWAP 알고리즘
- **단계적 주문**: 대형 주문 분할 실행
- **취소 정책**: 30초 미체결 시 부분 취소

#### 3.3.4 체결 (Execution)
- **체결 모니터링**: 실시간 체결률 추적
- **미체결 처리**: 10분 주기 재주문/취소 결정
- **실행 리포트**: 체결가, 수량, 비용 기록

### 3.4 피드백 루프 (Feedback Loop)

Result → Score Adjustment → Learning


#### 3.4.1 결과 분석 (Result)
- **일간**: 수익률, 승률, 샤프비율, 최대낙폭
- **주간**: 팩터 노출도, 섹터 배팅, 트랜잭션 비용
- **월간**: 벤치마크 대비 성과, AI 모델 예측력

#### 3.4.2 스코어 조정 (Score Adjustment)
- **동적 가중치**: 1개월 수익률 기반 팩터 가중치 조정
- **모델 재학습**: 주간 성과 하위 20% 모델 재훈련

#### 3.4.3 학습 (Learning)
- **강화학습**: 매매 행동 보상/패널티 학습
- **지도학습**: 새로운 라벨 데이터 추가
- **비지도학습**: 시장 구조 변화 감지

## 4. 데이터 지연 시간 요약

| 단계 | 평균 지연 | 최대 지연 | 비고 |
|------|-----------|-----------|------|
| 데이터 수집 | 3초 | 30초 | DART 공시 지연 포함 |
| 스크리닝 | 30초 | 60초 | 배치 기준 |
| 퀀트 스코어 | 45초 | 90초 | 팩터 계산 복잡도 |
| AI 스코어 | 60초 | 120초 | GPU 사용시 15초 |
| 신호 생성 | 5초 | 10초 | 실시간 |
| 검증 및 실행 | 10초 | 30초 | 주문 체결 시간 제외 |
| **종합** | **2분 33초** | **5분 40초** | 배치 프로세스 기준 |

## 5. 캐싱 전략 (Redis 활용)

### 5.1 캐시 계층 구조

L1: 인메모리 (실시간 데이터) → L2: Redis (중간 결과) → L3: PostgreSQL (원본 데이터)


### 5.2 캐싱 대상
| 데이터 유형 | TTL | 용도 |
|------------|-----|------|
| 실시간 주가 | 10초 | 신호 생성 |
| 호가창 | 5초 | 유동성 평가 |
| 종목 기본 정보 | 24시간 | 스크리닝 |
| 팩터 값 | 1시간 | 퀀트 스코어 |
| AI 예측 결과 | 30분 | AI 스코어 |
| 최종 스코어 | 15분 | 매매 신호 |

### 5.3 캐시 무효화 정책
- **시간 기반**: TTL 자동 만료
- **이벤트 기반**: 공시 발생, 시장 이벤트 시 삭제
- **버전 관리**: 데이터 구조 변경 시 캐시 전체 클리어

## 6. 모니터링 포인트

### 6.1 상태 확인 (Health Check)
```yaml
데이터 수집:
  - 수집 성공률: ≥ 99.5%
  - 데이터 신선도: < 5분 지연
  - 소스 연결 상태: 24/7

분석 파이프라인:
  - 처리 성공률: ≥ 99%
  - 단계별 처리 시간: 기준치 내
  - 스코어 분포: 정규 분포 유지

매매 실행:
  - 주문 성공률: ≥ 98%
  - 체결률: ≥ 95%
  - 평균 체결 시간: < 30초


### 6.2 경고 알림
- **위험** (PagerDuty): 데이터 연속 5분 이상 지연, 주문 실패율 5% 초과
- **경고** (Slack): 단계별 처리 시간 200% 초과, 캐시 적중률 80% 미만
- **정보** (대시보드): 일일 성과, 거래 요약, 시스템 부하

### 6.3 성능 지표
- **처리량**: 일일 50,000건 이상의 데이터 포인트 처리
- **지연**: 종목당 최종 스코어 산출 ≤ 3분
- **정확도**: AI 모델 예측 정확도 ≥ 55% (벤치마크 대비 +5%)
- **비용**: 거래비용 ≤ 0.15% (평균)

## 7. 장애 대응 절차

### 7.1 데이터 소스 장애
1. 1차 대체 소스로 전환 (5분 내)
2. 데이터 품질 저하 경고 발송
3. 수동 검증 모드 활성화 (필요 시)

### 7.2 분석 파이프라인 장애
1. 마지막 정상 스코어 캐시 활용 (24시간 한도)
2. 단순화된 퀀트 모델로 폴백
3. AI 모델 비활성화 및 경고

### 7.3 매매 시스템 장애
1. 자동 매매 중지, 수동 모드 전환
2. 미체결 주문 자동 취소
3. 위험 관리 규칙 강제 적용

## 8. 결론

AEGIS v3.1 데이터 흐름은 실시간 처리와 배치 처리를 명확히 구분하며, 각 단계별 데이터 지연을 최소화하기 위한 다층적 캐싱 전략을 도입했습니다. 엔드투엔드 모니터링 포인트를 통해 시스템 건강도를 실시간으로 파악할 수 있으며, 장애 발생 시 즉각적인 폴백 메커니즘이 작동합니다. 이 설계는 안정적인 자동매매 운영과 지속적인 시스템 개선의 기반을 제공합니다.

---
*문서 버전: v3.1.0*
*최종 업데이트: 2024년 1월*
*다음 검토 예정: 2024년 7월*

