# AEGIS v3.0 - Combat Architecture (전투 아키텍처)

*Version: 1.0*
*Last Updated: 2025-12-08*

---

## 핵심 철학 (Core Philosophy)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     🎯 AEGIS TRADING PHILOSOPHY                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  "0.001%를 올리기 위해 끊임없이 고민한다"                                   │
│  "1% 수익을 목표로, 우리는 반드시 해낸다"                                   │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  1. 수익률이 최우선                                                  │    │
│  │     • 모든 설계/구현의 목표는 수익률 향상                            │    │
│  │     • 가능성, 확률, 타이밍을 최적화                                  │    │
│  │     • 0.001%라도 개선할 수 있다면 실행                               │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  2. AI 판단은 반드시 검증                                            │    │
│  │     • AI 호출 = 비용 발생 → 가치 있는 판단만                         │    │
│  │     • 추천 Model + 추천 이유 + 점수 = 투명하게 기록                  │    │
│  │     • 사용자가 항상 "왜 이 판단을 했는지" 확인 가능                  │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  3. 결과 기반 보정 (Adaptive Feedback)                               │    │
│  │     • 매매 결과 → 점수 보정 → 다음 판단 개선                         │    │
│  │     • 시장 변화에 지속적 적응                                        │    │
│  │     • 틀린 판단은 인정하고 즉시 수정                                 │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### AI 판단 투명성 요구사항

모든 AI 분석 결과는 다음 정보를 **필수 기록**:

| 필드 | 설명 | 예시 |
|------|------|------|
| `model_used` | 사용된 AI 모델 | `deepseek-chat`, `deepseek-reasoner` |
| `reasoning` | 판단 근거 (2-3문장) | "외국인 5일 연속 순매수, 섹터 상승세..." |
| `score` | 점수 (0-100) | 78 |
| `confidence` | 확신도 (0-100) | 85 |
| `timestamp` | 분석 시점 | 2025-12-08 09:15:30 |
| `result` | 실제 결과 (사후 기록) | WIN +2.3% / LOSS -1.5% |
| `feedback_applied` | 보정 적용 여부 | +3점 / -2점 |

```python
# 모든 AI 분석 로그 예시
{
    "stock_code": "005930",
    "stock_name": "삼성전자",
    "model_used": "deepseek-chat",
    "action": "매수",
    "score": 78,
    "confidence": 85,
    "reasoning": "외국인 5일 연속 순매수 +150만주, SOX 지수 +1.09% 상승, 반도체 섹터 강세",
    "timestamp": "2025-12-08T09:15:30",
    # 사후 기록 (매도 체결 시)
    "result": "WIN",
    "profit_rate": 2.3,
    "feedback_applied": +3  # 점수 보정
}
```

---

## 0. 핵심 제약사항 (Critical Constraints)

### 0.1 Opus 세션 제약

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      ⚠️ OPUS SESSION LIMITATION                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Claude Opus는 Stateless API                                                │
│  • 매 호출이 독립적 (이전 대화 기억 못함)                                   │
│  • KIS WebSocket 데이터를 "직접 전달" 불가능                                │
│  • 세션 간 상태 공유 불가                                                   │
│                                                                              │
│  ❌ 불가능한 구조:                                                          │
│  ┌─────────────┐                    ┌─────────────┐                        │
│  │ KIS Socket  │ ──── 직접 ────►   │    OPUS     │                        │
│  └─────────────┘                    └─────────────┘                        │
│                                                                              │
│  ✅ 실제 구현 구조:                                                         │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐ │
│  │ KIS Socket  │───►│   Python    │───►│  DB/Cache   │───►│ Context     │ │
│  │ (실시간)    │    │  Handler    │    │  (상태저장) │    │ Builder     │ │
│  └─────────────┘    └─────────────┘    └─────────────┘    └──────┬──────┘ │
│                                                                   │        │
│                                                                   ▼        │
│                                                            ┌─────────────┐ │
│                                                            │    OPUS     │ │
│                                                            │ (프롬프트에 │ │
│                                                            │  상태 주입) │ │
│                                                            └─────────────┘ │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 0.2 Context Injection 패턴 (❌ 미구현)

> **⚠️ 현재 상태**: 설계만 완료, 코드 미구현
> - `brain/opus_context.py` - 미생성
> - `brain/opus_commander.py` - 미생성
> - `scheduler/main_scheduler.py` - Opus 연동 미반영

```python
# 매 Opus 호출 시 현재 상태를 프롬프트에 주입 (TODO: 구현 필요)

def build_opus_context() -> str:
    """
    DB/Cache에서 현재 상태를 읽어 프롬프트용 문자열 생성
    """
    return f"""
    === 현재 포트폴리오 상태 ===
    {get_portfolio_summary()}

    === 실시간 시세 ===
    {get_current_prices()}

    === 최근 알림/이벤트 ===
    {get_pending_alerts()}

    === DeepSeek 분석 결과 ===
    {get_latest_analysis()}

    === 시장 상황 ===
    {get_market_regime()}
    """

# Opus 호출
response = opus.call(
    system_prompt=OPUS_SYSTEM_PROMPT,
    user_message=build_opus_context() + "\n\n판단을 내려주세요."
)
```

### 0.3 AI 모델 역할 분담 (비용 최적화)

| 작업 | 담당 모델 | 호출 빈도 | 비용 |
|------|----------|----------|------|
| 손절/익절 자동 실행 | **Rule-based (코드)** | 실시간 | 무료 |
| 실시간 시세 분석 | **DeepSeek-V3** | 30초마다 | 저렴 |
| 종목 스코어링 | **DeepSeek-V3** | 5분마다 | 저렴 |
| 심층 전략 분석 | **DeepSeek-R1** | 1일 2회 | 중간 |
| **최종 매매 판단** | **Opus** | 필요시만 | 고가 |

```
호출 빈도 피라미드:

        ▲
       /│\     Opus (최종 판단)
      / │ \    - 대규모 매수/매도
     /  │  \   - 전략 변경
    /   │   \  - 비상 상황
   ─────┼─────
        │      DeepSeek-R1 (심층 분석)
        │      - 아침 브리핑
        │      - 저녁 리뷰
   ─────┼─────
        │      DeepSeek-V3 (실시간)
        │      - 시세 분석
        │      - 스코어링
   ─────┼─────
        │      Rule-based (코드)
   ─────┴───── - 손절/익절 자동
               - 호가 모니터링
               - 데이터 수집
```

### 0.4 상태 저장소 설계

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         STATE STORAGE DESIGN                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  PostgreSQL (영구 저장)                                              │    │
│  │  • trade_executions: 체결 내역                                       │    │
│  │  • trading_feedbacks: 피드백 결과                                    │    │
│  │  • quant_scores: 종목 점수                                           │    │
│  │  • ai_analysis_logs: AI 분석 이력                                    │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  Redis (실시간 캐시) - 선택사항                                      │    │
│  │  • realtime:prices:{stock_code}: 현재가                              │    │
│  │  • realtime:orderbook:{stock_code}: 호가                             │    │
│  │  • session:alerts: 미처리 알림                                       │    │
│  │  • session:market_regime: 현재 시장 상황                             │    │
│  │  • TTL: 5분 (자동 만료)                                              │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  In-Memory (Python 변수) - 현재 구현                                 │    │
│  │  • 스케줄러 실행 중에만 유효                                         │    │
│  │  • 재시작 시 초기화                                                  │    │
│  │  • 단순하지만 제한적                                                 │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 1. 지휘 체계 (Command Structure)

### 1.1 전체 구조도

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           AEGIS v3.0 COMMAND CENTER                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                     🎖️ OPUS (현장 지휘관)                            │    │
│  │  • Final Decision Maker (최종 의사결정)                              │    │
│  │  • Response Time: < 0.5s                                            │    │
│  │  • KIS Socket Direct Connection                                     │    │
│  │  • 실시간 체결/호가 수신 → 즉시 판단                                 │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                              ▲                                               │
│                              │ 작전 지시 / 상황 보고                         │
│                              ▼                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                     🧠 AI MODEL (후방 참모부)                         │    │
│  │  ┌─────────────────────┐    ┌─────────────────────┐                 │    │
│  │  │   DeepSeek-V3       │    │   DeepSeek-R1       │                 │    │
│  │  │   (실시간 분석)      │    │   (심층 추론)        │                 │    │
│  │  │   • 경량 분석        │    │   • 전략 수립        │                 │    │
│  │  │   • 빠른 응답        │    │   • 리스크 평가      │                 │    │
│  │  │   • 1-2s latency    │    │   • 5-30s latency   │                 │    │
│  │  └─────────────────────┘    └─────────────────────┘                 │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                              ▲                                               │
│                              │ 데이터 공급                                   │
│                              ▼                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                     🐜 FETCHERS (일개미 부대)                         │    │
│  │  ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐            │    │
│  │  │ KIS    │ │ KRX    │ │ DART   │ │ yfinance│ │ Naver  │            │    │
│  │  │Fetcher │ │Fetcher │ │Fetcher │ │Fetcher │ │Fetcher │            │    │
│  │  └────────┘ └────────┘ └────────┘ └────────┘ └────────┘            │    │
│  │  • 24시간 교대 근무                                                  │    │
│  │  • 스케줄 기반 데이터 수집                                           │    │
│  │  • 이상 감지 시 즉시 보고                                            │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 역할 정의

| 구분 | 역할 | 책임 | 응답 시간 |
|------|------|------|-----------|
| **Opus** | 현장 지휘관 | 최종 매매 결정, 긴급 대응, 실시간 판단 | < 0.5s |
| **DeepSeek-V3** | 전술 참모 | 실시간 분석, 종목 스코어링, 시장 상황 판단 | 1-2s |
| **DeepSeek-R1** | 전략 참모 | 심층 분석, 리밸런싱 전략, 주간 계획 수립 | 5-30s |
| **Fetchers** | 정보 수집반 | 데이터 수집, 전처리, 이상 탐지 | 실시간~1시간 |

---

## 2. 데이터 흐름도 (Data Flow)

### 2.1 실시간 데이터 파이프라인

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        REALTIME DATA PIPELINE                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  [KIS WebSocket]                                                             │
│       │                                                                      │
│       ├──────────────────────────────────────────┐                          │
│       │                                          │                          │
│       ▼                                          ▼                          │
│  ┌─────────────┐                          ┌─────────────┐                   │
│  │ 체결 통보    │                          │ 호가 데이터  │                   │
│  │ (H0STCNT0)  │                          │ (H0STASP0)  │                   │
│  └─────────────┘                          └─────────────┘                   │
│       │                                          │                          │
│       │         ┌───────────────────┐           │                          │
│       └────────►│   OPUS (지휘관)    │◄──────────┘                          │
│                 │                   │                                        │
│                 │  • 체결가 모니터링  │                                        │
│                 │  • 손절/익절 판단   │                                        │
│                 │  • 긴급 매도 실행   │                                        │
│                 └─────────┬─────────┘                                        │
│                           │                                                  │
│                           │ 분석 요청 (필요시)                                │
│                           ▼                                                  │
│                 ┌───────────────────┐                                        │
│                 │   DeepSeek-V3     │                                        │
│                 │   (실시간 분석)    │                                        │
│                 └───────────────────┘                                        │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 배치 데이터 파이프라인

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         BATCH DATA PIPELINE                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐      │
│  │ yfinance │  │   KRX    │  │   DART   │  │  Naver   │  │  Reddit  │      │
│  │  (US)    │  │  (KR)    │  │ (공시)   │  │ (테마)   │  │ (심리)   │      │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘      │
│       │             │             │             │             │             │
│       │  06:00      │  07:00      │  08:00      │  09:00      │  06:30     │
│       ▼             ▼             ▼             ▼             ▼             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        PostgreSQL Database                           │   │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐           │   │
│  │  │global_idx │ │ stocks    │ │disclosures│ │ themes    │           │   │
│  │  └───────────┘ └───────────┘ └───────────┘ └───────────┘           │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    │ 07:20 BRAIN 분석                       │
│                                    ▼                                        │
│                          ┌───────────────────┐                              │
│                          │   DeepSeek-R1     │                              │
│                          │   (심층 분석)      │                              │
│                          └─────────┬─────────┘                              │
│                                    │                                        │
│                                    │ 분석 결과                               │
│                                    ▼                                        │
│                          ┌───────────────────┐                              │
│                          │   OPUS Briefing   │                              │
│                          │   (08:00 작전회의) │                              │
│                          └───────────────────┘                              │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.3 데이터 우선순위 (Priority)

| 우선순위 | 데이터 소스 | 갱신 주기 | 용도 |
|----------|------------|-----------|------|
| **P0** | KIS WebSocket | 실시간 | 체결가, 호가, 긴급 판단 |
| **P1** | KIS REST API | 30초 | 잔고, 주문 상태 |
| **P2** | DART 공시 | 5분 | 재료 감지, 급등락 예측 |
| **P3** | KRX 시세 | 10분 | 거래량, 외국인/기관 |
| **P4** | yfinance | 1시간 | 글로벌 지표, 상관관계 |

---

## 3. 시간대별 작전표 (Daily Operations)

### 3.1 전투 일과표

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         DAILY COMBAT SCHEDULE                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ═══════════════════════ 새벽 정찰 (06:00~07:00) ═══════════════════════    │
│                                                                              │
│  06:00 ┃ 📊 US Market Close                                                 │
│        ┃ • yfinance: S&P500, NASDAQ, VIX 수집                               │
│        ┃ • global_market_indices 테이블 갱신                                │
│        ┃                                                                     │
│  06:30 ┃ 🌍 Global Sentiment Scan                                           │
│        ┃ • Reddit/Twitter 감성 분석                                          │
│        ┃ • 아시아 선물 지수 확인                                             │
│                                                                              │
│  ═══════════════════════ 작전 회의 (07:00~08:30) ═══════════════════════    │
│                                                                              │
│  07:00 ┃ 🔄 KRX 데이터 동기화                                               │
│        ┃ • 전일 수급 데이터                                                  │
│        ┃ • 공매도 현황                                                       │
│        ┃                                                                     │
│  07:20 ┃ 🧠 BRAIN 심층 분석 [DeepSeek-R1]                                   │
│        ┃ • 금일 시장 전망                                                    │
│        ┃ • 주력 종목 선정                                                    │
│        ┃ • 리스크 시나리오                                                   │
│        ┃                                                                     │
│  08:00 ┃ 📋 OPUS Briefing                                                   │
│        ┃ • AI 분석 결과 수령                                                 │
│        ┃ • 금일 작전 계획 확정                                               │
│        ┃ • 매매 한도 설정                                                    │
│                                                                              │
│  ═══════════════════════ 전투 개시 (09:00~15:30) ═══════════════════════    │
│                                                                              │
│  08:50 ┃ 🔌 KIS WebSocket 연결                                              │
│        ┃ • 체결 통보 구독                                                    │
│        ┃ • 호가 데이터 구독                                                  │
│        ┃                                                                     │
│  09:00 ┃ ⚔️ COMBAT START                                                    │
│   ~    ┃ • auto_trading 30초마다 실행                                       │
│  15:30 ┃ • 실시간 분석 [DeepSeek-V3]                                        │
│        ┃ • OPUS 최종 판단 및 체결                                            │
│        ┃                                                                     │
│  10:00 ┃ 📊 중간 점검                                                       │
│        ┃ • 포트폴리오 상태                                                   │
│        ┃ • 손익 현황                                                         │
│        ┃                                                                     │
│  11:30 ┃ 🍽️ 점심 시간대 저변동                                              │
│   ~    ┃ • 모니터링 유지                                                     │
│  13:00 ┃ • 급등락 감시                                                       │
│        ┃                                                                     │
│  14:30 ┃ 🎯 마감 대비                                                       │
│        ┃ • 당일 청산 검토                                                    │
│        ┃ • 익절/손절 최종 판단                                               │
│                                                                              │
│  ═══════════════════════ 전투 종료 (15:30~) ═══════════════════════════     │
│                                                                              │
│  15:30 ┃ 🏁 COMBAT END                                                      │
│        ┃ • KIS WebSocket 연결 해제                                          │
│        ┃ • 포트폴리오 동기화                                                 │
│        ┃                                                                     │
│  16:00 ┃ 📊 일일 정산 [DeepSeek-R1]                                         │
│        ┃ • 당일 매매 분석                                                    │
│        ┃ • 피드백 반영                                                       │
│        ┃ • 점수 재계산                                                       │
│        ┃                                                                     │
│  18:00 ┃ 🔔 Evening Report                                                  │
│        ┃ • 일일 리포트 생성                                                  │
│        ┃ • Telegram 알림 발송                                                │
│                                                                              │
│  ═══════════════════════ NXT 야간 (향후) ═══════════════════════════════    │
│                                                                              │
│  18:00 ┃ 🌙 NXT Session Start (미구현)                                      │
│   ~    ┃ • hour='9-20' 적용 예정                                            │
│  20:00 ┃ • 야간 거래 지원                                                    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 작전 타임라인 시각화

```
06:00    07:00    08:00    09:00    10:00    11:00    12:00    13:00    14:00    15:00    16:00
  │        │        │        │        │        │        │        │        │        │        │
  ├────────┼────────┼────────┼────────┴────────┴────────┴────────┴────────┼────────┼────────┤
  │ 새벽   │ 작전   │ 브리핑 │              ⚔️ COMBAT ZONE                │ 정산   │ 리포트 │
  │ 정찰   │ 회의   │        │                                            │        │        │
  ├────────┼────────┼────────┼────────────────────────────────────────────┼────────┼────────┤
  │        │        │        │                                            │        │        │
  │ US     │ BRAIN  │ OPUS   │  OPUS + DeepSeek-V3 (실시간)               │DeepSeek│        │
  │ Close  │ R1     │ Ready  │                                            │   R1   │        │
  │        │        │        │                                            │        │        │
```

---

## 4. 피드백 루프 (Feedback Loop)

### 4.1 실시간 피드백 시스템

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        REALTIME FEEDBACK SYSTEM                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│     ┌────────────────────────────────────────────────────────┐              │
│     │                    TRADING CYCLE                        │              │
│     │                                                         │              │
│     │  ┌─────────┐    ┌─────────┐    ┌─────────┐            │              │
│     │  │  매수   │───►│  보유   │───►│  매도   │            │              │
│     │  │ 체결   │    │ 모니터링 │    │ 체결   │            │              │
│     │  └─────────┘    └─────────┘    └────┬────┘            │              │
│     │                                      │                 │              │
│     └──────────────────────────────────────│─────────────────┘              │
│                                            │                                │
│                                            ▼                                │
│                              ┌─────────────────────────┐                    │
│                              │    FEEDBACK TRIGGER     │                    │
│                              │    (매도 체결 이벤트)    │                    │
│                              └───────────┬─────────────┘                    │
│                                          │                                  │
│                   ┌──────────────────────┼──────────────────────┐          │
│                   │                      │                      │          │
│                   ▼                      ▼                      ▼          │
│         ┌─────────────────┐   ┌─────────────────┐   ┌─────────────────┐   │
│         │  결과 기록       │   │  손익 분석       │   │  점수 조정       │   │
│         │                 │   │                 │   │                 │   │
│         │ • trade_id      │   │ • 수익률 계산    │   │ • 성공: +점수    │   │
│         │ • profit_rate   │   │ • 보유 기간      │   │ • 실패: -점수    │   │
│         │ • result        │   │ • 시장 상황      │   │ • 패턴 학습      │   │
│         └────────┬────────┘   └────────┬────────┘   └────────┬────────┘   │
│                  │                     │                     │             │
│                  └─────────────────────┴─────────────────────┘             │
│                                        │                                    │
│                                        ▼                                    │
│                           ┌─────────────────────────┐                      │
│                           │   DATABASE UPDATE       │                      │
│                           │                         │                      │
│                           │ • trading_feedbacks     │                      │
│                           │ • quant_scores          │                      │
│                           │ • ai_score_adjustments  │                      │
│                           └───────────┬─────────────┘                      │
│                                       │                                     │
│                                       ▼                                     │
│                           ┌─────────────────────────┐                      │
│                           │   NEXT TRADING CYCLE    │                      │
│                           │   (반영된 점수로 판단)   │                      │
│                           └─────────────────────────┘                      │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 피드백 점수 조정 규칙

```python
# 피드백 점수 조정 로직 (v2.8 기준)

class FeedbackScoreAdjustment:
    """
    매도 결과에 따른 점수 조정
    """

    # 수익 구간별 조정 점수
    PROFIT_ADJUSTMENTS = {
        (5.0, float('inf')): +5,   # 5% 이상 수익 → +5점
        (2.0, 5.0): +3,            # 2~5% 수익 → +3점
        (0.5, 2.0): +1,            # 0.5~2% 수익 → +1점
        (-1.0, 0.5): 0,            # -1~0.5% → 조정 없음
        (-3.0, -1.0): -2,          # -1~-3% 손실 → -2점
        (float('-inf'), -3.0): -5  # -3% 이상 손실 → -5점
    }

    # 보유 기간 보정
    HOLDING_PERIOD_BONUS = {
        'short_term': 1.2,   # 3일 이내 익절 → 20% 보너스
        'medium_term': 1.0,  # 3~10일 → 기본
        'long_term': 0.8     # 10일 초과 → 20% 페널티
    }
```

### 4.3 피드백 데이터 흐름

| 단계 | 테이블 | 데이터 | 용도 |
|------|--------|--------|------|
| 1. 체결 | `trade_executions` | 매수/매도 체결 정보 | 거래 기록 |
| 2. 결과 | `trading_feedbacks` | 손익률, 결과 판정 | 피드백 저장 |
| 3. 조정 | `ai_score_adjustments` | 점수 변동 내역 | 조정 이력 |
| 4. 반영 | `quant_scores` | 갱신된 종목 점수 | 다음 판단 기준 |

---

## 5. 비상 프로토콜 (Emergency Protocol)

### 5.1 긴급 상황 분류

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         EMERGENCY CLASSIFICATION                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  🔴 LEVEL 1: CRITICAL (즉시 대응)                                    │    │
│  │  • 시스템 장애 (DB 연결 실패, API 오류)                              │    │
│  │  • 포트폴리오 전체 손실 -5% 이상                                     │    │
│  │  • KIS API 토큰 만료                                                 │    │
│  │  ► 대응: 즉시 매매 중단, 알림 발송, 수동 개입 요청                   │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  🟠 LEVEL 2: WARNING (경계)                                          │    │
│  │  • 개별 종목 -3% 이상 손실                                           │    │
│  │  • API 응답 지연 (5초 이상)                                          │    │
│  │  • 비정상적 거래량 감지                                               │    │
│  │  ► 대응: 해당 종목 매매 일시 중지, 모니터링 강화                     │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  🟡 LEVEL 3: CAUTION (주의)                                          │    │
│  │  • 시장 급변 (KOSPI ±2% 이상)                                        │    │
│  │  • VIX 급등 (30 이상)                                                │    │
│  │  • 외국인 대량 매도                                                   │    │
│  │  ► 대응: 신규 매수 보류, 기존 포지션 유지                            │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 긴급 대응 플로우

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        EMERGENCY RESPONSE FLOW                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   이상 감지                                                                  │
│       │                                                                      │
│       ▼                                                                      │
│  ┌─────────────┐                                                            │
│  │ 레벨 판정   │                                                            │
│  └──────┬──────┘                                                            │
│         │                                                                    │
│    ┌────┴────┬────────────┐                                                 │
│    │         │            │                                                 │
│    ▼         ▼            ▼                                                 │
│ LEVEL 1   LEVEL 2     LEVEL 3                                               │
│    │         │            │                                                 │
│    ▼         ▼            ▼                                                 │
│ ┌──────┐ ┌──────┐    ┌──────┐                                              │
│ │ 매매 │ │ 해당 │    │ 신규 │                                              │
│ │ 전면 │ │ 종목 │    │ 매수 │                                              │
│ │ 중단 │ │ 중지 │    │ 보류 │                                              │
│ └──┬───┘ └──┬───┘    └──┬───┘                                              │
│    │        │           │                                                   │
│    ▼        ▼           ▼                                                   │
│ ┌──────────────────────────┐                                                │
│ │    Telegram 알림 발송     │                                                │
│ └────────────┬─────────────┘                                                │
│              │                                                               │
│              ▼                                                               │
│ ┌──────────────────────────┐                                                │
│ │    로그 기록 (DB)         │                                                │
│ └────────────┬─────────────┘                                                │
│              │                                                               │
│              ▼                                                               │
│ ┌──────────────────────────┐                                                │
│ │    상황 해제 대기         │                                                │
│ └──────────────────────────┘                                                │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.3 Circuit Breaker 설정

```python
# utils/safety.py 에서 관리

CIRCUIT_BREAKER_CONFIG = {
    # 포트폴리오 전체 손실 한도
    'portfolio_max_loss': -5.0,  # -5% 도달 시 전면 중단

    # 개별 종목 손실 한도
    'position_stop_loss': -3.0,  # -3% 도달 시 자동 매도

    # 일일 매매 횟수 제한
    'max_trades_per_day': 20,

    # 연속 손실 제한
    'max_consecutive_losses': 3,  # 3연속 손실 시 신규 매수 중단

    # 시장 급변 감지
    'market_volatility_threshold': 2.0,  # KOSPI ±2%
}
```

---

## 6. 모니터링 대시보드 (Monitoring)

### 6.1 실시간 지표

| 지표 | 정상 범위 | 경고 | 위험 |
|------|-----------|------|------|
| API 응답 시간 | < 1s | 1-5s | > 5s |
| DB 연결 상태 | Connected | Reconnecting | Failed |
| 포트폴리오 손익 | > -2% | -2% ~ -5% | < -5% |
| 메모리 사용량 | < 70% | 70-90% | > 90% |
| 오류 발생률 | < 1% | 1-5% | > 5% |

### 6.2 로깅 전략

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           LOGGING STRATEGY                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  📊 Level: INFO                                                      │    │
│  │  • 매매 체결 로그                                                    │    │
│  │  • 스케줄러 Job 실행                                                 │    │
│  │  • API 호출 성공                                                     │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  ⚠️ Level: WARNING                                                   │    │
│  │  • API 재시도                                                        │    │
│  │  • 손절 발동                                                         │    │
│  │  • 비정상 데이터 감지                                                 │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  🔴 Level: ERROR                                                     │    │
│  │  • API 호출 실패                                                     │    │
│  │  • DB 연결 실패                                                      │    │
│  │  • 주문 실패                                                         │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  💀 Level: CRITICAL                                                  │    │
│  │  • 시스템 다운                                                       │    │
│  │  • 대규모 손실                                                       │    │
│  │  • 보안 위반                                                         │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 7. 구현 상태 체크리스트

### 7.1 현재 구현 완료

- [x] Fetchers (일개미 부대) - 데이터 수집
- [x] Scheduler (APScheduler) - 스케줄 관리
- [x] DeepSeek-V3 연동 - 실시간 분석
- [x] DeepSeek-R1 연동 - 심층 분석
- [x] Feedback Loop v2.8 - 피드백 시스템
- [x] Circuit Breaker - 안전장치
- [x] Telegram Alert - 알림 시스템

### 7.2 코드 현황 (AS-IS)

| 항목 | 파일 | 상태 | 설명 |
|------|------|------|------|
| `AiAnalyzer` 클래스 | `brain/analyzer.py` | ✅ 완료 | GeminiAnalyzer → AiAnalyzer 리네임 |
| DeepSeek-V3 연동 | `brain/analyzer.py` | ✅ 완료 | `deepseek-chat` 모델 사용 중 |
| DeepSeek-R1 연동 | `brain/validator.py` | ✅ 완료 | `deepseek-reasoner` 고가 검증용 |
| 하위 호환성 | `brain/analyzer.py` | ✅ 완료 | `GeminiAnalyzer = AiAnalyzer` 별칭 |

### 7.3 구현 예정 (Opus 통합)

| 항목 | 파일 | 상태 | 설명 |
|------|------|------|------|
| `build_opus_context()` | `brain/opus_context.py` | ❌ 미구현 | DB에서 현재 상태 읽어 프롬프트 생성 |
| Opus 호출 로직 | `brain/opus_commander.py` | ❌ 미구현 | Context 주입 후 Opus API 호출 |
| main_scheduler.py 연동 | `scheduler/main_scheduler.py` | ❌ 미반영 | Opus 호출 Job 추가 필요 |
| 상태 저장 테이블 | `database/models.py` | ⚠️ 부분 | `realtime_state` 테이블 추가 필요 |

```
구현 우선순위:

1. build_opus_context()     ← 핵심 (Context Injection)
2. opus_commander.py        ← Opus API 래퍼
3. main_scheduler.py 연동   ← Job 등록
4. 상태 저장 최적화         ← Redis 도입 (선택)
```

### 7.4 구현 예정 (NXT 대응)

- [ ] KIS WebSocket 직접 연동
- [ ] NXT 야간 거래 (hour='9-20')
- [ ] 실시간 호가 분석
- [ ] 고빈도 스캘핑 모드

---

*Document maintained by AEGIS Development Team*
*Last review: 2025-12-08*
