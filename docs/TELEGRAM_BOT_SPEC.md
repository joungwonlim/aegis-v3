# AEGIS v3.0 - Telegram Bot Specification

*Version: 1.0*
*Last Updated: 2025-12-08*

---

## 1. 아키텍처 원칙

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      📱 EVENT-DRIVEN WATCHER PATTERN                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ❌ 기존 문제점 (분산된 알림 로직):                                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                         │
│  │  Scheduler  │  │    Brain    │  │  AutoTrader │                         │
│  │ send_msg()  │  │ send_msg()  │  │ send_msg()  │                         │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘                         │
│         │                │                │                                 │
│         └────────────────┼────────────────┘                                 │
│                          ▼                                                  │
│                   ┌─────────────┐                                           │
│                   │  Telegram   │  ← 로직 분산, 일관성 없음                  │
│                   └─────────────┘                                           │
│                                                                              │
│  ✅ 개선된 구조 (이벤트 기반 Watcher):                                       │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                         │
│  │  Scheduler  │  │    Brain    │  │  AutoTrader │                         │
│  │ emit_event()│  │ emit_event()│  │ emit_event()│                         │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘                         │
│         │                │                │                                 │
│         └────────────────┼────────────────┘                                 │
│                          ▼                                                  │
│                   ┌─────────────┐                                           │
│                   │   Event     │  ← 단일 이벤트 버스                        │
│                   │    Bus      │                                           │
│                   └──────┬──────┘                                           │
│                          │                                                  │
│                          ▼                                                  │
│                   ┌─────────────┐                                           │
│                   │  Telegram   │  ← Watcher가 이벤트 수신 후 알림           │
│                   │   Watcher   │                                           │
│                   └─────────────┘                                           │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 이벤트 타입 정의

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         📋 EVENT TYPES                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌────────────────┬──────────────────────────────────────────────────────┐  │
│  │  이벤트 타입   │  설명                                                │  │
│  ├────────────────┼──────────────────────────────────────────────────────┤  │
│  │  TRADE_BUY     │  매수 체결                                           │  │
│  │  TRADE_SELL    │  매도 체결                                           │  │
│  │  STOP_LOSS     │  손절 발동                                           │  │
│  │  TAKE_PROFIT   │  익절 달성                                           │  │
│  │  TRAILING_STOP │  트레일링 스탑 발동                                  │  │
│  ├────────────────┼──────────────────────────────────────────────────────┤  │
│  │  SIGNAL_NEW    │  새로운 매수 시그널                                  │  │
│  │  SIGNAL_ALERT  │  긴급 시그널 (급등/급락)                             │  │
│  ├────────────────┼──────────────────────────────────────────────────────┤  │
│  │  DAILY_REPORT  │  일일 리포트                                         │  │
│  │  MARKET_OPEN   │  장 시작 알림                                        │  │
│  │  MARKET_CLOSE  │  장 마감 알림                                        │  │
│  ├────────────────┼──────────────────────────────────────────────────────┤  │
│  │  ERROR         │  시스템 에러                                         │  │
│  │  WARNING       │  경고 (API 한도, 연결 끊김 등)                       │  │
│  └────────────────┴──────────────────────────────────────────────────────┘  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 이벤트 데이터 구조

```python
# 이벤트 기본 구조
class TelegramEvent:
    event_type: str       # TRADE_BUY, SIGNAL_NEW, ERROR 등
    priority: str         # HIGH, MEDIUM, LOW
    timestamp: datetime
    data: dict            # 이벤트별 상세 데이터

# 예시: 매수 체결 이벤트
{
    "event_type": "TRADE_BUY",
    "priority": "HIGH",
    "timestamp": "2025-12-08T09:15:30",
    "data": {
        "stock_code": "005930",
        "stock_name": "삼성전자",
        "quantity": 10,
        "price": 52300,
        "strategy": "Type-D",
        "ai_score": 78,
        "model_used": "deepseek-chat",
        "reason": "외국인 5일 연속 순매수"
    }
}
```

---

## 3. Watcher 모듈 구조

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      🔍 TELEGRAM WATCHER                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  services/                                                                  │
│  └── telegram/                                                              │
│      ├── __init__.py                                                        │
│      ├── event_bus.py         ← 이벤트 버스 (싱글톤)                        │
│      ├── watcher.py           ← 이벤트 수신 + 메시지 포맷팅                 │
│      ├── sender.py            ← 텔레그램 API 호출                           │
│      ├── templates.py         ← 메시지 템플릿                               │
│      └── commands.py          ← 사용자 명령 처리 (/status, /balance 등)    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 핵심 컴포넌트

```python
# event_bus.py - 싱글톤 이벤트 버스
class EventBus:
    _instance = None
    _listeners: List[Callable] = []

    @classmethod
    def emit(cls, event: TelegramEvent):
        """이벤트 발행"""
        for listener in cls._listeners:
            listener(event)

    @classmethod
    def subscribe(cls, listener: Callable):
        """리스너 등록"""
        cls._listeners.append(listener)

# watcher.py - 이벤트 수신 및 처리
class TelegramWatcher:
    def __init__(self):
        EventBus.subscribe(self.on_event)

    def on_event(self, event: TelegramEvent):
        """이벤트 수신 시 처리"""
        message = self.format_message(event)
        if event.priority == "HIGH":
            self.send_immediately(message)
        else:
            self.queue_message(message)
```

---

## 4. 메시지 템플릿

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      💬 MESSAGE TEMPLATES                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  [TRADE_BUY]                                                                │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ 🟢 매수 체결                                                        │    │
│  │ ━━━━━━━━━━━━━━━━━━━━━━━                                            │    │
│  │ 종목: 삼성전자 (005930)                                             │    │
│  │ 수량: 10주 × 52,300원                                              │    │
│  │ 금액: 523,000원                                                     │    │
│  │ ───────────────────                                                 │    │
│  │ 전략: Type-D (수급추적)                                             │    │
│  │ AI점수: 78점                                                        │    │
│  │ 모델: deepseek-chat                                                 │    │
│  │ 사유: 외국인 5일 연속 순매수                                        │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  [TRADE_SELL]                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ 🔴 매도 체결                                                        │    │
│  │ ━━━━━━━━━━━━━━━━━━━━━━━                                            │    │
│  │ 종목: 삼성전자 (005930)                                             │    │
│  │ 수량: 10주 × 53,500원                                              │    │
│  │ ───────────────────                                                 │    │
│  │ 수익률: +2.3% ✅                                                    │    │
│  │ 수익금: +12,000원                                                   │    │
│  │ 보유기간: 3일                                                       │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  [STOP_LOSS]                                                                │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ ⚠️ 손절 발동                                                        │    │
│  │ ━━━━━━━━━━━━━━━━━━━━━━━                                            │    │
│  │ 종목: 한국전력 (015760)                                             │    │
│  │ 손실: -2.1% (-21,000원)                                            │    │
│  │ ───────────────────                                                 │    │
│  │ 매수가: 50,000원                                                    │    │
│  │ 손절가: 48,950원                                                    │    │
│  │ 사유: 손절 기준 -2% 도달                                            │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  [DAILY_REPORT]                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ 📊 일일 리포트 (2025-12-08)                                         │    │
│  │ ━━━━━━━━━━━━━━━━━━━━━━━                                            │    │
│  │ 총 자산: 10,523,000원                                               │    │
│  │ 당일 수익: +52,300원 (+0.5%)                                        │    │
│  │ ───────────────────                                                 │    │
│  │ 보유종목: 5개                                                       │    │
│  │ 매수: 2건 / 매도: 1건                                               │    │
│  │ 승률: 66.7% (2승 1패)                                               │    │
│  │ ───────────────────                                                 │    │
│  │ 📈 삼성전자 +2.3%                                                   │    │
│  │ 📈 SK하이닉스 +1.5%                                                 │    │
│  │ 📉 한국전력 -2.1%                                                   │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 5. 이벤트 발행 가이드

### 각 모듈에서 이벤트 발행

```python
# AutoTrader에서 매수 체결 시
from services.telegram import EventBus, TelegramEvent

def on_buy_executed(order_result):
    EventBus.emit(TelegramEvent(
        event_type="TRADE_BUY",
        priority="HIGH",
        data={
            "stock_code": order_result.stock_code,
            "stock_name": order_result.stock_name,
            "quantity": order_result.quantity,
            "price": order_result.price,
            "strategy": order_result.strategy,
            "ai_score": order_result.ai_score,
            "model_used": order_result.model_used,
            "reason": order_result.reason,
        }
    ))

# Scheduler에서 일일 리포트 시
def send_daily_report():
    report_data = generate_daily_report()
    EventBus.emit(TelegramEvent(
        event_type="DAILY_REPORT",
        priority="MEDIUM",
        data=report_data
    ))

# Brain에서 새 시그널 발생 시
def on_new_signal(signal):
    EventBus.emit(TelegramEvent(
        event_type="SIGNAL_NEW",
        priority="MEDIUM",
        data={
            "stock_code": signal.stock_code,
            "stock_name": signal.stock_name,
            "score": signal.score,
            "strategy": signal.strategy,
        }
    ))
```

---

## 6. 사용자 명령 (Commands)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      🎮 USER COMMANDS                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌────────────────┬──────────────────────────────────────────────────────┐  │
│  │  명령어        │  설명                                                │  │
│  ├────────────────┼──────────────────────────────────────────────────────┤  │
│  │  /status       │  시스템 상태 조회                                    │  │
│  │  /balance      │  계좌 잔고 조회                                      │  │
│  │  /portfolio    │  보유종목 조회                                       │  │
│  │  /today        │  오늘 거래 내역                                      │  │
│  │  /picks        │  오늘 추천 종목                                      │  │
│  ├────────────────┼──────────────────────────────────────────────────────┤  │
│  │  /on           │  자동매매 시작                                       │  │
│  │  /off          │  자동매매 중지                                       │  │
│  │  /pause        │  일시 중지                                           │  │
│  ├────────────────┼──────────────────────────────────────────────────────┤  │
│  │  /help         │  도움말                                              │  │
│  └────────────────┴──────────────────────────────────────────────────────┘  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 7. 알림 우선순위

| 우선순위 | 이벤트 타입 | 처리 방식 |
|---------|------------|----------|
| **HIGH** | TRADE_BUY, TRADE_SELL, STOP_LOSS, ERROR | 즉시 발송 |
| **MEDIUM** | SIGNAL_NEW, DAILY_REPORT, WARNING | 큐에 저장 후 1분 내 발송 |
| **LOW** | MARKET_OPEN, MARKET_CLOSE | 큐에 저장 후 배치 발송 |

---

## 8. 데이터 흐름

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      📊 TELEGRAM DATA FLOW                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  [이벤트 발생]                                                              │
│       │                                                                      │
│       ▼                                                                      │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐                   │
│  │  EventBus   │────►│   Watcher   │────►│   Sender    │                   │
│  │  (발행)     │     │  (포맷팅)   │     │  (전송)     │                   │
│  └─────────────┘     └─────────────┘     └─────────────┘                   │
│                             │                   │                           │
│                             ▼                   ▼                           │
│                      ┌─────────────┐     ┌─────────────┐                   │
│                      │  Templates  │     │  Telegram   │                   │
│                      │  (메시지)   │     │    API      │                   │
│                      └─────────────┘     └─────────────┘                   │
│                                                                              │
│  [사용자 명령]                                                              │
│       │                                                                      │
│       ▼                                                                      │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐                   │
│  │  Telegram   │────►│  Commands   │────►│     DB      │                   │
│  │    API      │     │  (처리)     │     │  (조회)     │                   │
│  └─────────────┘     └─────────────┘     └─────────────┘                   │
│                             │                                               │
│                             ▼                                               │
│                      ┌─────────────┐                                        │
│                      │   Sender    │                                        │
│                      │  (응답)     │                                        │
│                      └─────────────┘                                        │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 9. 구현 체크리스트

- [ ] EventBus 싱글톤 구현
- [ ] TelegramEvent 데이터 클래스 정의
- [ ] TelegramWatcher 이벤트 리스너 구현
- [ ] 메시지 템플릿 정의
- [ ] 각 모듈에서 emit() 호출로 변경
  - [ ] AutoTrader → TRADE_BUY, TRADE_SELL, STOP_LOSS
  - [ ] Scheduler → DAILY_REPORT, MARKET_OPEN/CLOSE
  - [ ] Brain → SIGNAL_NEW, SIGNAL_ALERT
- [ ] 사용자 명령 핸들러 구현
- [ ] 우선순위별 큐 처리

---

*Document maintained by AEGIS Development Team*
