# Daily Analyzer: Layer 3 ì‹¬ì¸µ ë¶„ì„

> ì‘ì„±ì¼: 2025-12-09
> ìƒíƒœ: ì™„ë£Œ âœ…
> Phase: 2 (Layer 3 ì™„ì„±)

---

## ğŸ¯ ëª©í‘œ

**DeepSeek R1**ìœ¼ë¡œ ì „ì²´ ì¢…ëª© ì‹¬ì¸µ ë¶„ì„ í›„ ìƒìœ„ 20ê°œ ì„ ì •

```
07:20 â†’ DeepSeek R1 ë¶„ì„ (2000ì¢…ëª©) â†’ ìƒìœ„ 20ê°œ â†’ daily_picks â†’ WebSocket Priority 2
```

---

## ğŸ“Š 3-Layer ëª¨ë‹ˆí„°ë§ ì™„ì„±

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 3: Daily Analyzer (07:20) âœ…                         â”‚
â”‚  - DeepSeek R1 ì „ì²´ ë¶„ì„ (2000ì¢…ëª©)                          â”‚
â”‚  - daily_picks í…Œì´ë¸” ì €ì¥                                   â”‚
â”‚  - WebSocket Priority 2 êµ¬ë…                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 2: Market Scanner (1ë¶„) âœ…                           â”‚
â”‚  - ë“±ë½ë¥ /ê±°ë˜ëŸ‰ ìƒìœ„ ìŠ¤ìº”                                    â”‚
â”‚  - gemini-2.0-flash ë¹ ë¥¸ í‰ê°€                                â”‚
â”‚  - WebSocket Priority 3 êµ¬ë…                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 1: WebSocket ì‹¤ì‹œê°„ (40 ìŠ¬ë¡¯) âœ…                     â”‚
â”‚  - Priority 1: ë³´ìœ ì¢…ëª© (10ê°œ)                               â”‚
â”‚  - Priority 2: AI Daily Picks (20ê°œ)                        â”‚
â”‚  - Priority 3: ê¸‰ë“±ì£¼ (10ê°œ)                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ§  DeepSeek R1 ë¶„ì„ í”„ë¡œì„¸ìŠ¤

### 1. ì „ì²´ í”Œë¡œìš°

```python
07:20 Daily Analyzer ì‹œì‘
   â†“
1ï¸âƒ£ ì¢…ëª© ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ (2000ì¢…ëª©)
   - ì½”ìŠ¤í”¼ + ì½”ìŠ¤ë‹¥
   - pykrx í†µí•© (TODO)
   â†“
2ï¸âƒ£ ë°°ì¹˜ ë¶„ì„ (50ê°œì”©)
   - DeepSeek R1 API í˜¸ì¶œ
   - ì¬ë¬´ì œí‘œ, ìˆ˜ê¸‰, ë‰´ìŠ¤, ê¸°ìˆ  ë¶„ì„
   - AI ì ìˆ˜ (0~100) ì‚°ì¶œ
   â†“
3ï¸âƒ£ ìƒìœ„ 20ê°œ ì„ ì •
   - AI ì ìˆ˜ ê¸°ì¤€ ì •ë ¬
   - ìƒìœ„ 20ê°œ ì¶”ì¶œ
   â†“
4ï¸âƒ£ daily_picks í…Œì´ë¸” ì €ì¥
   - ê¸°ì¡´ picks ì‚­ì œ
   - ìƒˆ picks ì €ì¥
   â†“
5ï¸âƒ£ WebSocket Manager ì—…ë°ì´íŠ¸
   - Priority 2 ìŠ¬ë¡¯ ê°±ì‹ 
   - 20ê°œ ì¢…ëª© ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ì‹œì‘
```

### 2. DeepSeek R1 ë¶„ì„ í•­ëª©

```
1. ì¬ë¬´ì œí‘œ ë¶„ì„ (30ì )
   - ë§¤ì¶œ ì„±ì¥ë¥ 
   - ì˜ì—…ì´ìµë¥ 
   - ë¶€ì±„ë¹„ìœ¨
   - ROE

2. ìˆ˜ê¸‰ ë¶„ì„ (30ì )
   - ì™¸êµ­ì¸/ê¸°ê´€ ìˆ˜ê¸‰
   - í”„ë¡œê·¸ë¨ ë§¤ë§¤ ë™í–¥
   - ê±°ë˜ëŸ‰ ì¶”ì´

3. ë‰´ìŠ¤/ê³µì‹œ ë¶„ì„ (20ì )
   - ìµœê·¼ ì¤‘ìš” ê³µì‹œ
   - ë‰´ìŠ¤ ê°ì„± ë¶„ì„
   - ì—…ì¢… ë™í–¥

4. ê¸°ìˆ ì  ë¶„ì„ (20ì )
   - ì¶”ì„¸ ë°©í–¥
   - ì§€ì§€/ì €í•­ì„ 
   - ëª¨ë©˜í…€ ì§€í‘œ

ì´ì : 100ì 
```

### 3. ì‘ë‹µ í˜•ì‹

```
AIì ìˆ˜: 85
Quantì ìˆ˜: 78
ì „ëµ: ëª¨ë©˜í…€
ì˜ˆìƒì§„ì…ê°€: 70000
ì½”ë©˜íŠ¸: ì‹¤ì  ê°œì„  ê¸°ëŒ€, ì™¸êµ­ì¸ ìˆœë§¤ìˆ˜ ì§€ì†, ë‹¨ê¸° ëª¨ë©˜í…€ ê°•í•¨
```

---

## ğŸ’¾ DB ì €ì¥ êµ¬ì¡°

### DailyPick ëª¨ë¸

```python
class DailyPick(Base):
    """ì¼ì¼ ì¶”ì²œ ì¢…ëª©"""
    __tablename__ = "daily_picks"

    id = Column(Integer, primary_key=True)
    date = Column(Date, nullable=False, index=True)  # ë‚ ì§œ
    stock_code = Column(String(20), nullable=False)  # ì¢…ëª© ì½”ë“œ

    strategy_name = Column(String(50))  # ì„ ì • ì „ëµ (DEEPSEEK_R1)
    rank = Column(Integer)              # ìš°ì„ ìˆœìœ„ (1~20)

    quant_score = Column(Integer)       # Quant ì ìˆ˜ (0~100)
    ai_score = Column(Integer)          # AI ì ìˆ˜ (0~100)
    expected_entry_price = Column(Float)  # ì˜ˆìƒ ì§„ì…ê°€

    ai_comment = Column(Text)           # AI ì½”ë©˜íŠ¸
    is_executed = Column(Boolean, default=False)  # ë§¤ìˆ˜ ì—¬ë¶€

    created_at = Column(DateTime, server_default=func.now())
```

### ì €ì¥ ë¡œì§

```python
async def _save_picks(self, picks: List[dict]) -> None:
    """daily_picks í…Œì´ë¸”ì— ì €ì¥"""

    # 1. ì˜¤ëŠ˜ ë‚ ì§œì˜ ê¸°ì¡´ picks ì‚­ì œ
    db.query(DailyPick).filter(
        DailyPick.date == date.today()
    ).delete()

    # 2. ìƒˆ picks ì €ì¥
    for rank, pick in enumerate(picks, 1):
        daily_pick = DailyPick(
            date=date.today(),
            stock_code=pick['stock_code'],
            strategy_name="DEEPSEEK_R1",
            rank=rank,
            quant_score=pick['quant_score'],
            ai_score=pick['ai_score'],
            expected_entry_price=pick['expected_entry_price'],
            ai_comment=pick['ai_comment'],
            is_executed=False
        )
        db.add(daily_pick)

    db.commit()
```

---

## ğŸ”„ WebSocket ì—°ë™

### Priority 2 ìŠ¬ë¡¯ ê°±ì‹ 

```python
async def _update_websocket_manager(self, picks: List[dict]) -> None:
    """WebSocket Managerì— daily picks ì—…ë°ì´íŠ¸"""

    # WebSocket Managerê°€ ìë™ìœ¼ë¡œ:
    # 1. ê¸°ì¡´ Priority 2 ìŠ¬ë¡¯ ì „ì²´ í•´ì œ
    # 2. ìƒˆë¡œìš´ 20ê°œ ì¢…ëª© Priority 2ë¡œ êµ¬ë…
    await ws_manager.update_daily_picks(picks)
```

### ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ì‹œì‘

```
07:20 Daily Analyzer ì™„ë£Œ
   â†“
WebSocket Manager ì—…ë°ì´íŠ¸
   â†“
Priority 2 ìŠ¬ë¡¯ 20ê°œ ê°±ì‹ 
   â†“
ì‹¤ì‹œê°„ ì²´ê²°ê°€/í˜¸ê°€ ìˆ˜ì‹  ì‹œì‘
   â†“
09:00 ì¥ ì‹œì‘ â†’ ì‹¤ì‹œê°„ ë§¤ìˆ˜ ê¸°íšŒ í¬ì°©
```

---

## ğŸ“ˆ ë°°ì¹˜ ì²˜ë¦¬ ì „ëµ

### 1. ë°°ì¹˜ ì‚¬ì´ì¦ˆ

```python
batch_size = 50  # í•œ ë²ˆì— 50ê°œì”© ë¶„ì„
total_batches = 2000 / 50 = 40ê°œ ë°°ì¹˜
```

### 2. API í˜¸ì¶œ ì œí•œ ëŒ€ì‘

```python
for batch in batches:
    # 50ê°œ ë¶„ì„
    results = await analyze_batch(batch)

    # ë”œë ˆì´ (API ì œí•œ ëŒ€ì‘)
    await asyncio.sleep(2)  # 2ì´ˆ ëŒ€ê¸°
```

### 3. ì˜ˆìƒ ì†Œìš” ì‹œê°„

```
ë°°ì¹˜ 1ê°œë‹¹: ~10ì´ˆ (DeepSeek R1 API í˜¸ì¶œ)
ì´ 40ê°œ ë°°ì¹˜: 10ì´ˆ Ã— 40 = 400ì´ˆ â‰ˆ 7ë¶„

07:20 ì‹œì‘ â†’ 07:27 ì™„ë£Œ
```

---

## ğŸ§ª í…ŒìŠ¤íŠ¸ ë°©ë²•

### 1. ë‹¨ë… ì‹¤í–‰

```python
import asyncio
from fetchers.daily_analyzer import daily_analyzer

async def test_daily_analyzer():
    picks = await daily_analyzer.analyze_all()
    print(f"Total picks: {len(picks)}")
    for i, pick in enumerate(picks, 1):
        print(f"{i}. {pick['stock_name']}: {pick['ai_score']}ì ")

asyncio.run(test_daily_analyzer())
```

### 2. ìŠ¤ì¼€ì¤„ëŸ¬ì—ì„œ ì‹¤í–‰

```python
from scheduler.dynamic_scheduler import dynamic_scheduler

# 07:20ì— ìë™ ì‹¤í–‰
dynamic_scheduler.start()

# ë˜ëŠ” ìˆ˜ë™ íŠ¸ë¦¬ê±°
await dynamic_scheduler._daily_deep_analysis()
```

### 3. DB ì¡°íšŒ

```python
from app.database import get_db
from app.models.brain import DailyPick
from datetime import date

db = next(get_db())
picks = db.query(DailyPick).filter(
    DailyPick.date == date.today()
).order_by(DailyPick.rank).all()

for pick in picks:
    print(f"{pick.rank}. {pick.stock_code}: {pick.ai_score}ì ")
```

---

## ğŸš€ ì„±ëŠ¥ ìµœì í™”

### 1. ë³‘ë ¬ ì²˜ë¦¬ (TODO)

**í˜„ì¬**: ë°°ì¹˜ ë‚´ ìˆœì°¨ ì²˜ë¦¬
**ê°œì„ **: ë°°ì¹˜ ë‚´ ë³‘ë ¬ ì²˜ë¦¬

```python
# í˜„ì¬
for stock in batch:
    result = await analyze_single_stock(stock)

# ê°œì„ 
tasks = [analyze_single_stock(stock) for stock in batch]
results = await asyncio.gather(*tasks)
```

**íš¨ê³¼**: ë°°ì¹˜ë‹¹ 10ì´ˆ â†’ 3ì´ˆ (3ë°° ë¹ ë¦„)

### 2. ìºì‹± (TODO)

**í˜„ì¬**: ë§¤ì¼ 2000ì¢…ëª© ì „ì²´ ë¶„ì„
**ê°œì„ **: ë³€í™” ì—†ëŠ” ì¢…ëª© ìºì‹œ í™œìš©

```python
# ìµœê·¼ 3ì¼ ì´ë‚´ ë¶„ì„ ê²°ê³¼ ì¬ì‚¬ìš©
# ë‹¨, ë‰´ìŠ¤/ê³µì‹œ ë°œìƒ ì‹œ ì¬ë¶„ì„
```

**íš¨ê³¼**: ë¶„ì„ ì‹œê°„ 50% ë‹¨ì¶•

### 3. ì„ ë³„ ë¶„ì„ (TODO)

**í˜„ì¬**: ì „ì²´ 2000ì¢…ëª© ë¶„ì„
**ê°œì„ **: 1ì°¨ í•„í„°ë§ í›„ ì„ ë³„ ë¶„ì„

```python
# 1ì°¨: ê±°ë˜ëŸ‰/ë“±ë½ë¥  ê¸°ì¤€ 500ê°œ ì„ ë³„
# 2ì°¨: DeepSeek R1 ì‹¬ì¸µ ë¶„ì„ (500ê°œë§Œ)
```

**íš¨ê³¼**: ë¶„ì„ ì‹œê°„ 75% ë‹¨ì¶•

---

## ğŸ”® í–¥í›„ ê°œì„  ì‚¬í•­

### 1. pykrx í†µí•© âœ… TODO

**í˜„ì¬**: ì„ì‹œ ìƒ˜í”Œ ì¢…ëª© (10ê°œ)
**ê°œì„ **: pykrxë¡œ ì „ì²´ ì¢…ëª© ì¡°íšŒ

```python
from pykrx import stock

# ì½”ìŠ¤í”¼ + ì½”ìŠ¤ë‹¥ ì „ì²´
kospi_list = stock.get_market_ticker_list("KOSPI")
kosdaq_list = stock.get_market_ticker_list("KOSDAQ")
all_stocks = kospi_list + kosdaq_list  # ~2000ê°œ
```

### 2. ì¬ë¬´ì œí‘œ ì‹¤ì œ ë°ì´í„°

**í˜„ì¬**: í”„ë¡¬í”„íŠ¸ë§Œ ì œê³µ
**ê°œì„ **: ì‹¤ì œ ì¬ë¬´ì œí‘œ ë°ì´í„° í¬í•¨

```python
# DART API ë˜ëŠ” pykrxë¡œ ì¬ë¬´ì œí‘œ ì¡°íšŒ
financial_data = get_financial_data(stock_code)

# í”„ë¡¬í”„íŠ¸ì— í¬í•¨
prompt = f"""
ì¬ë¬´ì œí‘œ:
- ë§¤ì¶œ: {financial_data['revenue']:,}ì›
- ì˜ì—…ì´ìµ: {financial_data['operating_income']:,}ì›
- ROE: {financial_data['roe']:.2f}%
"""
```

### 3. ë‰´ìŠ¤/ê³µì‹œ í†µí•©

**í˜„ì¬**: í”„ë¡¬í”„íŠ¸ë§Œ ì œê³µ
**ê°œì„ **: ì‹¤ì œ ìµœê·¼ ë‰´ìŠ¤/ê³µì‹œ í¬í•¨

```python
# Naver/DART fetcher ì—°ë™
latest_news = await naver_fetcher.get_latest_news(stock_code)
latest_disclosures = await dart_fetcher.get_disclosures(stock_code)

# í”„ë¡¬í”„íŠ¸ì— í¬í•¨
prompt += f"""
ìµœê·¼ ë‰´ìŠ¤:
{latest_news[0]['title']}

ìµœê·¼ ê³µì‹œ:
{latest_disclosures[0]['title']}
"""
```

### 4. ìˆ˜ê¸‰ ë°ì´í„° í†µí•©

**í˜„ì¬**: í”„ë¡¬í”„íŠ¸ë§Œ ì œê³µ
**ê°œì„ **: pykrx ìˆ˜ê¸‰ ë°ì´í„° í¬í•¨

```python
# pykrx ìˆ˜ê¸‰ ë°ì´í„°
from pykrx import stock
supply_demand = stock.get_market_trading_volume_by_investor(
    date.today().strftime('%Y%m%d'),
    stock_code
)

# í”„ë¡¬í”„íŠ¸ì— í¬í•¨
prompt += f"""
ì˜¤ëŠ˜ ìˆ˜ê¸‰:
- ì™¸êµ­ì¸: {supply_demand['ì™¸êµ­ì¸']:,}ì£¼
- ê¸°ê´€: {supply_demand['ê¸°ê´€']:,}ì£¼
"""
```

---

## ğŸ’¡ í•µì‹¬ ì„±ê³¼

### 1. Layer 3 ì™„ì„± âœ…

- DeepSeek R1 ì‹¬ì¸µ ë¶„ì„
- daily_picks ìë™ ìƒì„±
- WebSocket Priority 2 ìë™ ê°±ì‹ 

### 2. 3-Layer ëª¨ë‹ˆí„°ë§ ì™„ì„± âœ…

```
Layer 3 (07:20) â†’ Layer 2 (1ë¶„) â†’ Layer 1 (ì‹¤ì‹œê°„)
```

### 3. AI ê¸°ë°˜ ì¢…ëª© ì„ ì • âœ…

- ì¬ë¬´ì œí‘œ, ìˆ˜ê¸‰, ë‰´ìŠ¤, ê¸°ìˆ  ì¢…í•© ë¶„ì„
- 100ì  ë§Œì  í‰ê°€
- ìƒìœ„ 20ê°œ ìë™ ì„ ì •

### 4. í™•ì¥ ê°€ëŠ¥í•œ êµ¬ì¡° âœ…

- pykrx í†µí•© ì¤€ë¹„ ì™„ë£Œ
- DART/Naver fetcher ì—°ë™ ì¤€ë¹„
- ë°°ì¹˜ ì²˜ë¦¬ë¡œ í™•ì¥ ìš©ì´

---

## ğŸ“Š Phase 2 ì™„ë£Œ

```
Phase 2: WebSocket ìµœëŒ€ í™œìš© âœ… 100% ì™„ë£Œ

âœ… WebSocket Manager (100%)
âœ… Market Scanner (100%)
âœ… Daily Analyzer (100%)  â† ì™„ë£Œ!
```

---

**ì‘ì„±**: Claude Code
**ìƒíƒœ**: Daily Analyzer ì™„ë£Œ âœ…
**ë‹¤ìŒ**: Brain ëª¨ë“ˆ í†µí•©
